<!DOCTYPE html>
<html lang="zh-CN">

  <head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="keywords" content="" />
  <meta name="author" content="DeeTam" />
  <meta name="description" content="学然后知不足" />
  
  
  <title>
    
      微服务开发技术篇-公共配置中心 
      
      
    
  </title>

  
    <link rel="apple-touch-icon" href="/images/favicon.png">
    <link rel="icon" href="/images/favicon.png">
  

  <!-- Raleway-Font -->
  <link href="https://fonts.googleapis.com/css?family=Montserrat|Roboto:400,400italic,600|Roboto+Mono" rel="stylesheet">

  <!-- hexo site css -->
  
<link rel="stylesheet" href="/css/base.css">
<link rel="stylesheet" href="/css/common.css">
<link rel="stylesheet" href="/iconfont/iconfont.css">


  

  
    
<link rel="stylesheet" href="/css/post.css">

  

  <!-- jquery3.3.1 -->
  <script src="https://cdn.bootcss.com/jquery/3.3.1/jquery.min.js"></script>

  <!-- fancybox -->
  <link href="https://cdn.bootcss.com/fancybox/3.5.2/jquery.fancybox.min.css" rel="stylesheet">
  <script async src="https://cdn.bootcss.com/fancybox/3.5.2/jquery.fancybox.min.js"></script>
  
<script src="/js/fancybox.js"></script>


<meta name="generator" content="Hexo 6.3.0"></head>


  <body>
    <div id="app">
      <div class="header">
  <a href="/">DEE TAM</a>
</div>


      <p class="links">
  
    <a title="归档" target="" href="/archives/">
      <i class="iconfont icon-bookmark"></i>
    </a>
  
    <a title="邮箱" target="" href="mailto:oomgomgxx@gmail.com">
      <i class="iconfont icon-envelope"></i>
    </a>
  
    <a title="QQ" target="" href="tencent://message/?Menu=yes&uin=0x1DACE601&Service=300&sigT=45a1e5847943b64c6ff3990f8a9e644d2b31356cb0b4ac6b24663a3c8dd0f8aa12a595b1714f9d45">
      <i class="iconfont icon-qq"></i>
    </a>
  
    <a title="关于" target="" href="/about/">
      <i class="iconfont icon-emoji-friendly"></i>
    </a>
  
</p>


      <div class="main">
        <!-- 文章详情页，展示文章具体内容，url形式：https://yoursite/文章标题/ -->
<!-- 同时为「标签tag」，「朋友friend」，「分类categories」，「关于about」页面的承载页面，具体展示取决于page.type -->

<!-- LaTex Display -->
<script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
<script type="text/javascript" id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js">
</script>
<script>
  MathJax = {
    tex: {
      inlineMath: [['$', '$'], ['\\(', '\\)']]
    }
  };
</script>

<div class="post">
  
  <!--
  
    <h3 class="date">
    Sep 02, 2018
  </h3>
  
  -->

  
  <center>
    <h1>
      微服务开发技术篇-公共配置中心
    </h1>
  </center>
  

  <div class="content markdown-body">
    <h2 id="内容修订"><a href="#内容修订" class="headerlink" title="内容修订"></a>内容修订</h2><h2 id="基本介绍"><a href="#基本介绍" class="headerlink" title="基本介绍"></a>基本介绍</h2><blockquote>
<p>特点</p>
</blockquote>
<p><img src="/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E5%BC%80%E5%8F%91%E6%8A%80%E6%9C%AF%E7%AF%87-%E5%85%AC%E5%85%B1%E9%85%8D%E7%BD%AE%E4%B8%AD%E5%BF%83/001.png"></p>
<ul>
<li>提供集中式配置服务</li>
<li>支持配置推送</li>
<li>提供配置加密</li>
<li>支持根据环境切换配置</li>
</ul>
<blockquote>
<p>常用配置中心</p>
</blockquote>
<ul>
<li>SpringCloud Config</li>
<li>HashiCorp Consul</li>
<li>携程Apollo</li>
<li>阿里巴巴Nacos</li>
<li>ZooKeeper</li>
</ul>
<h2 id="bootstrap-yml和application-yml区别"><a href="#bootstrap-yml和application-yml区别" class="headerlink" title="bootstrap.yml和application.yml区别"></a>bootstrap.yml和application.yml区别</h2><ul>
<li>bootstrap.yml 加载顺序优先于 application.yml</li>
<li>虽然 application.yml 在 bootstrap.yml 后加载，但其配置并不能被覆盖</li>
<li>如果使用了配置中心，则配置中心的相关配置应该配置到 bootstrap.yml 中</li>
</ul>
<h2 id="SpringCloud-Config"><a href="#SpringCloud-Config" class="headerlink" title="SpringCloud Config"></a>SpringCloud Config</h2><h3 id="基本介绍-1"><a href="#基本介绍-1" class="headerlink" title="基本介绍"></a>基本介绍</h3><ul>
<li>SpringCloud Config主要分为两个角色：Config Server、Config Client</li>
<li>SpringCloud Config默认采用 Git 库来存储外部配置。除此之外还支持Subversion、FileSystem、CredHub、JDBC等外部化存储系统</li>
<li>Config Client会在微服务启动时环境初始化阶段向 Config Server 拉取配置并添加到自己的环境中</li>
<li>如果Config Client使用了注册中心，则在配置刷新时会导致自己所提供的服务短暂不可用（主动下线并重新注册）</li>
</ul>
<h3 id="快速入门"><a href="#快速入门" class="headerlink" title="快速入门"></a>快速入门</h3><h4 id="Config-Server"><a href="#Config-Server" class="headerlink" title="Config Server"></a>Config Server</h4><p>规范的做法是 Config Server 应该是一个独立的微服务</p>
<blockquote>
<p>到GitHub或者Gitlab中创建存一个用于储配置的Repository</p>
</blockquote>
<p>1）创建存储配置的库</p>
<p><img src="/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E5%BC%80%E5%8F%91%E6%8A%80%E6%9C%AF%E7%AF%87-%E5%85%AC%E5%85%B1%E9%85%8D%E7%BD%AE%E4%B8%AD%E5%BF%83/002.png"></p>
<p>2）将配置上传到Repository</p>
<p><img src="/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E5%BC%80%E5%8F%91%E6%8A%80%E6%9C%AF%E7%AF%87-%E5%85%AC%E5%85%B1%E9%85%8D%E7%BD%AE%E4%B8%AD%E5%BF%83/003.png"></p>
<p>各个文件的内容如下：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># msa-config-client-default.yml</span></span><br><span class="line"><span class="attr">info:</span></span><br><span class="line">  <span class="attr">desc:</span> <span class="string">default</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># msa-config-client-dev.yml</span></span><br><span class="line"><span class="attr">info:</span></span><br><span class="line">  <span class="attr">desc:</span> <span class="string">dev</span></span><br><span class="line">  <span class="attr">qq:</span> <span class="number">497870337</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># msa-config-client-test.yml</span></span><br><span class="line"><span class="attr">info:</span></span><br><span class="line">  <span class="attr">desc:</span> <span class="string">test</span></span><br><span class="line">  </span><br><span class="line"><span class="comment"># msa-config-client-pro.yml</span></span><br><span class="line"><span class="attr">info:</span></span><br><span class="line">  <span class="attr">desc:</span> <span class="string">pro</span></span><br></pre></td></tr></table></figure>

<p>配置文件的命名规则：</p>
<ul>
<li>格式：微服务名称（application）-环境（profile），例如msa-config-client-test.yml 中 application 就是 msa-config-client，而 profile 则是 test</li>
<li>文件类型：yaml或properties</li>
<li>注意，微服务本地配置中 spring.application.name 属性必须与公共配置文件名称中的application部分对应，否则无法拉取配置</li>
</ul>
<blockquote>
<p>实现</p>
</blockquote>
<p>依赖</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-parent<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.1.5.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">relativePath</span>/&gt;</span> <span class="comment">&lt;!-- lookup parent from repository --&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">java.version</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">java.version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">spring-cloud.version</span>&gt;</span>Greenwich.SR2<span class="tag">&lt;/<span class="name">spring-cloud.version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">dependencyManagement</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-dependencies<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;spring-cloud.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">type</span>&gt;</span>pom<span class="tag">&lt;/<span class="name">type</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>import<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencyManagement</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- SpringCloud Config Server --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-config-server<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- SpringCloud Netflix Client --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-eureka-client<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>bootstrap.yml</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 方便查看，这里暴露所有端点</span></span><br><span class="line"><span class="attr">management:</span></span><br><span class="line">  <span class="attr">endpoints:</span></span><br><span class="line">    <span class="attr">web:</span></span><br><span class="line">      <span class="attr">exposure:</span></span><br><span class="line">        <span class="attr">include:</span> <span class="string">&#x27;*&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">8808</span></span><br><span class="line"></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">msa-config-server</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">config:</span></span><br><span class="line">      <span class="attr">server:</span></span><br><span class="line">        <span class="attr">git:</span></span><br><span class="line">          <span class="attr">uri:</span> <span class="string">https://github.com/tandi960505/git-config</span></span><br><span class="line">          <span class="comment"># 只读操作无需密码</span></span><br><span class="line">          <span class="comment"># username:</span></span><br><span class="line">          <span class="comment"># password:</span></span><br><span class="line">          <span class="attr">clone-on-start:</span> <span class="literal">true</span> <span class="comment"># 指定当前服务启动时就克隆公共配置文件到本地，否则会等到有Config Client请求才克隆</span></span><br><span class="line">          <span class="attr">basedir:</span> <span class="string">C:/Users/admin/Desktop/git</span> <span class="comment"># 保存克隆库的文件夹。默认在系统的临时文件夹中</span></span><br><span class="line">          <span class="attr">refresh-rate:</span> <span class="number">300</span> <span class="comment"># 配置刷新频率。默认为0，表示接收到Client请求才刷新</span></span><br><span class="line"></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="attr">serviceUrl:</span></span><br><span class="line">      <span class="attr">defaultZone:</span> <span class="string">http://localhost:8761/eureka/</span></span><br></pre></td></tr></table></figure>

<p>启动功能</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@EnableEurekaClient</span></span><br><span class="line"><span class="meta">@EnableConfigServer</span></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MsaConfigServerApplication</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        SpringApplication.run(MsaConfigServerApplication.class, args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>测试ConfigServer</p>
<p><img src="/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E5%BC%80%E5%8F%91%E6%8A%80%E6%9C%AF%E7%AF%87-%E5%85%AC%E5%85%B1%E9%85%8D%E7%BD%AE%E4%B8%AD%E5%BF%83/004.png"></p>
<blockquote>
<p>获取配置信息的请求URI格式</p>
</blockquote>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># &#123;&#125;为必须的，[]为可选的</span></span><br><span class="line"><span class="attr">格式1：/&#123;application&#125;/&#123;profile&#125;[/&#123;label&#125;]</span></span><br><span class="line"><span class="attr">格式2：/&#123;application&#125;-&#123;profile&#125;.后缀名</span></span><br><span class="line"><span class="attr">格式3：/&#123;label&#125;/&#123;application&#125;-&#123;profile&#125;.后缀名</span></span><br></pre></td></tr></table></figure>


<h4 id="Config-Client"><a href="#Config-Client" class="headerlink" title="Config Client"></a>Config Client</h4><blockquote>
<p>实现</p>
</blockquote>
<p>依赖</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-parent<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.1.5.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">relativePath</span>/&gt;</span> <span class="comment">&lt;!-- lookup parent from repository --&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">java.version</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">java.version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">spring-cloud.version</span>&gt;</span>Greenwich.SR2<span class="tag">&lt;/<span class="name">spring-cloud.version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">dependencyManagement</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-dependencies<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;spring-cloud.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">type</span>&gt;</span>pom<span class="tag">&lt;/<span class="name">type</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>import<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencyManagement</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-config<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-eureka-client<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-actuator<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>bootstrap.yaml</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="attr">serviceUrl:</span></span><br><span class="line">      <span class="attr">defaultZone:</span> <span class="string">http://localhost:8761/eureka/</span></span><br><span class="line"></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">msa-config-client</span> </span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">config:</span></span><br><span class="line">      <span class="attr">discovery:</span></span><br><span class="line">        <span class="attr">enabled:</span> <span class="literal">true</span> <span class="comment"># 启用配置中心服务发现功能</span></span><br><span class="line">        <span class="attr">service-id:</span> <span class="string">MSA-CONFIG-SERVER</span> <span class="comment"># 注册中心上的配置中心service-id</span></span><br><span class="line">      <span class="attr">profile:</span> <span class="string">dev</span></span><br><span class="line">      <span class="attr">label:</span> <span class="string">master</span> <span class="comment"># label表示GitHub库的分支，默认为master</span></span><br><span class="line">      <span class="attr">fail-fast:</span> <span class="literal">true</span> <span class="comment"># 当获取不到Config Server配置则快速启动失败，即不希望该微服务启动</span></span><br><span class="line"></span><br><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">8809</span></span><br></pre></td></tr></table></figure>

<ul>
<li>默认情况下 Config Client 会使用 spring.application.name 来作为请求的 {application} 值</li>
<li>{application} 也可以使用 spring.cloud.config.name 来设置 （推荐）</li>
</ul>
<p>application.yml</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">management:</span></span><br><span class="line">  <span class="attr">endpoints:</span></span><br><span class="line">    <span class="attr">web:</span></span><br><span class="line">      <span class="attr">exposure:</span></span><br><span class="line">        <span class="attr">include:</span> <span class="string">&#x27;*&#x27;</span></span><br></pre></td></tr></table></figure>

<p>启用功能</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// @EnableEurekaClient </span></span><br><span class="line"><span class="comment">// 在Config Client中配置了服务发现后无需再显示配置注解。参考：DiscoveryClientConfigServiceBootstrapConfiguration</span></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MsaConfigClientApplication</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        SpringApplication.run(MsaConfigClientApplication.class, args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>特别注意，如果 Config Server 在 Config Client 之后启动，Config Client会因为初始化阶段无法获取到配置而报错。即使 Config Server 随后启动，Config Client也无法自动获取外部配置。解决方案如下：<ul>
<li>通过服务编排来设置 Config Server 和 Config Client 的启动顺序</li>
<li>手动刷新 Config Client 配置，让其重新获取外部配置（前提是 Config Server 成功启动并提供服务），而这时不能开启 fail-fast 功能</li>
</ul>
</li>
</ul>
<p>测试一下是否能获取到配置中心的配置内容</p>
<p><img src="/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E5%BC%80%E5%8F%91%E6%8A%80%E6%9C%AF%E7%AF%87-%E5%85%AC%E5%85%B1%E9%85%8D%E7%BD%AE%E4%B8%AD%E5%BF%83/006.png"></p>
<h4 id="修改外部配置"><a href="#修改外部配置" class="headerlink" title="修改外部配置"></a>修改外部配置</h4><blockquote>
<p>模拟修改外部配置，然后刷新Config Client让其获取最新版本的配置</p>
</blockquote>
<p>1）修改外部配置</p>
<p><img src="/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E5%BC%80%E5%8F%91%E6%8A%80%E6%9C%AF%E7%AF%87-%E5%85%AC%E5%85%B1%E9%85%8D%E7%BD%AE%E4%B8%AD%E5%BF%83/007.png"></p>
<p>2）没刷新配置之前，应用信息如下</p>
<p><img src="/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E5%BC%80%E5%8F%91%E6%8A%80%E6%9C%AF%E7%AF%87-%E5%85%AC%E5%85%B1%E9%85%8D%E7%BD%AE%E4%B8%AD%E5%BF%83/006.png"></p>
<p>3）手动刷新配置，Config Client会重新向Config Server拉取公共配置</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">curl -X POST http://localhost:8809/actuator/refresh</span></span><br><span class="line">[&quot;config.client.version&quot;,&quot;info.name&quot;]</span><br></pre></td></tr></table></figure>

<p><img src="/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E5%BC%80%E5%8F%91%E6%8A%80%E6%9C%AF%E7%AF%87-%E5%85%AC%E5%85%B1%E9%85%8D%E7%BD%AE%E4%B8%AD%E5%BF%83/008.png"></p>
<h3 id="源码浅析"><a href="#源码浅析" class="headerlink" title="源码浅析"></a>源码浅析</h3><h4 id="Config-Server-1"><a href="#Config-Server-1" class="headerlink" title="Config Server"></a>Config Server</h4><ul>
<li>默认情况下 SpringCloud Config 采用Git库来存储外部配置</li>
<li>SpringCloud Config 使用第三方开源类库<a target="_blank" rel="noopener" href="https://www.eclipse.org/jgit/">Eclipse JGit</a>来完成 Git 操作</li>
</ul>
<h5 id="获取Git库中的配置"><a href="#获取Git库中的配置" class="headerlink" title="获取Git库中的配置"></a>获取Git库中的配置</h5><p>ConfigServerAutoConfiguration</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@EnableConfigurationProperties(ConfigServerProperties.class)</span></span><br><span class="line"><span class="meta">@Import(&#123; EnvironmentRepositoryConfiguration.class,</span></span><br><span class="line"><span class="meta">         CompositeConfiguration.class,</span></span><br><span class="line"><span class="meta">		ResourceRepositoryConfiguration.class, ConfigServerEncryptionConfiguration.class,</span></span><br><span class="line"><span class="meta">		ConfigServerMvcConfiguration.class &#125;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ConfigServerAutoConfiguration</span> &#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>进入EnvironmentRepositoryConfiguration</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 以下是 Spring Cloud Config 支持的配置存储服务</span></span><br><span class="line"><span class="meta">@Import(&#123; CompositeRepositoryConfiguration.class, JdbcRepositoryConfiguration.class,</span></span><br><span class="line"><span class="meta">		VaultConfiguration.class, </span></span><br><span class="line"><span class="meta">         VaultRepositoryConfiguration.class,</span></span><br><span class="line"><span class="meta">		CredhubConfiguration.class,</span></span><br><span class="line"><span class="meta">         CredhubRepositoryConfiguration.class,</span></span><br><span class="line"><span class="meta">		SvnRepositoryConfiguration.class, NativeRepositoryConfiguration.class,</span></span><br><span class="line"><span class="meta">		GitRepositoryConfiguration.class, DefaultRepositoryConfiguration.class &#125;)</span> <span class="comment">// 默认库操作</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">EnvironmentRepositoryConfiguration</span> &#123;</span><br><span class="line">    <span class="comment">// 默认采用Git</span></span><br><span class="line">	<span class="meta">@Configuration</span></span><br><span class="line">	<span class="meta">@ConditionalOnMissingBean(value = EnvironmentRepository.class, search = SearchStrategy.CURRENT)</span></span><br><span class="line">	<span class="keyword">class</span> <span class="title class_">DefaultRepositoryConfiguration</span> &#123;</span><br><span class="line">		<span class="meta">@Bean</span></span><br><span class="line">		<span class="keyword">public</span> MultipleJGitEnvironmentRepository <span class="title function_">defaultEnvironmentRepository</span><span class="params">(</span></span><br><span class="line"><span class="params">			MultipleJGitEnvironmentRepositoryFactory gitEnvironmentRepositoryFactory,</span></span><br><span class="line"><span class="params">			MultipleJGitEnvironmentProperties environmentProperties)</span> <span class="keyword">throws</span> Exception &#123;	</span><br><span class="line">			<span class="keyword">return</span> gitEnvironmentRepositoryFactory.build(environmentProperties);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>MultipleJGitEnvironmentRepository</p>
<p><img src="/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E5%BC%80%E5%8F%91%E6%8A%80%E6%9C%AF%E7%AF%87-%E5%85%AC%E5%85%B1%E9%85%8D%E7%BD%AE%E4%B8%AD%E5%BF%83/009.png"></p>
<details>
    <summary>查看大图</summary>
    <pre>
        <img src="微服务开发技术篇-公共配置中心/010.png" style="zoom:80%;" />
    </pre>
</details>



<p>克隆远程库的过程</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JGitEnvironmentRepository</span> &#123;</span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title function_">afterPropertiesSet</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">		initialize();</span><br><span class="line">		<span class="comment">// 如果配置了 clone-on-start:true 则在Config Server启动后就去克隆库</span></span><br><span class="line">		<span class="keyword">if</span> (<span class="built_in">this</span>.cloneOnStart) &#123; </span><br><span class="line">			initClonedRepository();</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">initClonedRepository</span><span class="params">()</span> <span class="keyword">throws</span> GitAPIException, IOException &#123;</span><br><span class="line">		<span class="keyword">if</span> (!getUri().startsWith(FILE_URI_PREFIX)) &#123;</span><br><span class="line">			<span class="comment">// 如果本地已经存在该库，则先删除（BaseDir目录）</span></span><br><span class="line">			deleteBaseDirIfExists();</span><br><span class="line">			<span class="comment">// 克隆远程库到本地库</span></span><br><span class="line">			<span class="type">Git</span> <span class="variable">git</span> <span class="operator">=</span> cloneToBasedir();</span><br><span class="line">			<span class="comment">// ...</span></span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MultipleJGitEnvironmentRepository</span> <span class="keyword">extends</span> <span class="title class_">JGitEnvironmentRepository</span> &#123;</span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">afterPropertiesSet</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">		<span class="comment">// 调用父类的afterPropertiesSet()</span></span><br><span class="line">		<span class="built_in">super</span>.afterPropertiesSet();</span><br><span class="line">		<span class="keyword">for</span> (String name : <span class="built_in">this</span>.repos.keySet()) &#123;</span><br><span class="line">			<span class="type">PatternMatchingJGitEnvironmentRepository</span> <span class="variable">repo</span> <span class="operator">=</span> <span class="built_in">this</span>.repos.get(name);</span><br><span class="line">			repo.setEnvironment(getEnvironment());</span><br><span class="line">			<span class="comment">// ...</span></span><br><span class="line">			<span class="comment">// 设置配置数据</span></span><br><span class="line">			repo.afterPropertiesSet();</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h5 id="处理Client请求的控制器"><a href="#处理Client请求的控制器" class="headerlink" title="处理Client请求的控制器"></a>处理Client请求的控制器</h5><p>ConfigServerAutoConfiguration</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@ConditionalOnBean(ConfigServerConfiguration.Marker.class)</span></span><br><span class="line"><span class="meta">@EnableConfigurationProperties(ConfigServerProperties.class)</span></span><br><span class="line"><span class="meta">@Import(&#123; EnvironmentRepositoryConfiguration.class, CompositeConfiguration.class,</span></span><br><span class="line"><span class="meta">		ResourceRepositoryConfiguration.class, ConfigServerEncryptionConfiguration.class,</span></span><br><span class="line"><span class="meta">		ConfigServerMvcConfiguration.class &#125;)</span> <span class="comment">// 控制器配置</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ConfigServerAutoConfiguration</span> &#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ConfigServerMvcConfiguration</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@ConditionalOnWebApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ConfigServerMvcConfiguration</span> <span class="keyword">extends</span> <span class="title class_">WebMvcConfigurerAdapter</span> &#123;</span><br><span class="line">	<span class="meta">@Autowired(required = false)</span></span><br><span class="line">	<span class="keyword">private</span> EnvironmentEncryptor environmentEncryptor;</span><br><span class="line">	<span class="meta">@Autowired(required = false)</span></span><br><span class="line">	<span class="keyword">private</span> <span class="type">ObjectMapper</span> <span class="variable">objectMapper</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectMapper</span>();</span><br><span class="line">    </span><br><span class="line">	<span class="comment">// EnvironmentController</span></span><br><span class="line">	<span class="meta">@Bean</span></span><br><span class="line">	<span class="keyword">public</span> EnvironmentController <span class="title function_">environmentController</span><span class="params">(</span></span><br><span class="line"><span class="params">			EnvironmentRepository envRepository, ConfigServerProperties server)</span> &#123;</span><br><span class="line">		<span class="type">EnvironmentController</span> <span class="variable">controller</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">EnvironmentController</span>(</span><br><span class="line">				encrypted(envRepository, server), <span class="built_in">this</span>.objectMapper);</span><br><span class="line">		controller.setStripDocumentFromYaml(server.isStripDocumentFromYaml());</span><br><span class="line">		controller.setAcceptEmpty(server.isAcceptEmpty());</span><br><span class="line">		<span class="keyword">return</span> controller;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ResourceController</span></span><br><span class="line">	<span class="meta">@Bean</span></span><br><span class="line">	<span class="meta">@ConditionalOnBean(ResourceRepository.class)</span></span><br><span class="line">	<span class="keyword">public</span> ResourceController <span class="title function_">resourceController</span><span class="params">(ResourceRepository repository,</span></span><br><span class="line"><span class="params">			EnvironmentRepository envRepository, ConfigServerProperties server)</span> &#123;</span><br><span class="line">		<span class="type">ResourceController</span> <span class="variable">controller</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ResourceController</span>(repository,</span><br><span class="line">				encrypted(envRepository, server));</span><br><span class="line">		<span class="keyword">return</span> controller;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>EnvironmentController</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(method = RequestMethod.GET, path = &quot;$&#123;spring.cloud.config.server.prefix:&#125;&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">EnvironmentController</span> &#123;</span><br><span class="line">	<span class="keyword">private</span> EnvironmentRepository repository;</span><br><span class="line">	<span class="keyword">private</span> ObjectMapper objectMapper;</span><br><span class="line">	<span class="keyword">private</span> <span class="type">boolean</span> <span class="variable">stripDocument</span> <span class="operator">=</span> <span class="literal">true</span>;</span><br><span class="line">	<span class="keyword">private</span> <span class="type">boolean</span> <span class="variable">acceptEmpty</span> <span class="operator">=</span> <span class="literal">true</span>;</span><br><span class="line">	<span class="comment">// ...</span></span><br><span class="line">	<span class="meta">@RequestMapping(&quot;/&#123;name&#125;/&#123;profiles:.*[^-].*&#125;&quot;)</span></span><br><span class="line">	<span class="keyword">public</span> Environment <span class="title function_">defaultLabel</span><span class="params">(<span class="meta">@PathVariable</span> String name,</span></span><br><span class="line"><span class="params">			<span class="meta">@PathVariable</span> String profiles)</span> &#123;</span><br><span class="line">		<span class="comment">//...</span></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="meta">@RequestMapping(&quot;/&#123;name&#125;/&#123;profiles&#125;/&#123;label:.*&#125;&quot;)</span></span><br><span class="line">	<span class="keyword">public</span> Environment <span class="title function_">labelled</span><span class="params">(<span class="meta">@PathVariable</span> String name, <span class="meta">@PathVariable</span> String profiles,</span></span><br><span class="line"><span class="params">			<span class="meta">@PathVariable</span> String label)</span> &#123;</span><br><span class="line">		<span class="comment">//...</span></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="meta">@RequestMapping(&quot;/&#123;name&#125;-&#123;profiles&#125;.properties&quot;)</span></span><br><span class="line">	<span class="keyword">public</span> ResponseEntity&lt;String&gt; <span class="title function_">properties</span><span class="params">(<span class="meta">@PathVariable</span> String name,</span></span><br><span class="line"><span class="params">			<span class="meta">@PathVariable</span> String profiles,</span></span><br><span class="line"><span class="params">			<span class="meta">@RequestParam(defaultValue = &quot;true&quot;)</span> <span class="type">boolean</span> resolvePlaceholders)</span></span><br><span class="line">			<span class="keyword">throws</span> IOException &#123;</span><br><span class="line">		<span class="comment">//...</span></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="meta">@RequestMapping(&quot;/&#123;label&#125;/&#123;name&#125;-&#123;profiles&#125;.properties&quot;)</span></span><br><span class="line">	<span class="keyword">public</span> ResponseEntity&lt;String&gt; <span class="title function_">labelledProperties</span><span class="params">(<span class="meta">@PathVariable</span> String name,</span></span><br><span class="line"><span class="params">			<span class="meta">@PathVariable</span> String profiles, <span class="meta">@PathVariable</span> String label,</span></span><br><span class="line"><span class="params">			<span class="meta">@RequestParam(defaultValue = &quot;true&quot;)</span> <span class="type">boolean</span> resolvePlaceholders)</span></span><br><span class="line">			<span class="keyword">throws</span> IOException &#123;</span><br><span class="line">		<span class="comment">//...</span></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="meta">@RequestMapping(&quot;&#123;name&#125;-&#123;profiles&#125;.json&quot;)</span></span><br><span class="line">	<span class="keyword">public</span> ResponseEntity&lt;String&gt; <span class="title function_">jsonProperties</span><span class="params">(<span class="meta">@PathVariable</span> String name,</span></span><br><span class="line"><span class="params">			<span class="meta">@PathVariable</span> String profiles,</span></span><br><span class="line"><span class="params">			<span class="meta">@RequestParam(defaultValue = &quot;true&quot;)</span> <span class="type">boolean</span> resolvePlaceholders)</span></span><br><span class="line">			<span class="keyword">throws</span> Exception &#123;</span><br><span class="line">		<span class="comment">//...</span></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="meta">@RequestMapping(&quot;/&#123;label&#125;/&#123;name&#125;-&#123;profiles&#125;.json&quot;)</span></span><br><span class="line">	<span class="keyword">public</span> ResponseEntity&lt;String&gt; <span class="title function_">labelledJsonProperties</span><span class="params">(<span class="meta">@PathVariable</span> String name,</span></span><br><span class="line"><span class="params">			<span class="meta">@PathVariable</span> String profiles, <span class="meta">@PathVariable</span> String label,</span></span><br><span class="line"><span class="params">			<span class="meta">@RequestParam(defaultValue = &quot;true&quot;)</span> <span class="type">boolean</span> resolvePlaceholders)</span></span><br><span class="line">			<span class="keyword">throws</span> Exception &#123;</span><br><span class="line">		<span class="comment">//...</span></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="meta">@RequestMapping(&#123; &quot;/&#123;name&#125;-&#123;profiles&#125;.yml&quot;, &quot;/&#123;name&#125;-&#123;profiles&#125;.yaml&quot; &#125;)</span></span><br><span class="line">	<span class="keyword">public</span> ResponseEntity&lt;String&gt; <span class="title function_">yaml</span><span class="params">(<span class="meta">@PathVariable</span> String name,</span></span><br><span class="line"><span class="params">			<span class="meta">@PathVariable</span> String profiles,</span></span><br><span class="line"><span class="params">			<span class="meta">@RequestParam(defaultValue = &quot;true&quot;)</span> <span class="type">boolean</span> resolvePlaceholders)</span></span><br><span class="line">			<span class="keyword">throws</span> Exception &#123;</span><br><span class="line">		<span class="comment">//...</span></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="meta">@RequestMapping(&#123; &quot;/&#123;label&#125;/&#123;name&#125;-&#123;profiles&#125;.yml&quot;,</span></span><br><span class="line"><span class="meta">			&quot;/&#123;label&#125;/&#123;name&#125;-&#123;profiles&#125;.yaml&quot; &#125;)</span></span><br><span class="line">	<span class="keyword">public</span> ResponseEntity&lt;String&gt; <span class="title function_">labelledYaml</span><span class="params">(<span class="meta">@PathVariable</span> String name,</span></span><br><span class="line"><span class="params">			<span class="meta">@PathVariable</span> String profiles, <span class="meta">@PathVariable</span> String label,</span></span><br><span class="line"><span class="params">			<span class="meta">@RequestParam(defaultValue = &quot;true&quot;)</span> <span class="type">boolean</span> resolvePlaceholders)</span></span><br><span class="line">			<span class="keyword">throws</span> Exception &#123;</span><br><span class="line">		<span class="comment">//...</span></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="meta">@ExceptionHandler(RepositoryException.class)</span></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">noSuchLabel</span><span class="params">(HttpServletResponse response)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">		response.sendError(HttpStatus.NOT_FOUND.value());</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="meta">@ExceptionHandler(IllegalArgumentException.class)</span></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">illegalArgument</span><span class="params">(HttpServletResponse response)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">		response.sendError(HttpStatus.BAD_REQUEST.value());</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> HttpHeaders <span class="title function_">getHttpHeaders</span><span class="params">(MediaType mediaType)</span> &#123;</span><br><span class="line">		<span class="type">HttpHeaders</span> <span class="variable">httpHeaders</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HttpHeaders</span>();</span><br><span class="line">		httpHeaders.setContentType(mediaType);</span><br><span class="line">		<span class="keyword">return</span> httpHeaders;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">private</span> ResponseEntity&lt;String&gt; <span class="title function_">getSuccess</span><span class="params">(String body)</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ResponseEntity</span>&lt;&gt;(body, getHttpHeaders(MediaType.TEXT_PLAIN),</span><br><span class="line">				HttpStatus.OK);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">private</span> ResponseEntity&lt;String&gt; <span class="title function_">getSuccess</span><span class="params">(String body, MediaType mediaType)</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ResponseEntity</span>&lt;&gt;(body, getHttpHeaders(mediaType), HttpStatus.OK);</span><br><span class="line">	&#125;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ResourceController</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(method = RequestMethod.GET, path = &quot;$&#123;spring.cloud.config.server.prefix:&#125;&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ResourceController</span> &#123;</span><br><span class="line">	<span class="keyword">private</span> ResourceRepository resourceRepository;</span><br><span class="line">	<span class="keyword">private</span> EnvironmentRepository environmentRepository;</span><br><span class="line">	<span class="keyword">private</span> <span class="type">UrlPathHelper</span> <span class="variable">helper</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">UrlPathHelper</span>();</span><br><span class="line"></span><br><span class="line">	<span class="meta">@RequestMapping(&quot;/&#123;name&#125;/&#123;profile&#125;/&#123;label&#125;/**&quot;)</span></span><br><span class="line">	<span class="keyword">public</span> String <span class="title function_">retrieve</span><span class="params">(<span class="meta">@PathVariable</span> String name, <span class="meta">@PathVariable</span> String profile,</span></span><br><span class="line"><span class="params">			<span class="meta">@PathVariable</span> String label, ServletWebRequest request,</span></span><br><span class="line"><span class="params">			<span class="meta">@RequestParam(defaultValue = &quot;true&quot;)</span> <span class="type">boolean</span> resolvePlaceholders)</span></span><br><span class="line">			<span class="keyword">throws</span> IOException &#123;</span><br><span class="line">		<span class="type">String</span> <span class="variable">path</span> <span class="operator">=</span> getFilePath(request, name, profile, label);</span><br><span class="line">		<span class="keyword">return</span> retrieve(request, name, profile, label, path, resolvePlaceholders);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="meta">@RequestMapping(value = &quot;/&#123;name&#125;/&#123;profile&#125;/**&quot;, params = &quot;useDefaultLabel&quot;)</span></span><br><span class="line">	<span class="keyword">public</span> String <span class="title function_">retrieve</span><span class="params">(<span class="meta">@PathVariable</span> String name, <span class="meta">@PathVariable</span> String profile,</span></span><br><span class="line"><span class="params">			ServletWebRequest request,</span></span><br><span class="line"><span class="params">			<span class="meta">@RequestParam(defaultValue = &quot;true&quot;)</span> <span class="type">boolean</span> resolvePlaceholders)</span></span><br><span class="line">			<span class="keyword">throws</span> IOException &#123;</span><br><span class="line">		<span class="type">String</span> <span class="variable">path</span> <span class="operator">=</span> getFilePath(request, name, profile, <span class="literal">null</span>);</span><br><span class="line">		<span class="keyword">return</span> retrieve(request, name, profile, <span class="literal">null</span>, path, resolvePlaceholders);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> String <span class="title function_">getFilePath</span><span class="params">(ServletWebRequest request, String name, String profile,</span></span><br><span class="line"><span class="params">			String label)</span> &#123;</span><br><span class="line">		String stem;</span><br><span class="line">		<span class="keyword">if</span> (label != <span class="literal">null</span>) &#123;</span><br><span class="line">			stem = String.format(<span class="string">&quot;/%s/%s/%s/&quot;</span>, name, profile, label);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span> &#123;</span><br><span class="line">			stem = String.format(<span class="string">&quot;/%s/%s/&quot;</span>, name, profile);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="type">String</span> <span class="variable">path</span> <span class="operator">=</span> <span class="built_in">this</span>.helper.getPathWithinApplication(request.getRequest());</span><br><span class="line">		path = path.substring(path.indexOf(stem) + stem.length());</span><br><span class="line">		<span class="keyword">return</span> path;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@RequestMapping(value = &quot;/&#123;name&#125;/&#123;profile&#125;/&#123;label&#125;/**&quot;, produces = MediaType.APPLICATION_OCTET_STREAM_VALUE)</span></span><br><span class="line">	<span class="keyword">public</span> <span class="type">byte</span>[] binary(<span class="meta">@PathVariable</span> String name, <span class="meta">@PathVariable</span> String profile,</span><br><span class="line">			<span class="meta">@PathVariable</span> String label, ServletWebRequest request) <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">		<span class="type">String</span> <span class="variable">path</span> <span class="operator">=</span> getFilePath(request, name, profile, label);</span><br><span class="line">		<span class="keyword">return</span> binary(request, name, profile, label, path);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="meta">@RequestMapping(value = &quot;/&#123;name&#125;/&#123;profile&#125;/**&quot;, params = &quot;useDefaultLabel&quot;, produces = MediaType.APPLICATION_OCTET_STREAM_VALUE)</span></span><br><span class="line">	<span class="keyword">public</span> <span class="type">byte</span>[] binary(<span class="meta">@PathVariable</span> String name, <span class="meta">@PathVariable</span> String profile,</span><br><span class="line">			ServletWebRequest request) <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">		<span class="type">String</span> <span class="variable">path</span> <span class="operator">=</span> getFilePath(request, name, profile, <span class="literal">null</span>);</span><br><span class="line">		<span class="keyword">return</span> binary(request, name, profile, <span class="literal">null</span>, path);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// ...</span></span><br><span class="line">	<span class="meta">@ExceptionHandler(NoSuchResourceException.class)</span></span><br><span class="line">	<span class="meta">@ResponseStatus(HttpStatus.NOT_FOUND)</span></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">notFound</span><span class="params">(NoSuchResourceException e)</span> &#123;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h4 id="Config-Client-1"><a href="#Config-Client-1" class="headerlink" title="Config Client"></a>Config Client</h4><h5 id="启动时是如何获取外部配置的？"><a href="#启动时是如何获取外部配置的？" class="headerlink" title="启动时是如何获取外部配置的？"></a>启动时是如何获取外部配置的？</h5><p>ConfigServiceBootstrapConfiguration</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableConfigurationProperties</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ConfigServiceBootstrapConfiguration</span> &#123;</span><br><span class="line">	<span class="meta">@Autowired</span></span><br><span class="line">	<span class="keyword">private</span> ConfigurableEnvironment environment;</span><br><span class="line">	<span class="meta">@Bean</span></span><br><span class="line">	<span class="keyword">public</span> ConfigClientProperties <span class="title function_">configClientProperties</span><span class="params">()</span> &#123;</span><br><span class="line">		<span class="type">ConfigClientProperties</span> <span class="variable">client</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ConfigClientProperties</span>(<span class="built_in">this</span>.environment);</span><br><span class="line">		<span class="keyword">return</span> client;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 【重】：外置配置定位器</span></span><br><span class="line">	<span class="meta">@Bean</span></span><br><span class="line">	<span class="meta">@ConditionalOnMissingBean(ConfigServicePropertySourceLocator.class)</span></span><br><span class="line">	<span class="meta">@ConditionalOnProperty(value = &quot;spring.cloud.config.enabled&quot;, matchIfMissing = true)</span></span><br><span class="line">	<span class="keyword">public</span> ConfigServicePropertySourceLocator <span class="title function_">configServicePropertySource</span><span class="params">(</span></span><br><span class="line"><span class="params">			ConfigClientProperties properties)</span> &#123;</span><br><span class="line">		<span class="type">ConfigServicePropertySourceLocator</span> <span class="variable">locator</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ConfigServicePropertySourceLocator</span>(</span><br><span class="line">				properties);</span><br><span class="line">		<span class="keyword">return</span> locator;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 重试操作：需要spring retry和spring aop依赖支持</span></span><br><span class="line">	<span class="meta">@ConditionalOnProperty(&quot;spring.cloud.config.fail-fast&quot;)</span></span><br><span class="line">	<span class="meta">@ConditionalOnClass(&#123; Retryable.class, Aspect.class, AopAutoConfiguration.class &#125;)</span></span><br><span class="line">	<span class="meta">@Configuration</span></span><br><span class="line">	<span class="meta">@EnableRetry(proxyTargetClass = true)</span></span><br><span class="line">	<span class="meta">@Import(AopAutoConfiguration.class)</span></span><br><span class="line">	<span class="meta">@EnableConfigurationProperties(RetryProperties.class)</span></span><br><span class="line">	<span class="keyword">protected</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">RetryConfiguration</span> &#123;</span><br><span class="line">		<span class="meta">@Bean</span></span><br><span class="line">		<span class="meta">@ConditionalOnMissingBean(name = &quot;configServerRetryInterceptor&quot;)</span></span><br><span class="line">		<span class="keyword">public</span> RetryOperationsInterceptor <span class="title function_">configServerRetryInterceptor</span><span class="params">(</span></span><br><span class="line"><span class="params">				RetryProperties properties)</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> RetryInterceptorBuilder.stateless()</span><br><span class="line">					.backOffOptions(properties.getInitialInterval(),</span><br><span class="line">							properties.getMultiplier(), properties.getMaxInterval())</span><br><span class="line">					.maxAttempts(properties.getMaxAttempts()).build();</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ConfigServicePropertySourceLocator</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Order(0)</span> <span class="comment">// 最高优先级别(Order值越小优先级别越高)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ConfigServicePropertySourceLocator</span> <span class="keyword">implements</span> <span class="title class_">PropertySourceLocator</span> &#123;</span><br><span class="line">	<span class="keyword">private</span> RestTemplate restTemplate;</span><br><span class="line">	<span class="keyword">private</span> ConfigClientProperties defaultProperties;</span><br><span class="line">	<span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="meta">@Retryable(interceptor = &quot;configServerRetryInterceptor&quot;)</span></span><br><span class="line">	<span class="keyword">public</span> org.springframework.core.env.PropertySource&lt;?&gt; locate(</span><br><span class="line">			org.springframework.core.env.Environment environment) &#123;</span><br><span class="line"></span><br><span class="line">		<span class="type">ConfigClientProperties</span> <span class="variable">properties</span> <span class="operator">=</span> <span class="built_in">this</span>.defaultProperties.override(environment);</span><br><span class="line">		<span class="type">CompositePropertySource</span> <span class="variable">composite</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CompositePropertySource</span>(<span class="string">&quot;configService&quot;</span>);</span><br><span class="line">		<span class="type">RestTemplate</span> <span class="variable">restTemplate</span> <span class="operator">=</span> <span class="built_in">this</span>.restTemplate == <span class="literal">null</span>? getSecureRestTemplate(properties) : <span class="built_in">this</span>.restTemplate;</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			<span class="comment">// ...</span></span><br><span class="line">			<span class="keyword">for</span> (String label : labels) &#123;</span><br><span class="line">				<span class="comment">// 获取远程配置（Config Server）</span></span><br><span class="line">				<span class="type">Environment</span> <span class="variable">result</span> <span class="operator">=</span> getRemoteEnvironment(restTemplate, properties,label.trim(), state);</span><br><span class="line">				<span class="keyword">if</span> (result != <span class="literal">null</span>) &#123;</span><br><span class="line">					<span class="keyword">if</span> (result.getPropertySources() != <span class="literal">null</span>) &#123;</span><br><span class="line">						<span class="keyword">for</span> (PropertySource source : result.getPropertySources()) &#123;</span><br><span class="line">							<span class="meta">@SuppressWarnings(&quot;unchecked&quot;)</span></span><br><span class="line">							Map&lt;String, Object&gt; map = (Map&lt;String, Object&gt;) source</span><br><span class="line">									.getSource();</span><br><span class="line">							composite.addPropertySource(</span><br><span class="line">									<span class="keyword">new</span> <span class="title class_">MapPropertySource</span>(source.getName(), map));</span><br><span class="line">						&#125;</span><br><span class="line">					&#125;</span><br><span class="line"></span><br><span class="line">					<span class="keyword">if</span> (StringUtils.hasText(result.getState())</span><br><span class="line">							|| StringUtils.hasText(result.getVersion())) &#123;</span><br><span class="line">						HashMap&lt;String, Object&gt; map = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">						putValue(map, <span class="string">&quot;config.client.state&quot;</span>, result.getState());</span><br><span class="line">						putValue(map, <span class="string">&quot;config.client.version&quot;</span>, result.getVersion());</span><br><span class="line">						composite.addFirstPropertySource(<span class="keyword">new</span> <span class="title class_">MapPropertySource</span>(<span class="string">&quot;configClient&quot;</span>, map));</span><br><span class="line">					&#125;</span><br><span class="line">					<span class="comment">// 返回远程配置map(CompositePropertySource)</span></span><br><span class="line">					<span class="keyword">return</span> composite;</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">// ...</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> Environment <span class="title function_">getRemoteEnvironment</span><span class="params">(RestTemplate restTemplate,</span></span><br><span class="line"><span class="params">			ConfigClientProperties properties, String label, String state)</span> &#123;</span><br><span class="line">		<span class="comment">// 请求格式</span></span><br><span class="line">		<span class="type">String</span> <span class="variable">path</span> <span class="operator">=</span> <span class="string">&quot;/&#123;name&#125;/&#123;profile&#125;&quot;</span>;</span><br><span class="line">		<span class="type">String</span> <span class="variable">name</span> <span class="operator">=</span> properties.getName();</span><br><span class="line">		<span class="type">String</span> <span class="variable">profile</span> <span class="operator">=</span> properties.getProfile();</span><br><span class="line">		<span class="type">String</span> <span class="variable">token</span> <span class="operator">=</span> properties.getToken();</span><br><span class="line">		<span class="type">int</span> <span class="variable">noOfUrls</span> <span class="operator">=</span> properties.getUri().length;</span><br><span class="line">        </span><br><span class="line">		Object[] args = <span class="keyword">new</span> <span class="title class_">String</span>[] &#123; name, profile &#125;;</span><br><span class="line">		<span class="keyword">if</span> (StringUtils.hasText(label)) &#123;</span><br><span class="line">			<span class="keyword">if</span> (label.contains(<span class="string">&quot;/&quot;</span>)) &#123;</span><br><span class="line">				label = label.replace(<span class="string">&quot;/&quot;</span>, <span class="string">&quot;(_)&quot;</span>);</span><br><span class="line">			&#125;</span><br><span class="line">			args = <span class="keyword">new</span> <span class="title class_">String</span>[] &#123; name, profile, label &#125;;</span><br><span class="line">			path = path + <span class="string">&quot;/&#123;label&#125;&quot;</span>;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		ResponseEntity&lt;Environment&gt; response = <span class="literal">null</span>;</span><br><span class="line">		<span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; noOfUrls; i++) &#123;</span><br><span class="line">			<span class="type">Credentials</span> <span class="variable">credentials</span> <span class="operator">=</span> properties.getCredentials(i);</span><br><span class="line">			<span class="type">String</span> <span class="variable">uri</span> <span class="operator">=</span> credentials.getUri();</span><br><span class="line">			<span class="type">String</span> <span class="variable">username</span> <span class="operator">=</span> credentials.getUsername();</span><br><span class="line">			<span class="type">String</span> <span class="variable">password</span> <span class="operator">=</span> credentials.getPassword();</span><br><span class="line"></span><br><span class="line">			<span class="comment">// 构建请求头</span></span><br><span class="line">			<span class="type">HttpHeaders</span> <span class="variable">headers</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HttpHeaders</span>();</span><br><span class="line">			<span class="comment">// 添加请求权限</span></span><br><span class="line">			addAuthorizationToken(properties, headers, username, password);</span><br><span class="line">			<span class="keyword">if</span> (StringUtils.hasText(token)) &#123;</span><br><span class="line">				headers.add(TOKEN_HEADER, token);</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">if</span> (StringUtils.hasText(state) &amp;&amp; properties.isSendState()) &#123;</span><br><span class="line">				headers.add(STATE_HEADER, state);</span><br><span class="line">			&#125;</span><br><span class="line">			headers.setAccept(Collections.singletonList(MediaType.APPLICATION_JSON));</span><br><span class="line">			<span class="keyword">final</span> HttpEntity&lt;Void&gt; entity = <span class="keyword">new</span> <span class="title class_">HttpEntity</span>&lt;&gt;((Void) <span class="literal">null</span>, headers);</span><br><span class="line"></span><br><span class="line">			<span class="comment">// 发送请求</span></span><br><span class="line">			response = restTemplate.exchange(uri + path, HttpMethod.GET, entity,Environment.class, args);</span><br><span class="line">			<span class="type">Environment</span> <span class="variable">result</span> <span class="operator">=</span> response.getBody();</span><br><span class="line">			<span class="keyword">return</span> result;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">addAuthorizationToken</span><span class="params">(ConfigClientProperties configClientProperties,</span></span><br><span class="line"><span class="params">			HttpHeaders httpHeaders, String username, String password)</span> &#123;</span><br><span class="line">		<span class="type">String</span> <span class="variable">authorization</span> <span class="operator">=</span> configClientProperties.getHeaders().get(AUTHORIZATION);</span><br><span class="line">		<span class="keyword">if</span> (password != <span class="literal">null</span>) &#123;</span><br><span class="line">			<span class="type">byte</span>[] token = Base64Utils.encode((username + <span class="string">&quot;:&quot;</span> + password).getBytes());</span><br><span class="line">			httpHeaders.add(<span class="string">&quot;Authorization&quot;</span>, <span class="string">&quot;Basic &quot;</span> + <span class="keyword">new</span> <span class="title class_">String</span>(token));</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span> <span class="keyword">if</span> (authorization != <span class="literal">null</span>) &#123;</span><br><span class="line">			httpHeaders.add(<span class="string">&quot;Authorization&quot;</span>, authorization);</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="SpringBoot是如何刷新配置的？"><a href="#SpringBoot是如何刷新配置的？" class="headerlink" title="SpringBoot是如何刷新配置的？"></a>SpringBoot是如何刷新配置的？</h5><p>在快速入门中我们已经演示过Config Client使用SpringBoot Actuator提供的端点<code>/refresh</code>来实现配置刷新。以下为该端点源码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Endpoint(id = &quot;refresh&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RefreshEndpoint</span> &#123;</span><br><span class="line">    <span class="comment">// 上下文刷新器</span></span><br><span class="line">	<span class="keyword">private</span> ContextRefresher contextRefresher;</span><br><span class="line">	<span class="keyword">public</span> <span class="title function_">RefreshEndpoint</span><span class="params">(ContextRefresher contextRefresher)</span> &#123;</span><br><span class="line">		<span class="built_in">this</span>.contextRefresher = contextRefresher;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@WriteOperation</span></span><br><span class="line">	<span class="keyword">public</span> Collection&lt;String&gt; <span class="title function_">refresh</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// 刷新配置操作</span></span><br><span class="line">		Set&lt;String&gt; keys = <span class="built_in">this</span>.contextRefresher.refresh();</span><br><span class="line">		<span class="keyword">return</span> keys;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>可以看到，当请求 <code>/refresh</code>端点后，实质是使用ContextRefresher</li>
</ul>
<p>refresh端点的自动配置类RefreshEndpointAutoConfiguration</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@AutoConfigureAfter(&#123; LifecycleMvcEndpointAutoConfiguration.class,</span></span><br><span class="line"><span class="meta">                     RefreshAutoConfiguration.class &#125;)</span> </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RefreshEndpointAutoConfiguration</span> &#123;</span><br><span class="line">	<span class="comment">//...</span></span><br><span class="line">	<span class="meta">@Configuration</span></span><br><span class="line">	<span class="meta">@ConditionalOnBean(PropertySourceBootstrapConfiguration.class)</span></span><br><span class="line">	<span class="keyword">protected</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">RefreshEndpointConfiguration</span> &#123;	</span><br><span class="line">		<span class="meta">@Bean</span></span><br><span class="line">		<span class="meta">@ConditionalOnBean(ContextRefresher.class)</span></span><br><span class="line">		<span class="meta">@ConditionalOnEnabledEndpoint</span></span><br><span class="line">		<span class="meta">@ConditionalOnMissingBean</span></span><br><span class="line">		<span class="keyword">public</span> RefreshEndpoint <span class="title function_">refreshEndpoint</span><span class="params">(ContextRefresher contextRefresher)</span> &#123;</span><br><span class="line">            <span class="comment">// 使用上下文刷新器ContextRefresher构建一个Refresh端点</span></span><br><span class="line">            <span class="comment">// ContextRefresher在RefreshAutoConfiguration中被添加到容器</span></span><br><span class="line">			<span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">RefreshEndpoint</span>(contextRefresher);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>RefreshAutoConfiguration</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@ConditionalOnClass(RefreshScope.class)</span> </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RefreshAutoConfiguration</span> &#123;</span><br><span class="line">    <span class="comment">// 能够刷新配置的Bean所在的socpe必须为refresh</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">REFRESH_SCOPE_NAME</span> <span class="operator">=</span> <span class="string">&quot;refresh&quot;</span>;</span><br><span class="line">    </span><br><span class="line">	<span class="comment">// RefreshScope：负责被@Scope(&#x27;refresh&#x27;)注解所标注的Bean的刷新工作</span></span><br><span class="line">	<span class="meta">@Bean</span></span><br><span class="line">	<span class="meta">@ConditionalOnMissingBean(RefreshScope.class)</span></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> RefreshScope <span class="title function_">refreshScope</span><span class="params">()</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">RefreshScope</span>();</span><br><span class="line">	&#125;</span><br><span class="line">    </span><br><span class="line">	<span class="comment">// ContextRefresher：负责刷新上下文配置，发送刷新事件</span></span><br><span class="line">	<span class="meta">@Bean</span></span><br><span class="line">	<span class="meta">@ConditionalOnMissingBean</span></span><br><span class="line">	<span class="keyword">public</span> ContextRefresher <span class="title function_">contextRefresher</span><span class="params">(ConfigurableApplicationContext context,</span></span><br><span class="line"><span class="params">			RefreshScope scope)</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ContextRefresher</span>(context, scope);</span><br><span class="line">	&#125;</span><br><span class="line">    </span><br><span class="line">	<span class="comment">// Refresh事件监听者</span></span><br><span class="line">	<span class="meta">@Bean</span></span><br><span class="line">	<span class="keyword">public</span> RefreshEventListener <span class="title function_">refreshEventListener</span><span class="params">(ContextRefresher contextRefresher)</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">RefreshEventListener</span>(contextRefresher);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>@RefreshScope（@Scope(‘refresh’)） 是 spring-cloud-context 注册的域</li>
<li>注意，如果使用了服务注册发现，那么当发生刷新操作时 RefreshScope 会使用 ApplicationContext 发布一个 RefreshScopeRefreshedEvent 事件，而 EurekaClientConfigurationRefresher 就是监听者之一。EurekaClientConfigurationRefresher 会先将当前服务在注册中心下线，然后再上线。这样做的用意是刷新服务注册中心中当前服务的元信息。除此之外你还应该意识到这个动作会导致服务短暂处于不可用状态</li>
</ul>
<p>现在我们已经知道刷新操作实质是通过 ContextRefresher.refresh() 完成的，亦了解了 RefreshScope 负责 @RefreshScope Bean的刷新工作。</p>
<p>那么我们进入 ContextRefresher 观察一下。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ContextRefresher</span> &#123;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">REFRESH_ARGS_PROPERTY_SOURCE</span> <span class="operator">=</span> <span class="string">&quot;refreshArgs&quot;</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 默认配置源</span></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String[] DEFAULT_PROPERTY_SOURCES = <span class="keyword">new</span> <span class="title class_">String</span>[] &#123;</span><br><span class="line">			CommandLinePropertySource.COMMAND_LINE_PROPERTY_SOURCE_NAME, <span class="comment">// commandLineArgs</span></span><br><span class="line">			<span class="string">&quot;defaultProperties&quot;</span> &#125;;</span><br><span class="line">	<span class="comment">// 标准配置源</span></span><br><span class="line">	<span class="keyword">private</span> Set&lt;String&gt; standardSources = <span class="keyword">new</span> <span class="title class_">HashSet</span>&lt;&gt;(</span><br><span class="line">			Arrays.asList(StandardEnvironment.SYSTEM_PROPERTIES_PROPERTY_SOURCE_NAME, <span class="comment">// systemProperties</span></span><br><span class="line">					StandardEnvironment.SYSTEM_ENVIRONMENT_PROPERTY_SOURCE_NAME, <span class="comment">// systemEnvironment</span></span><br><span class="line">					StandardServletEnvironment.JNDI_PROPERTY_SOURCE_NAME, <span class="comment">// jndiProperties</span></span><br><span class="line">					StandardServletEnvironment.SERVLET_CONFIG_PROPERTY_SOURCE_NAME, <span class="comment">// servletConfigInitParams</span></span><br><span class="line">					StandardServletEnvironment.SERVLET_CONTEXT_PROPERTY_SOURCE_NAME, <span class="comment">// servletContextInitParams</span></span><br><span class="line">					<span class="string">&quot;configurationProperties&quot;</span>));</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> ConfigurableApplicationContext context;</span><br><span class="line">	<span class="keyword">private</span> RefreshScope scope;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="title function_">ContextRefresher</span><span class="params">(ConfigurableApplicationContext context, RefreshScope scope)</span> &#123;</span><br><span class="line">		<span class="built_in">this</span>.context = context;</span><br><span class="line">		<span class="built_in">this</span>.scope = scope;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 【重】刷新环境配置</span></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">synchronized</span> Set&lt;String&gt; <span class="title function_">refresh</span><span class="params">()</span> &#123;</span><br><span class="line">		<span class="comment">// 刷新环境，并返回改动配置</span></span><br><span class="line">		Set&lt;String&gt; keys = refreshEnvironment();</span><br><span class="line">		<span class="comment">// 清除上下文对refresh bean的缓存</span></span><br><span class="line">		<span class="comment">// 这里的上下文指的是StandardScopeCache和ThreadLocalScopeCache</span></span><br><span class="line">		<span class="built_in">this</span>.scope.refreshAll();</span><br><span class="line">		<span class="keyword">return</span> keys;</span><br><span class="line">	&#125;</span><br><span class="line">    </span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">synchronized</span> Set&lt;String&gt; <span class="title function_">refreshEnvironment</span><span class="params">()</span> &#123;</span><br><span class="line">		<span class="comment">// 刷新前的配置</span></span><br><span class="line">		Map&lt;String, Object&gt; before = extract(<span class="built_in">this</span>.context.getEnvironment().getPropertySources());</span><br><span class="line">		<span class="comment">// 【重】刷新配置核心操作</span></span><br><span class="line">		addConfigFilesToEnvironment();</span><br><span class="line">		<span class="comment">// 刷新后的配置（只有新增或新修改的配置）</span></span><br><span class="line">		Set&lt;String&gt; keys = changes(before,extract(<span class="built_in">this</span>.context.getEnvironment().getPropertySources())).keySet();</span><br><span class="line">		<span class="comment">// 在当前上下文中发布一个环境修改事件</span></span><br><span class="line">		<span class="built_in">this</span>.context.publishEvent(<span class="keyword">new</span> <span class="title class_">EnvironmentChangeEvent</span>(<span class="built_in">this</span>.context, keys));</span><br><span class="line">		<span class="keyword">return</span> keys;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	ConfigurableApplicationContext <span class="title function_">addConfigFilesToEnvironment</span><span class="params">()</span> &#123;</span><br><span class="line">		<span class="type">ConfigurableApplicationContext</span> <span class="variable">capture</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			<span class="comment">// 获取当前环境（只包含DEFAULT_PROPERTY_SOURCES）</span></span><br><span class="line">			<span class="type">StandardEnvironment</span> <span class="variable">environment</span> <span class="operator">=</span> copyEnvironment(<span class="built_in">this</span>.context.getEnvironment());</span><br><span class="line"></span><br><span class="line">			<span class="comment">/**** 刷新配置的核心思想:创建一个新的SpringBoot来重新加载新配置 ****/</span></span><br><span class="line"></span><br><span class="line">			<span class="comment">// 获取一个SpringBoot应用构建者</span></span><br><span class="line">			<span class="type">SpringApplicationBuilder</span> <span class="variable">builder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SpringApplicationBuilder</span>(Empty.class)</span><br><span class="line">					.bannerMode(Mode.OFF) <span class="comment">// 不打印Banner</span></span><br><span class="line">					.web(WebApplicationType.NONE) <span class="comment">// 不是一个Web应用，即无需启动Web容器</span></span><br><span class="line">					.environment(environment); <span class="comment">// 当前环境（只包含DEFAULT_PROPERTY_SOURCES）作为参数</span></span><br><span class="line">			builder.application().setListeners(Arrays.asList(<span class="keyword">new</span> <span class="title class_">BootstrapApplicationListener</span>(),</span><br><span class="line">							<span class="keyword">new</span> <span class="title class_">ConfigFileApplicationListener</span>()));</span><br><span class="line">			<span class="comment">// 启动SpringBoot</span></span><br><span class="line">			capture = builder.run(); </span><br><span class="line"></span><br><span class="line">			<span class="keyword">if</span> (environment.getPropertySources().contains(REFRESH_ARGS_PROPERTY_SOURCE)) &#123;</span><br><span class="line">				environment.getPropertySources().remove(REFRESH_ARGS_PROPERTY_SOURCE);</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			<span class="comment">// 当前程序所处的环境（主环境）</span></span><br><span class="line">			<span class="type">MutablePropertySources</span> <span class="variable">target</span> <span class="operator">=</span> <span class="built_in">this</span>.context.getEnvironment().getPropertySources();</span><br><span class="line">			<span class="type">String</span> <span class="variable">targetName</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">            </span><br><span class="line">			<span class="comment">// 将SpringBoot加载到的内容添加到主环境</span></span><br><span class="line">			<span class="keyword">for</span> (PropertySource&lt;?&gt; source : environment.getPropertySources()) &#123;</span><br><span class="line">				<span class="type">String</span> <span class="variable">name</span> <span class="operator">=</span> source.getName();</span><br><span class="line">				<span class="keyword">if</span> (target.contains(name)) &#123;</span><br><span class="line">					targetName = name;</span><br><span class="line">				&#125;</span><br><span class="line">				<span class="keyword">if</span> (!<span class="built_in">this</span>.standardSources.contains(name)) &#123;</span><br><span class="line">                    <span class="comment">// 如果主环境中已经存在该配置项，则将其替换</span></span><br><span class="line">					<span class="keyword">if</span> (target.contains(name)) &#123;						</span><br><span class="line">						target.replace(name, source);</span><br><span class="line">					&#125;</span><br><span class="line">					<span class="comment">// 如果主环境中没有该配置项，则添加</span></span><br><span class="line">					<span class="keyword">else</span> &#123;</span><br><span class="line">						<span class="keyword">if</span> (targetName != <span class="literal">null</span>) &#123;</span><br><span class="line">							target.addAfter(targetName, source);</span><br><span class="line">						&#125;</span><br><span class="line">						<span class="keyword">else</span> &#123;</span><br><span class="line">							target.addFirst(source);</span><br><span class="line">							targetName = name;</span><br><span class="line">						&#125;</span><br><span class="line">					&#125;</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> capture;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>RefreshScope#refreshAll</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 大概意思是处理当前范围的Bean，让其下次操作时达到刷新的效果</span></span><br><span class="line"><span class="meta">@ManagedOperation(description = &quot;Dispose of the current instance of all beans in this scope and force a refresh on next method execution.&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">refreshAll</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="built_in">super</span>.destroy(); <span class="comment">// 清除ScopeCache</span></span><br><span class="line">    <span class="comment">// 发布刷新域已成功刷新的事件，以广播给监听者做对应处理</span></span><br><span class="line">    <span class="built_in">this</span>.context.publishEvent(<span class="keyword">new</span> <span class="title class_">RefreshScopeRefreshedEvent</span>());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>ScopeCache的意义在于当前操作上下文。例如用户正在操作系统，但在这期间刷新了配置，那么通过清除上下文的ScopeCache，那么在用户在下一个操作时就能获取到新配置</li>
<li>关于ScopeCache可以参考：org.springframework.cloud.context.scope.GenericScope</li>
</ul>
<p>RefreshScopeRefreshedEvent 的监听者 EurekaClientConfigurationRefresher</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@ConditionalOnClass(RefreshScopeRefreshedEvent.class)</span></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">EurekaClientConfigurationRefresher</span></span><br><span class="line">		<span class="keyword">implements</span> <span class="title class_">ApplicationListener</span>&lt;RefreshScopeRefreshedEvent&gt; &#123;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Autowired(required = false)</span></span><br><span class="line">	<span class="keyword">private</span> EurekaClient eurekaClient;</span><br><span class="line">	<span class="meta">@Autowired(required = false)</span></span><br><span class="line">	<span class="keyword">private</span> EurekaAutoServiceRegistration autoRegistration;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onApplicationEvent</span><span class="params">(RefreshScopeRefreshedEvent event)</span> &#123;</span><br><span class="line">		<span class="comment">// 如果还没有创建EurekaClient，则将强制创建</span></span><br><span class="line">		<span class="comment">// 以确保刷新事件后顺利重新注册客户端</span></span><br><span class="line">		<span class="keyword">if</span> (eurekaClient != <span class="literal">null</span>) </span><br><span class="line">			eurekaClient.getApplications();</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> (autoRegistration != <span class="literal">null</span>) &#123;</span><br><span class="line">			<span class="comment">// 从注册中心下线服务</span></span><br><span class="line">			<span class="built_in">this</span>.autoRegistration.stop();</span><br><span class="line">			<span class="comment">// 注册服务到注册中心</span></span><br><span class="line">			<span class="built_in">this</span>.autoRegistration.start();</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>重新注册服务的意义在于，预防当前 Discovery Client 注册在注册中心的元数据被更改了</li>
</ul>
<p>总结：</p>
<ul>
<li>如果一个 Bean 依赖实时的环境配置，那么应该使用 <code>@Scope(&#39;refresh&#39;)</code> 或  <code>@RefreshScope</code> 标注，只有这样 Bean 才可以感知到配置刷新操作。原因是 SpringCloud 会将被 @RefreshScope 标注的 Bean 打包成 BeanLifecycleWrapper 存放到 ScopeCache 中（ConcurrentHashMap）作为当前操作上限文使用的Bean，当刷新操作触发时就会将 ScopeCache 的内容删除，这样一来下次使用Bean时就会重新打包 BeanLifecycleWrapper ，这样就达到了配置刷新效果</li>
<li>@RefreshScope 不一定使用配合中心才可以使用，例如有手动修改配置的需求，也是可以使用端点来刷的</li>
<li>如果想手动实现刷新，则可以参考 RefreshEndpoint 使用 ContextRefresher 来实现</li>
</ul>
<h3 id="其他功能"><a href="#其他功能" class="headerlink" title="其他功能"></a>其他功能</h3><h4 id="单库多文件夹配置"><a href="#单库多文件夹配置" class="headerlink" title="单库多文件夹配置"></a>单库多文件夹配置</h4><p>bootstrap.yaml</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">msa-config-server</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">config:</span></span><br><span class="line">      <span class="attr">server:</span></span><br><span class="line">        <span class="attr">git:</span></span><br><span class="line">          <span class="attr">uri:</span> <span class="string">https://github.com/tandi960505/git-config</span></span><br><span class="line">          <span class="attr">basedir:</span> <span class="string">C:/Users/admin/Desktop/git</span></span><br><span class="line">          <span class="attr">search-paths:</span> <span class="string">&#x27;&#123;application&#125;&#x27;</span></span><br><span class="line">          <span class="comment"># 在git-config库下找对应的&#123;application&#125;文件夹</span></span><br></pre></td></tr></table></figure>

<ul>
<li>原来：1个应用 &lt;—&gt; 1个库</li>
<li>现在：n个应用 &lt;—&gt; 1个库n个文件夹</li>
<li>{application} 是 Config Client 的 spring.cloud.config.name(优先) 或 spring.application.name</li>
<li>查找规则：先从 &#x2F;git-config&#x2F;{application} 查找，在到 &#x2F;git-config查找</li>
</ul>
<p>详细文档： <a target="_blank" rel="noopener" href="https://cloud.spring.io/spring-cloud-config/2.1.x/single/spring-cloud-config.html#_placeholders_in_git_uri">https://cloud.spring.io/spring-cloud-config/2.1.x/single/spring-cloud-config.html#_placeholders_in_git_uri</a> </p>
<h4 id="在服务端添加认证功能"><a href="#在服务端添加认证功能" class="headerlink" title="在服务端添加认证功能"></a>在服务端添加认证功能</h4><blockquote>
<p> 服务端</p>
</blockquote>
<p>依赖</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-security<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>配置</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">security:</span></span><br><span class="line">    <span class="attr">user:</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">admin</span></span><br><span class="line">      <span class="attr">password:</span> <span class="string">admin</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>客户端</p>
</blockquote>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">msa-config-client</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">config:</span></span><br><span class="line">      <span class="attr">discovery:</span></span><br><span class="line">        <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">        <span class="attr">service-id:</span> <span class="string">MSA-CONFIG-SERVER</span></span><br><span class="line">      <span class="attr">profile:</span> <span class="string">dev</span></span><br><span class="line">      <span class="attr">label:</span> <span class="string">master</span> </span><br><span class="line">      <span class="comment"># 访问Config Server的账号</span></span><br><span class="line">      <span class="attr">username:</span> <span class="string">admin</span></span><br><span class="line">      <span class="attr">password:</span> <span class="string">admin</span></span><br></pre></td></tr></table></figure>



<h4 id="对配置进行非对称加密"><a href="#对配置进行非对称加密" class="headerlink" title="对配置进行非对称加密"></a>对配置进行非对称加密</h4><p>&amp;emsp;&amp;emsp;目前库中的配置都是明文编写的，但有时候我们并不希望这样。譬如一些敏感的配置（账号密码）我们不太想让其他共用该Git库环境的人看到。在SpringCloud Config中提供了 对称加密 和 非对称加密两种操作，以下例子为 非对称加密。详细参考文档： <a target="_blank" rel="noopener" href="https://cloud.spring.io/spring-cloud-config/2.1.x/single/spring-cloud-config.html#_placeholders_in_git_uri">https://cloud.spring.io/spring-cloud-config/2.1.x/single/spring-cloud-config.html#_placeholders_in_git_uri</a> </p>
<blockquote>
<p>步骤1：使用JDK的keystore生成加密文件</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">keytool -genkeypair -alias mytestkey -keyalg RSA -keypass helloo -keystore server.jks -storepass 123456</span><br></pre></td></tr></table></figure>

<ul>
<li>alias：别名</li>
<li>keyalg：算法</li>
<li>keypass：secret（盐）</li>
<li>keystore：生成的秘钥文件</li>
<li>storepass：访问秘钥文件的密码</li>
</ul>
<blockquote>
<p>步骤2：配置Config Server</p>
</blockquote>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">encrypt:</span></span><br><span class="line">  <span class="attr">key-store:</span></span><br><span class="line">  	<span class="comment"># 将文件保存到classpath下</span></span><br><span class="line">    <span class="attr">location:</span> <span class="string">server.jks</span></span><br><span class="line">    <span class="attr">password:</span> <span class="number">123456</span></span><br><span class="line">    <span class="attr">secret:</span> <span class="string">helloo</span></span><br><span class="line">    <span class="attr">alias:</span> <span class="string">mytestkey</span></span><br></pre></td></tr></table></figure>

<ul>
<li>重启服务</li>
</ul>
<blockquote>
<p>步骤3：将需要加密的内容加密</p>
</blockquote>
<p>可以先用  <a target="_blank" rel="noopener" href="http://localhost:8808/encrypt/status">http://localhost:8808/encrypt/status</a>  测试是否成功开启encrypt功能</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">加密</span></span><br><span class="line">curl http://localhost:8808/encrypt -d 明文</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">解密</span></span><br><span class="line">curl http://localhost:8808/decrypt -d 密文</span><br></pre></td></tr></table></figure>

<p>现在我打算将配置库中 msa-config-client-dev 中的 info.qq &#x3D; 497870337 的qq号进行加密</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl http://localhost:8808/encrypt -d 497870337 &gt; msa.txt</span><br></pre></td></tr></table></figure>

<p>获取到以下密文</p>
<figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">AQBWAQHzxe+UPuox+EFn6YBv7nc2wgYEXc2V1o4C6ATYYrzjuJKK6+z/Dea9TNe1OBsxF9mmjjrL9SLYUOi8axAZewtPmD8YVuKXqExHrArslNeDsGcbMiU7dGfL8VO4bpbg9uy22NBTT2E21YKnHSC0PCjW29RAkTNWwdPsmF+aXM9bW4TpALoe21FDZNaTsC64f3m6QWPqxmDETnvuks8VG3seSuTDbaNbPsRGX8Ohu/Spb6Zy881BqFjHjXYOV0d5aWE/eMDOdotxtIgSj+jRH/BwrYDDmHbPMuTxg4ZQT5Gw0xjRZ1yOZGF5ggG4AWvsSP7BIZUUE2MTLn7Wv5Ses1HvQVjj1t+8hSjB6dV5vIy0a/J9PNXEUC5+DpHg/VM=</span><br></pre></td></tr></table></figure>

<blockquote>
<p>步骤4：将配置库中的明文替换成密文</p>
</blockquote>
<p><img src="/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E5%BC%80%E5%8F%91%E6%8A%80%E6%9C%AF%E7%AF%87-%E5%85%AC%E5%85%B1%E9%85%8D%E7%BD%AE%E4%B8%AD%E5%BF%83/011.png"></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">info:</span></span><br><span class="line">  <span class="attr">desc:</span> <span class="string">dev</span></span><br><span class="line">  <span class="comment"># 注意，需要用添加加密前缀&#123;cipher&#125;并使用&#x27;&#x27;包裹，否则解析异常</span></span><br><span class="line">  <span class="attr">qq:</span> <span class="string">&#x27;&#123;cipher&#125;AQBWAQHzxe+UPuox+EFn6YBv7nc2wgYEXc2V1o4C6ATYYrzjuJKK6+z/Dea9TNe1OBsxF9mmjjrL9SLYUOi8axAZewtPmD8YVuKXqExHrArslNeDsGcbMiU7dGfL8VO4bpbg9uy22NBTT2E21YKnHSC0PCjW29RAkTNWwdPsmF+aXM9bW4TpALoe21FDZNaTsC64f3m6QWPqxmDETnvuks8VG3seSuTDbaNbPsRGX8Ohu/Spb6Zy881BqFjHjXYOV0d5aWE/eMDOdotxtIgSj+jRH/BwrYDDmHbPMuTxg4ZQT5Gw0xjRZ1yOZGF5ggG4AWvsSP7BIZUUE2MTLn7Wv5Ses1HvQVjj1t+8hSjB6dV5vIy0a/J9PNXEUC5+DpHg/VM=&#x27;</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>访问测试</p>
</blockquote>
<p><img src="/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E5%BC%80%E5%8F%91%E6%8A%80%E6%9C%AF%E7%AF%87-%E5%85%AC%E5%85%B1%E9%85%8D%E7%BD%AE%E4%B8%AD%E5%BF%83/012.png"></p>
<ul>
<li>可以看到，当Config Server获取到配置库的配置后会对其进行解密</li>
</ul>
<h4 id="客户端重试获取配置"><a href="#客户端重试获取配置" class="headerlink" title="客户端重试获取配置"></a>客户端重试获取配置</h4><blockquote>
<p>添加依赖</p>
</blockquote>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.retry<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-retry<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-aop<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>配置</p>
</blockquote>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">msa-config-client</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">config:</span></span><br><span class="line">      <span class="attr">retry:</span></span><br><span class="line">        <span class="attr">initial-interval:</span> <span class="number">1000</span></span><br><span class="line">        <span class="attr">max-interval:</span> <span class="number">2000</span></span><br><span class="line">        <span class="attr">max-attempts:</span> <span class="number">5</span></span><br><span class="line">      <span class="attr">discovery:</span></span><br><span class="line">        <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">        <span class="attr">service-id:</span> <span class="string">MSA-CONFIG-SERVER</span></span><br><span class="line">      <span class="attr">profile:</span> <span class="string">dev</span></span><br><span class="line">      <span class="attr">label:</span> <span class="string">master</span></span><br></pre></td></tr></table></figure>



<h2 id="使用Consul做配置中心"><a href="#使用Consul做配置中心" class="headerlink" title="使用Consul做配置中心"></a>使用Consul做配置中心</h2><h3 id="快速入门-1"><a href="#快速入门-1" class="headerlink" title="快速入门"></a>快速入门</h3><p>依赖</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-parent<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.1.5.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">relativePath</span>/&gt;</span> <span class="comment">&lt;!-- lookup parent from repository --&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">java.version</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">java.version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">spring-cloud.version</span>&gt;</span>Greenwich.SR2<span class="tag">&lt;/<span class="name">spring-cloud.version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">dependencyManagement</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-dependencies<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;spring-cloud.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">type</span>&gt;</span>pom<span class="tag">&lt;/<span class="name">type</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>import<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencyManagement</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-actuator<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- consul配置中心 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-consul-config<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- consul服务注册发现 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-consul-discovery<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>bootstrap.yml</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">msa-consul-config</span></span><br><span class="line">  <span class="attr">profiles:</span></span><br><span class="line">    <span class="attr">active:</span> <span class="string">dev</span> <span class="comment"># 启动dev环境</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">consul:</span></span><br><span class="line">      <span class="attr">host:</span> <span class="string">localhost</span></span><br><span class="line">      <span class="attr">port:</span> <span class="number">8500</span></span><br><span class="line">      <span class="attr">discovery:</span></span><br><span class="line">        <span class="attr">register:</span> <span class="literal">true</span></span><br><span class="line">      <span class="attr">config:</span></span><br><span class="line">        <span class="comment"># 默认</span></span><br><span class="line">        <span class="comment"># config/application,dev/data -&gt; yaml</span></span><br><span class="line">        <span class="comment"># config/application,pro/data -&gt; yaml</span></span><br><span class="line">        <span class="comment"># prefix: config</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># 定制</span></span><br><span class="line">        <span class="comment"># 服务名称/application,dev/data -&gt; yaml</span></span><br><span class="line">        <span class="comment"># msa-consul-config/application,dev/data -&gt; yaml</span></span><br><span class="line">        <span class="attr">prefix:</span> <span class="string">msa-consul-config</span></span><br><span class="line">        <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">        <span class="attr">format:</span> <span class="string">YAML</span></span><br><span class="line">        <span class="attr">data-key:</span> <span class="string">data</span> <span class="comment"># 默认data值，对应着consul中的key叫data</span></span><br><span class="line">        <span class="attr">watch:</span></span><br><span class="line">          <span class="attr">delay:</span> <span class="number">5000</span></span><br><span class="line"></span><br><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">8080</span></span><br><span class="line"></span><br><span class="line"><span class="attr">management:</span></span><br><span class="line">  <span class="attr">endpoints:</span></span><br><span class="line">    <span class="attr">web:</span></span><br><span class="line">      <span class="attr">exposure:</span></span><br><span class="line">        <span class="attr">include:</span> <span class="string">&#x27;*&#x27;</span></span><br></pre></td></tr></table></figure>



<p>在Consul中创建对应的键值对</p>
<img src="微服务开发技术篇-公共配置中心/013.png" style="zoom: 67%;" />

<img src="微服务开发技术篇-公共配置中心/014.png" style="zoom:67%;" />

<img src="微服务开发技术篇-公共配置中心/015.png" style="zoom:67%;" />

<p>启动功能</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@EnableDiscoveryClient</span></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MsaConsulConfigApplication</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        SpringApplication.run(MsaConsulConfigApplication.class, args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>测试</p>
<p><img src="/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E5%BC%80%E5%8F%91%E6%8A%80%E6%9C%AF%E7%AF%87-%E5%85%AC%E5%85%B1%E9%85%8D%E7%BD%AE%E4%B8%AD%E5%BF%83/016.png"></p>
<h3 id="是如何实现自动刷新配置的？"><a href="#是如何实现自动刷新配置的？" class="headerlink" title="是如何实现自动刷新配置的？"></a>是如何实现自动刷新配置的？</h3><p>如果想要开启自动刷新，需要设置如下属性</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">msa-consul-config</span></span><br><span class="line">  <span class="attr">profiles:</span></span><br><span class="line">    <span class="attr">active:</span> <span class="string">dev</span> <span class="comment"># 启动dev环境</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">consul:</span></span><br><span class="line">      <span class="attr">host:</span> <span class="string">localhost</span></span><br><span class="line">      <span class="attr">port:</span> <span class="number">8500</span></span><br><span class="line">      <span class="attr">config:</span></span><br><span class="line">        <span class="attr">watch:</span></span><br><span class="line">          <span class="attr">delay:</span> <span class="number">5000</span> <span class="comment"># 延时5秒自动刷新</span></span><br></pre></td></tr></table></figure>

<p>ConsulConfigAutoConfiguration</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ConsulConfigAutoConfiguration</span> &#123;</span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">CONFIG_WATCH_TASK_SCHEDULER_NAME</span> <span class="operator">=</span> <span class="string">&quot;configWatchTaskScheduler&quot;</span>;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Configuration</span></span><br><span class="line">	<span class="meta">@ConditionalOnClass(RefreshEndpoint.class)</span></span><br><span class="line">	<span class="keyword">protected</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">ConsulRefreshConfiguration</span> &#123;	</span><br><span class="line">		<span class="comment">// 构建一个用来刷新配置的ConfigWatch</span></span><br><span class="line">		<span class="meta">@Bean</span></span><br><span class="line">		<span class="meta">@ConditionalOnProperty(name = &quot;spring.cloud.consul.config.watch.enabled&quot;, matchIfMissing = true)</span></span><br><span class="line">		<span class="keyword">public</span> ConfigWatch <span class="title function_">configWatch</span><span class="params">(ConsulConfigProperties properties,</span></span><br><span class="line"><span class="params">				ConsulPropertySourceLocator locator, ConsulClient consul,</span></span><br><span class="line"><span class="params">				<span class="meta">@Qualifier(CONFIG_WATCH_TASK_SCHEDULER_NAME)</span> TaskScheduler taskScheduler)</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ConfigWatch</span>(properties, consul, locator.getContextIndexes(),</span><br><span class="line">					taskScheduler);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">// 以下就是Watch的定时任务</span></span><br><span class="line">		<span class="meta">@Bean(name = CONFIG_WATCH_TASK_SCHEDULER_NAME)</span></span><br><span class="line">		<span class="meta">@ConditionalOnProperty(name = &quot;spring.cloud.consul.config.watch.enabled&quot;, matchIfMissing = true)</span></span><br><span class="line">		<span class="keyword">public</span> TaskScheduler <span class="title function_">configWatchTaskScheduler</span><span class="params">()</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ThreadPoolTaskScheduler</span>();</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ThreadPoolTaskScheduler</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 可以看到这个定时任务是用ScheduledThreadPoolExecutor实现的</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@SuppressWarnings(&quot;serial&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ThreadPoolTaskScheduler</span> <span class="keyword">extends</span> <span class="title class_">ExecutorConfigurationSupport</span></span><br><span class="line">		<span class="keyword">implements</span> <span class="title class_">AsyncListenableTaskExecutor</span>, SchedulingTaskExecutor, TaskScheduler &#123;</span><br><span class="line">	<span class="comment">// 单线程</span></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">volatile</span> <span class="type">int</span> <span class="variable">poolSize</span> <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="keyword">public</span> ScheduledFuture&lt;?&gt; scheduleWithFixedDelay(Runnable task, <span class="type">long</span> delay) &#123;</span><br><span class="line">		<span class="type">ScheduledExecutorService</span> <span class="variable">executor</span> <span class="operator">=</span> getScheduledExecutor();</span><br><span class="line">		<span class="comment">// 参数1：任务</span></span><br><span class="line">		<span class="comment">// 参数2：第一次执行的延时时间</span></span><br><span class="line">		<span class="comment">// 参数3：经过第一次后的延时时间</span></span><br><span class="line">		<span class="comment">// 参数4：延时时间的单位</span></span><br><span class="line">		<span class="keyword">return</span> executor.scheduleWithFixedDelay(errorHandlingTask(task, <span class="literal">true</span>), <span class="number">0</span>, delay, TimeUnit.MILLISECONDS);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ConfigWatch</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ConfigWatch</span> <span class="keyword">implements</span> <span class="title class_">ApplicationEventPublisherAware</span>, SmartLifecycle &#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">final</span> ConsulConfigProperties properties;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">final</span> ConsulClient consul;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">final</span> TaskScheduler taskScheduler;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">final</span> <span class="type">AtomicBoolean</span> <span class="variable">running</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AtomicBoolean</span>(<span class="literal">false</span>);</span><br><span class="line">	<span class="keyword">private</span> ApplicationEventPublisher publisher;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">start</span><span class="params">()</span> &#123;</span><br><span class="line">		<span class="comment">// 将任务切换为已开启</span></span><br><span class="line">		<span class="keyword">if</span> (<span class="built_in">this</span>.running.compareAndSet(<span class="literal">false</span>, <span class="literal">true</span>)) &#123;</span><br><span class="line">			<span class="built_in">this</span>.watchFuture = <span class="built_in">this</span>.taskScheduler.scheduleWithFixedDelay(</span><br><span class="line">					<span class="built_in">this</span>::watchConfigKeyValues,  <span class="comment">// 任务</span></span><br><span class="line">					<span class="built_in">this</span>.properties.getWatch().getDelay()); <span class="comment">// 延时值从配置获取</span></span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// 任务</span></span><br><span class="line">	<span class="meta">@Timed(&quot;consul.watch-config-keys&quot;)</span></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">watchConfigKeyValues</span><span class="params">()</span> &#123;</span><br><span class="line">		<span class="comment">// 任务是否处于开启状态</span></span><br><span class="line">		<span class="keyword">if</span> (<span class="built_in">this</span>.running.get()) &#123; </span><br><span class="line">			<span class="keyword">for</span> (String context : <span class="built_in">this</span>.consulIndexes.keySet()) &#123;</span><br><span class="line">				<span class="comment">// 获取Consul上的KV值</span></span><br><span class="line">				Response&lt;List&lt;GetValue&gt;&gt; response = <span class="built_in">this</span>.consul.getKVValues(context,</span><br><span class="line">						aclToken,</span><br><span class="line">						<span class="keyword">new</span> <span class="title class_">QueryParams</span>(<span class="built_in">this</span>.properties.getWatch().getWaitTime(),</span><br><span class="line">								currentIndex));</span><br><span class="line"></span><br><span class="line">				<span class="keyword">if</span> (response.getValue() != <span class="literal">null</span> &amp;&amp; !response.getValue().isEmpty()) &#123;</span><br><span class="line">					<span class="type">Long</span> <span class="variable">newIndex</span> <span class="operator">=</span> response.getConsulIndex();</span><br><span class="line">					<span class="comment">// 是否有配置？</span></span><br><span class="line">					<span class="keyword">if</span> (newIndex != <span class="literal">null</span> &amp;&amp; !newIndex.equals(currentIndex)) &#123;</span><br><span class="line">						<span class="comment">// 是不是有新值？</span></span><br><span class="line">						<span class="keyword">if</span> (!<span class="built_in">this</span>.consulIndexes.containsValue(newIndex) &amp;&amp; !currentIndex.equals(-<span class="number">1L</span>)) &#123;</span><br><span class="line">							<span class="comment">//【重】发布刷新配置事件，要求RefreshEvent的监听者进行刷新操作</span></span><br><span class="line">							<span class="type">RefreshEventData</span> <span class="variable">data</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RefreshEventData</span>(context,currentIndex, newIndex);</span><br><span class="line">							<span class="built_in">this</span>.publisher.publishEvent(<span class="keyword">new</span> <span class="title class_">RefreshEvent</span>(<span class="built_in">this</span>, data, data.toString()));</span><br><span class="line">						&#125;</span><br><span class="line">					&#125;</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;	</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>查看一下 RefreshEvent 的监听者 RefreshEventListener</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RefreshEventListener</span> <span class="keyword">implements</span> <span class="title class_">SmartApplicationListener</span> &#123;</span><br><span class="line">	<span class="keyword">private</span> ContextRefresher refresh;</span><br><span class="line">	<span class="keyword">private</span> <span class="type">AtomicBoolean</span> <span class="variable">ready</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AtomicBoolean</span>(<span class="literal">false</span>);</span><br><span class="line">	<span class="keyword">public</span> <span class="title function_">RefreshEventListener</span><span class="params">(ContextRefresher refresh)</span> &#123;</span><br><span class="line">		<span class="built_in">this</span>.refresh = refresh;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onApplicationEvent</span><span class="params">(ApplicationEvent event)</span> &#123;</span><br><span class="line">		<span class="comment">//...</span></span><br><span class="line">		handle((RefreshEvent) event);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handle</span><span class="params">(RefreshEvent event)</span> &#123;</span><br><span class="line">		<span class="keyword">if</span> (<span class="built_in">this</span>.ready.get()) &#123;</span><br><span class="line">			log.debug(<span class="string">&quot;Event received &quot;</span> + event.getEventDesc());</span><br><span class="line">			<span class="comment">// 【重】使用 ContextRefresher 刷新配置</span></span><br><span class="line">			<span class="comment">// 即新建一个 SpringBoot 加载配置然后设置到当前环境中</span></span><br><span class="line">			<span class="comment">// 并主动下线注册中心的服务然后再重新注册</span></span><br><span class="line">			Set&lt;String&gt; keys = <span class="built_in">this</span>.refresh.refresh();</span><br><span class="line">			log.info(<span class="string">&quot;Refresh keys changed: &quot;</span> + keys);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><ul>
<li>[Spring Cloud中Eureka Client启动后就关闭 Unregistering application xxx with eureka with status DOWN]( [<a target="_blank" rel="noopener" href="http://www.appblog.cn/2019/04/23/Spring%20Cloud%E4%B8%ADEureka%20Client%E5%90%AF%E5%8A%A8%E5%90%8E%E5%B0%B1%E5%85%B3%E9%97%AD%20Unregistering%20application%20xxx%20with%20eureka%20with%20status%20DOWN/]">http://www.appblog.cn/2019/04/23/Spring%20Cloud%E4%B8%ADEureka%20Client%E5%90%AF%E5%8A%A8%E5%90%8E%E5%B0%B1%E5%85%B3%E9%97%AD%20Unregistering%20application%20xxx%20with%20eureka%20with%20status%20DOWN/]</a>(<a target="_blank" rel="noopener" href="http://www.appblog.cn/2019/04/23/Spring">http://www.appblog.cn/2019/04/23/Spring</a> Cloud中Eureka Client启动后就关闭 Unregistering application xxx with eureka with status DOWN&#x2F;) )</li>
<li><a target="_blank" rel="noopener" href="https://callistaenterprise.se/blogg/teknik/2017/05/12/building-microservices-part-6-configuration-server/">Building Microservices, part 6. Adding a Configuration Server</a></li>
<li><a target="_blank" rel="noopener" href="https://cloud.spring.io/spring-cloud-config/2.1.x/single/spring-cloud-config.html">Spring Cloud Config</a></li>
<li><a target="_blank" rel="noopener" href="https://www.consul.io/docs/agent/config_entries.html">Configuration Entries</a></li>
</ul>

  </div>
  
    
      <a id="older" class="blog-nav" href="/%E6%8E%A5%E5%8F%A3%E5%B9%82%E7%AD%89%E6%80%A7%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88%E7%AC%94%E8%AE%B0/">OLDER&nbsp;&gt;</a>
      
        
          <a id="newer" class="blog-nav" href="/minio%E4%BD%BF%E7%94%A8/">&lt;&nbsp;NEWER</a>
          
            
</div>
        <div class="footer">
  
    <div class="footer-more">
      
        <a href="/"><em style="color:red;">新站点正在开发中，网站暂停更新。</em></a>
        
    </div>
  
    <div class="footer-more">
      
        <a href="/">Copyright © DeeTam 2022</a>
        
    </div>
  
</div>

      </div>

      <div class="back-to-top hidden">
  <a href="javascript: void(0)">
    <i class="iconfont icon-chevronup"></i>
  </a>
</div>


<script src="/js/backtotop.js"></script>



      
  <div class="search-icon" id="search-icon">
    <a href="javascript: void(0)">
      <i class="iconfont icon-search"></i>
    </a>
  </div>

  <div class="search-overlay hidden">
    <div class="search-content" tabindex="0">
      <div class="search-box">
        <div class="search-title">
          <!-- <span class="search-icon-input">
            <a href="javascript: void(0)">
              <i class="iconfont icon-search"></i>
            </a>
          </span> -->
          
            <input type="text" class="search-input" id="search-input" placeholder="搜索...">
          
          <span class="search-close-icon" id="search-close-icon">
            <a href="javascript: void(0)">
              <i class="iconfont icon-close"></i>
            </a>
          </span>
        </div>
        <div class="search-result" id="search-result"></div>
      </div>
    </div>
  </div>

  <script type="text/javascript">
    var inputArea = document.querySelector("#search-input")
    var searchOverlayArea = document.querySelector(".search-overlay")

    // inputArea.onclick = function() {
    //   getSearchFile()
    //   this.onclick = null
    // }

    inputArea.onkeydown = function() {
      if(event.keyCode == 13)
        return false
    }

    function openOrHideSearchContent() {
      let isHidden = searchOverlayArea.classList.contains('hidden')
      if (isHidden) {
        searchOverlayArea.classList.remove('hidden')
        document.body.classList.add('hidden')
        inputArea.focus()
        getSearchFile()
      } else {
        searchOverlayArea.classList.add('hidden')
        document.body.classList.remove('hidden')
      }
    }

    function blurSearchContent(e) {
      if (e.target === searchOverlayArea) {
        openOrHideSearchContent()
      }
    }

    document.querySelector("#search-icon").addEventListener("click", openOrHideSearchContent, false)
    document.querySelector("#search-close-icon").addEventListener("click", openOrHideSearchContent, false)
    searchOverlayArea.addEventListener("click", blurSearchContent, false)

    var searchFunc = function (path, search_id, content_id) {
      'use strict';
      var $input = document.getElementById(search_id);
      var $resultContent = document.getElementById(content_id);
      $resultContent.innerHTML = "<ul><span class='local-search-empty'><span></ul>";
      // $resultContent.innerHTML = "<ul><span class='local-search-empty'>首次搜索，正在载入索引文件，请稍后……<span></ul>";
      $.ajax({
        // 0x01. load xml file
        url: path,
        dataType: "xml",
        success: function (xmlResponse) {
          // 0x02. parse xml file
          var datas = $("entry", xmlResponse).map(function () {
            return {
              title: $("title", this).text(),
              content: $("content", this).text(),
              url: $("url", this).text()
            };
          }).get();
          $resultContent.innerHTML = "";

          $input.addEventListener('input', function () {
            // 0x03. parse query to keywords list
            var str = '<ul class=\"search-result-list\">';
            var keywords = this.value.trim().toLowerCase().split(/[\s\-]+/);
            $resultContent.innerHTML = "";
            if (this.value.trim().length <= 0) {
              return;
            }
            // 0x04. perform local searching
            datas.forEach(function (data) {
              var isMatch = true;
              var content_index = [];
              if (!data.title || data.title.trim() === '') {
                data.title = "Untitled";
              }
              var orig_data_title = data.title.trim();
              var data_title = orig_data_title.toLowerCase();
              var orig_data_content = data.content.trim().replace(/<[^>]+>/g, "");
              var data_content = orig_data_content.toLowerCase();
              var data_url = data.url;
              var index_title = -1;
              var index_content = -1;
              var first_occur = -1;
              // only match artiles with not empty contents
              if (data_content !== '') {
                keywords.forEach(function (keyword, i) {
                  index_title = data_title.indexOf(keyword);
                  index_content = data_content.indexOf(keyword);

                  if (index_title < 0 && index_content < 0) {
                    isMatch = false;
                  } else {
                    if (index_content < 0) {
                      index_content = 0;
                    }
                    if (i == 0) {
                      first_occur = index_content;
                    }
                    // content_index.push({index_content:index_content, keyword_len:keyword_len});
                  }
                });
              } else {
                isMatch = false;
              }
              // 0x05. show search results
              if (isMatch) {
                str += "<li><a href='/" + data_url + "' class='search-result-title'><h2>" + orig_data_title + "</h2></a>";
                var content = orig_data_content;
                if (first_occur >= 0) {
                  // cut out 100 characters
                  var start = first_occur - 20;
                  var end = first_occur + 80;

                  if (start < 0) {
                    start = 0;
                  }

                  if (start == 0) {
                    end = 100;
                  }

                  if (end > content.length) {
                    end = content.length;
                  }

                  var match_content = content.substr(start, end);

                  // highlight all keywords
                  keywords.forEach(function (keyword) {
                    var regS = new RegExp(keyword, "gi");
                    match_content = match_content.replace(regS, "<span class=\"search-keyword\">" + keyword + "</span>");
                  });

                  str += "<h3 class=\"search-result-abstract\">" + match_content + "...</h3>"
                }
                str += "<hr></li>";
              }
            });
            str += "</ul>";
            if (str.indexOf('<li>') === -1) {
              return $resultContent.innerHTML = "<ul><span class='local-search-empty'>没有找到内容，请尝试更换检索词。<span></ul>";
            }
            $resultContent.innerHTML = str;
          });
        },
        error: function(xhr, status, error) {
          $resultContent.innerHTML = ""
          if (xhr.status === 404) {
            $resultContent.innerHTML = "<ul><span class='local-search-empty'>未找到search.xml文件，具体请参考：<a href='https://github.com/leedom92/hexo-theme-leedom#configuration' target='_black'>configuration</a><span></ul>";
          } else {
            $resultContent.innerHTML = "<ul><span class='local-search-empty'>请求失败，尝试重新刷新页面或稍后重试。<span></ul>";
          }
        }
      });
      $(document).on('click', '#search-close-icon', function() {
        $('#search-input').val('');
        $('#search-result').html('');
      });
    }

    var getSearchFile = function() {
        var path = "/search.xml";
        searchFunc(path, 'search-input', 'search-result');
    }
  </script>




    </div>
  </body>
</html>

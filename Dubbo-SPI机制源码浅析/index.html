<!DOCTYPE html>
<html lang="zh-CN">

  <head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="keywords" content="" />
  <meta name="author" content="DeeTam" />
  <meta name="description" content="学然后知不足" />
  
  
  <title>
    
      Dubbo SPI机制源码浅析 
      
      
    
  </title>

  
    <link rel="apple-touch-icon" href="/images/favicon.png">
    <link rel="icon" href="/images/favicon.png">
  

  <!-- Raleway-Font -->
  <link href="https://fonts.googleapis.com/css?family=Montserrat|Roboto:400,400italic,600|Roboto+Mono" rel="stylesheet">

  <!-- hexo site css -->
  
<link rel="stylesheet" href="/css/base.css">
<link rel="stylesheet" href="/css/common.css">
<link rel="stylesheet" href="/iconfont/iconfont.css">


  

  
    
<link rel="stylesheet" href="/css/post.css">

  

  <!-- jquery3.3.1 -->
  <script src="https://cdn.bootcss.com/jquery/3.3.1/jquery.min.js"></script>

  <!-- fancybox -->
  <link href="https://cdn.bootcss.com/fancybox/3.5.2/jquery.fancybox.min.css" rel="stylesheet">
  <script async src="https://cdn.bootcss.com/fancybox/3.5.2/jquery.fancybox.min.js"></script>
  
<script src="/js/fancybox.js"></script>


<meta name="generator" content="Hexo 6.3.0"></head>


  <body>
    <div id="app">
      <div class="header">
  <a href="/">DEE TAM</a>
</div>


      <p class="links">
  
    <a title="归档" target="" href="/archives/">
      <i class="iconfont icon-bookmark"></i>
    </a>
  
    <a title="邮箱" target="" href="mailto:oomgomgxx@gmail.com">
      <i class="iconfont icon-envelope"></i>
    </a>
  
    <a title="QQ" target="" href="tencent://message/?Menu=yes&uin=0x1DACE601&Service=300&sigT=45a1e5847943b64c6ff3990f8a9e644d2b31356cb0b4ac6b24663a3c8dd0f8aa12a595b1714f9d45">
      <i class="iconfont icon-qq"></i>
    </a>
  
    <a title="关于" target="" href="/about/">
      <i class="iconfont icon-emoji-friendly"></i>
    </a>
  
</p>


      <div class="main">
        <!-- 文章详情页，展示文章具体内容，url形式：https://yoursite/文章标题/ -->
<!-- 同时为「标签tag」，「朋友friend」，「分类categories」，「关于about」页面的承载页面，具体展示取决于page.type -->

<!-- LaTex Display -->
<script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
<script type="text/javascript" id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js">
</script>
<script>
  MathJax = {
    tex: {
      inlineMath: [['$', '$'], ['\\(', '\\)']]
    }
  };
</script>

<div class="post">
  
  <!--
  
    <h3 class="date">
    Aug 12, 2020
  </h3>
  
  -->

  
  <center>
    <h1>
      Dubbo SPI机制源码浅析
    </h1>
  </center>
  

  <div class="content markdown-body">
    <h2 id="内容修订"><a href="#内容修订" class="headerlink" title="内容修订"></a>内容修订</h2><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>SPI 的全称是 Service Provider Interface（服务提供者接口）。它 是模块化编程和微内核架构的重要部分。例如我们可以利用 SPI 做到不修改代码的情况切换接口的具体实现，又或者在多模块化编程时利用 SPI 来实现依赖倒置。</p>
<p>SPI 并不是 Dubbo 中独有的机制，准确点来说是 Dubbo 扩展了  JDK 的 SPI 机制。而除了 Dubbo 之外，其实很多常见的开源框架在直接或间接上地使用 SPI。例如 Hibernate 5 开始通过模块化来聚合第三方组件，JDBC 4.0 后自动加载数据库驱动， Sping Boot 的自动装配类加载，以及 Servlet 3.0 开始的无 xml 配置方式等，都是建基于 SPI 或其思想之上实现的。</p>
<h2 id="JDK-SPI-入门"><a href="#JDK-SPI-入门" class="headerlink" title="JDK SPI 入门"></a>JDK SPI 入门</h2><h3 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h3><p>在了解 Dubbo SPI 机制之前，个人认为很有必要先入门一下 JDK SPI，因为这是很多开源框架实现模块化组装的基础。</p>
<h3 id="快速入门案例"><a href="#快速入门案例" class="headerlink" title="快速入门案例"></a>快速入门案例</h3><p>一、创建 SPI 扩展接口（为依赖倒置作支持）</p>
<p>Person：全限定名为 spi.Person</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> pub.tandi.ddd_demo.test;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">Person</span> &#123;</span><br><span class="line">  <span class="keyword">void</span> <span class="title function_">sayHi</span><span class="params">()</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>二、给 SPI 扩展接口提供扩展实现（实现必须带有空参构造方法）</p>
<p>1）Student</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> pub.tandi.ddd_demo.domain;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> pub.tandi.ddd_demo.test.Person;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Student</span> <span class="keyword">implements</span> <span class="title class_">Person</span> &#123;</span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">sayHi</span><span class="params">()</span> &#123;</span><br><span class="line">    System.out.println(<span class="string">&quot;你好，我是学无止境的小学鸡&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>2）Worker</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> pub.tandi.ddd_demo.domain;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> pub.tandi.ddd_demo.test.Person;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Worker</span> <span class="keyword">implements</span> <span class="title class_">Person</span> &#123;</span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">sayHi</span><span class="params">()</span> &#123;</span><br><span class="line">    System.out.println(<span class="string">&quot;你好，我是玉树临风的工作人员&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>三、编写关联文件</p>
<ol>
<li>在类路径 META-INF&#x2F;services&#x2F; 下，创建一个以 SPI 扩展接口全限定名为名称的普通文本文件。该文件无需扩展名，当前案例为 pub.tandi.ddd_demo.test.Person</li>
<li>将想要使用的具体实现的全限定名填写进去。当前例子如下：</li>
</ol>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">pub.tandi.ddd_demo.domain.Student</span></span><br><span class="line"><span class="attr">pub.tandi.ddd_demo.domain.Worker</span></span><br></pre></td></tr></table></figure>

<p>四、使用 JDK SPI</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testSPI</span><span class="params">()</span> &#123;</span><br><span class="line">  <span class="keyword">final</span> Optional&lt;Person&gt; personOptional = ServiceLoader.load(Person.class).findFirst();</span><br><span class="line">  personOptional.ifPresent(Person::sayHi);</span><br><span class="line">  <span class="comment">// output: 你好，我是学无止境的小学鸡</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testSPIByStream</span><span class="params">()</span> &#123;</span><br><span class="line">  ServiceLoader.load(Person.class).stream().forEach(personProvider -&gt; &#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="type">Person</span> <span class="variable">person</span> <span class="operator">=</span> personProvider.get();</span><br><span class="line">    person.sayHi();</span><br><span class="line">  &#125;);</span><br><span class="line">  <span class="comment">// output: </span></span><br><span class="line">  <span class="comment">// 你好，我是学无止境的小学鸡</span></span><br><span class="line">  <span class="comment">// 你好，我是玉树临风的工作人员</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testSPIReload</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">  ServiceLoader&lt;Person&gt; peopleService = ServiceLoader.load(Person.class);</span><br><span class="line">  <span class="keyword">while</span>(<span class="literal">true</span>) &#123;</span><br><span class="line">    TimeUnit.SECONDS.sleep(<span class="number">3</span>);  </span><br><span class="line">    peopleService.reload(); <span class="comment">// 重新加载关联文件内容（会清除缓存Map）</span></span><br><span class="line">    <span class="keyword">final</span> Optional&lt;Person&gt; personOptional = peopleService.findFirst();</span><br><span class="line">    personOptional.ifPresent(Person::sayHi);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/** 输入：</span></span><br><span class="line"><span class="comment">你好，我是玉树临风的工作人员</span></span><br><span class="line"><span class="comment">你好，我是玉树临风的工作人员</span></span><br><span class="line"><span class="comment">你好，我是玉树临风的工作人员</span></span><br><span class="line"><span class="comment">你好，我是玉树临风的工作人员</span></span><br><span class="line"><span class="comment">你好，我是学无止境的小学鸡</span></span><br><span class="line"><span class="comment">你好，我是学无止境的小学鸡</span></span><br><span class="line"><span class="comment">你好，我是学无止境的小学鸡</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="comment">// 可以看到在第五行开始，输出内容变了</span></span><br><span class="line"><span class="comment">// 这是因为我把关联文件中的pub.tandi.ddd_demo.domain.Worker改成了pub.tandi.ddd_demo.domain.Student</span></span><br></pre></td></tr></table></figure>

<h3 id="ServiceLoader-源码浅析"><a href="#ServiceLoader-源码浅析" class="headerlink" title="ServiceLoader 源码浅析"></a>ServiceLoader 源码浅析</h3><p>字段、构造函数</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">ServiceLoader</span>&lt;S&gt; <span class="keyword">implements</span> <span class="title class_">Iterable</span>&lt;S&gt; &#123;</span><br><span class="line">  <span class="comment">// 关联文件存放位置</span></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">PREFIX</span> <span class="operator">=</span> <span class="string">&quot;META-INF/services/&quot;</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// SPI扩展接口Class实例</span></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> Class&lt;S&gt; service;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 加载关联文件的类加载器</span></span><br><span class="line">  <span class="comment">// 注意：因为同一个类加载器“实例”不会对同一个类文件加载两次</span></span><br><span class="line">  <span class="comment">// 所以要是T.class被加载过，那么即使修改T.class后再reload也不会加载到新的T.class</span></span><br><span class="line">  <span class="comment">// 而只有T.class被卸载或加载T.class的类加载器被回收后再次加载时才会加载到新的T.class</span></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> ClassLoader loader;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 安全访问控制，和SecurityManager配置相关</span></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> AccessControlContext acc;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 实现的对象实例缓存器（容器单例）</span></span><br><span class="line">  <span class="keyword">private</span> LinkedHashMap&lt;String,S&gt; providers = <span class="keyword">new</span> <span class="title class_">LinkedHashMap</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 懒加载形式的服务发现迭代器</span></span><br><span class="line">  <span class="comment">// ServiceLoader会先从providers查找，找不到才从LazyIterator中发现</span></span><br><span class="line">  <span class="keyword">private</span> LazyIterator lookupIterator;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 私有构造函数</span></span><br><span class="line">  <span class="keyword">private</span> <span class="title function_">ServiceLoader</span><span class="params">(Class&lt;S&gt; svc, ClassLoader cl)</span> &#123;</span><br><span class="line">    service = Objects.requireNonNull(svc, <span class="string">&quot;Service interface cannot be null&quot;</span>);</span><br><span class="line">    loader = (cl == <span class="literal">null</span>) ? ClassLoader.getSystemClassLoader() : cl;</span><br><span class="line">    acc = (System.getSecurityManager() != <span class="literal">null</span>) ? AccessController.getContext() : <span class="literal">null</span>;</span><br><span class="line">    <span class="comment">// 注意：每创建一次ServiceLoader实例都会reload一次，这时会清除缓存providers，并重新创建LazyIterator lookupIterator</span></span><br><span class="line">    reload();</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">//...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>load 方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> &lt;S&gt; ServiceLoader&lt;S&gt; <span class="title function_">load</span><span class="params">(Class&lt;S&gt; service)</span> &#123;</span><br><span class="line">  <span class="comment">// 获取加载当前类的类加载器</span></span><br><span class="line">  <span class="type">ClassLoader</span> <span class="variable">cl</span> <span class="operator">=</span> Thread.currentThread().getContextClassLoader(); </span><br><span class="line">  <span class="keyword">return</span> ServiceLoader.load(service, cl);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> &lt;S&gt; ServiceLoader&lt;S&gt; <span class="title function_">load</span><span class="params">(Class&lt;S&gt; service,</span></span><br><span class="line"><span class="params">                                        ClassLoader loader)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="comment">// 创建ServiceLoader实例（清除缓存providers，并重新创建LazyIterator）</span></span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ServiceLoader</span>&lt;&gt;(service, loader); </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>reload 方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 清除缓存providers，并重新创建LazyIterator lookupIterator</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">reload</span><span class="params">()</span> &#123;</span><br><span class="line">  <span class="comment">// 1. 清理本地缓存providers</span></span><br><span class="line">  providers.clear(); </span><br><span class="line"></span><br><span class="line">  <span class="comment">// 2. 重新创建LazyIterator</span></span><br><span class="line">  <span class="comment">// 注意：之所以重新创建LazyIterator，是为了让ServiceLoader的iterator()方法重新回到懒加载状态</span></span><br><span class="line">  <span class="comment">// 懒加载的核心思想是只有在使用时才会去加载，是一种避免不必要消耗的处理手法</span></span><br><span class="line">  <span class="comment">// 参数1：SPI扩展接口的Class实例</span></span><br><span class="line">  <span class="comment">// 参数2：类加载器</span></span><br><span class="line">  lookupIterator = <span class="keyword">new</span> <span class="title class_">LazyIterator</span>(service, loader); </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>iterator 方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 作用：懒加载迭代。即首先从缓存providers中获取实例，如果没有再用lookupIterator到关联文件中加载</span></span><br><span class="line"><span class="keyword">public</span> Iterator&lt;S&gt; <span class="title function_">iterator</span><span class="params">()</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Iterator</span>&lt;S&gt;() &#123;</span><br><span class="line"></span><br><span class="line">    Iterator&lt;Map.Entry&lt;String,S&gt;&gt; knownProviders = providers.entrySet().iterator();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">hasNext</span><span class="params">()</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (knownProviders.hasNext()) <span class="comment">// 先在缓存中查找，没有再用LazyIterator发现</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">return</span> lookupIterator.hasNext();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> S <span class="title function_">next</span><span class="params">()</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (knownProviders.hasNext())</span><br><span class="line">        <span class="keyword">return</span> knownProviders.next().getValue();</span><br><span class="line"></span><br><span class="line">      <span class="keyword">return</span> lookupIterator.next();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">remove</span><span class="params">()</span> &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">UnsupportedOperationException</span>();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>LazyIterator 懒加载服务发现</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">class</span> <span class="title class_">LazyIterator</span> <span class="keyword">implements</span> <span class="title class_">Iterator</span>&lt;S&gt; &#123;</span><br><span class="line">  <span class="comment">// 加载出来的内容</span></span><br><span class="line">  Enumeration&lt;URL&gt; configs = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 解析出来的实现信息</span></span><br><span class="line">  Iterator&lt;String&gt; pending = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 待加载实现的全限定名</span></span><br><span class="line">  <span class="type">String</span> <span class="variable">nextName</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 加载接口实现</span></span><br><span class="line">  <span class="keyword">private</span> <span class="type">boolean</span> <span class="title function_">hasNextService</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (nextName != <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (configs == <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="keyword">try</span> &#123; </span><br><span class="line">        <span class="comment">// 关联文件的路径</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">fullName</span> <span class="operator">=</span> PREFIX + service.getName();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 情况1：如果没有指定类加载器，则使用应用类加载器尝试加载</span></span><br><span class="line">        <span class="keyword">if</span> (loader == <span class="literal">null</span>) </span><br><span class="line">          configs = ClassLoader.getSystemResources(fullName);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 情况2：指定了类加载器</span></span><br><span class="line">        <span class="comment">// 注：ExtClassLoader、AppClassLoader继承自URLClassLoader</span></span><br><span class="line">        <span class="keyword">else</span> </span><br><span class="line">          configs = loader.getResources(fullName);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// ...</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">while</span> ((pending == <span class="literal">null</span>) || !pending.hasNext()) &#123;</span><br><span class="line">      <span class="keyword">if</span> (!configs.hasMoreElements()) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>; <span class="comment">// 表示已经没有内容需要加载（这时nextName为null，因为每次调用nextService()是该变量都会被置空）</span></span><br><span class="line">      &#125; </span><br><span class="line">      <span class="comment">// 将加载内容解析成pending（Iterator&lt;String&gt;）</span></span><br><span class="line">      pending = parse(service, configs.nextElement());</span><br><span class="line">    &#125;</span><br><span class="line">    nextName = pending.next();</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> S <span class="title function_">nextService</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// Fail Fast</span></span><br><span class="line">    <span class="keyword">if</span> (!hasNextService())</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">NoSuchElementException</span>();</span><br><span class="line"></span><br><span class="line">    <span class="type">String</span> <span class="variable">cn</span> <span class="operator">=</span> nextName;</span><br><span class="line">    nextName = <span class="literal">null</span>;</span><br><span class="line">    Class&lt;?&gt; c = <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="comment">// 1、获取SPI实现的Class对象</span></span><br><span class="line">      c = Class.forName(cn, <span class="literal">false</span>, loader); </span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="comment">// 2、实例化实现，并保存到缓存中</span></span><br><span class="line">      <span class="type">S</span> <span class="variable">p</span> <span class="operator">=</span> service.cast(c.newInstance());</span><br><span class="line">      providers.put(cn, p); <span class="comment">// 可以看到，key为类的限定名</span></span><br><span class="line">      <span class="keyword">return</span> p;</span><br><span class="line">    &#125; </span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">hasNext</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// 如果加载的内容没有做访问控制，则直接用hasNextService()获取</span></span><br><span class="line">    <span class="keyword">if</span> (acc == <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> hasNextService();</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 反之，包装hasNextService()进行访问控制检验</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      PrivilegedAction&lt;Boolean&gt; action = <span class="keyword">new</span> <span class="title class_">PrivilegedAction</span>&lt;Boolean&gt;() &#123;</span><br><span class="line">        <span class="keyword">public</span> Boolean <span class="title function_">run</span><span class="params">()</span> &#123; </span><br><span class="line">          <span class="keyword">return</span> hasNextService(); </span><br><span class="line">        &#125;</span><br><span class="line">      &#125;;</span><br><span class="line">      <span class="keyword">return</span> AccessController.doPrivileged(action, acc);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>拓展：URLClassLoader基本使用</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SneakyThrows</span></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">classLoader</span><span class="params">()</span> &#123; </span><br><span class="line"></span><br><span class="line">  <span class="keyword">final</span> <span class="type">ClassLoader</span> <span class="variable">classLoader</span> <span class="operator">=</span> Test.class.getClassLoader();</span><br><span class="line"></span><br><span class="line">  out(<span class="string">&quot;classLoader.getName()&quot;</span>, <span class="string">&quot;获取类加载器的名称&quot;</span>, classLoader.getName()); <span class="comment">// app：应用类加载器</span></span><br><span class="line">  out(<span class="string">&quot;classLoader.getParent()&quot;</span>, <span class="string">&quot;获取父类加载器&quot;</span>, classLoader.getParent().getName()); <span class="comment">// platform：平台类加载器</span></span><br><span class="line">  out(<span class="string">&quot;classLoader.getDefinedPackages()&quot;</span>, <span class="string">&quot;获取被加载过的包路径&quot;</span>, classLoader.getDefinedPackages());</span><br><span class="line">  out(<span class="string">&quot;classLoader.getSystemResource()&quot;</span>, <span class="string">&quot;使用系统类加载器直接从类路径中加载资源（不需要加/头，因为默认相对于类加载器路径）&quot;</span>, ClassLoader.getSystemResource(<span class="string">&quot;netty/test/kv.properties&quot;</span>));</span><br><span class="line">  out(<span class="string">&quot;classLoader.getSystemResourceAsStream()&quot;</span>, <span class="string">&quot;使用系统类加载器直接从类路径中加载资源，并返回输入流（不需要加/头，因为默认相对于类加载器路径）&quot;</span>, ClassLoader.getSystemResourceAsStream(<span class="string">&quot;netty/test/kv.properties&quot;</span>));</span><br><span class="line">  out(<span class="string">&quot;classLoader.resources()&quot;</span>, <span class="string">&quot;加载指定路径下的资源（不需要加/头，因为默认相对于类加载器路径），返回Stream&lt;URL&gt;&quot;</span>, classLoader.resources(<span class="string">&quot;netty/test/&quot;</span>));</span><br><span class="line">  out(<span class="string">&quot;classLoader.loadClass()&quot;</span>, <span class="string">&quot;使用委派模型加载类，但不进行初始化&quot;</span>, classLoader.loadClass(netty.test.Person.class.getName()));</span><br><span class="line">  <span class="comment">// Class.forName(netty.test.Person.class.getName()); // 默认初始化类</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// URLClassLoader使用</span></span><br><span class="line">  <span class="keyword">final</span> <span class="type">String</span> <span class="variable">protocol</span> <span class="operator">=</span> <span class="string">&quot;file:&quot;</span>;</span><br><span class="line">  <span class="keyword">final</span> <span class="type">String</span> <span class="variable">localDir</span> <span class="operator">=</span> <span class="string">&quot;/Users/tan/ProgrammingEnvironment/workspace/IdeaProjects/java11-demo/target/classes/&quot;</span>;</span><br><span class="line">  <span class="type">URL</span> <span class="variable">url</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">URL</span>(protocol + localDir);</span><br><span class="line">  <span class="type">URLClassLoader</span> <span class="variable">urlClassLoader</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">URLClassLoader</span>(<span class="keyword">new</span> <span class="title class_">URL</span>[]&#123;url&#125;);</span><br><span class="line">  Class&lt;?&gt; aClass = urlClassLoader.loadClass(<span class="string">&quot;netty.test.Person&quot;</span>); <span class="comment">// 从本地加载，但不初始化</span></span><br><span class="line">  aClass.getDeclaredConstructor().newInstance(); <span class="comment">// 初始化并实例化</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// 需要注意的是，其实上面classLoader.getSystemResource()和classLoader.getSystemResourceAsStream() 依赖的是下面两个方法</span></span><br><span class="line">  <span class="comment">// 即只要是从磁盘或网络中定位，其实都是通过URLClassLoader来查找资源的，而默认路径是classpath下，即*/target/classes/</span></span><br><span class="line">  <span class="comment">// 区别：loadClass()用于加载类，而findResource()用于加载其它资源</span></span><br><span class="line">  urlClassLoader.findResource(<span class="string">&quot;netty/test/kv.properties&quot;</span>);</span><br><span class="line">  urlClassLoader.getResourceAsStream(<span class="string">&quot;netty/test/kv.properties&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="JDK-SPI-最佳实践-Servlet-3-0"><a href="#JDK-SPI-最佳实践-Servlet-3-0" class="headerlink" title="JDK SPI 最佳实践 - Servlet 3.0"></a>JDK SPI 最佳实践 - Servlet 3.0</h3><p><img src="/Dubbo-SPI%E6%9C%BA%E5%88%B6%E6%BA%90%E7%A0%81%E6%B5%85%E6%9E%90/001.png"></p>
<h2 id="Dubbo微内核架构基石-SPI扩展"><a href="#Dubbo微内核架构基石-SPI扩展" class="headerlink" title="Dubbo微内核架构基石 - SPI扩展"></a>Dubbo微内核架构基石 - SPI扩展</h2><h3 id="为什么-Dubbo-需要扩展-JDK-SPI"><a href="#为什么-Dubbo-需要扩展-JDK-SPI" class="headerlink" title="为什么 Dubbo 需要扩展 JDK SPI"></a>为什么 Dubbo 需要扩展 JDK SPI</h3><p>1）在其官方文档它认为 JDK SPI 有如下缺点</p>
<ul>
<li>需要遍历所有的实现并将其实例化，然后在循环中才能找到真正需要的实现</li>
<li>基于上一点的原因，无法实现按需加载</li>
<li>在关联文件中不能为具体扩展命名，导致在程序中很难准确地引用想要的实现</li>
<li>如果扩展本身依赖其他的扩展，不能做到自动地依赖注入</li>
<li>没有类 IOC 和 AOP 功能，亦没有渠道对其扩径进行参数配置，因此而导致扩展性差<ul>
<li>Dubbo SPI 实现了 IOC 能力，通过<code>适配器模式</code>实现</li>
<li>Wrapper 实现了 AOP 能力，通过<code>装饰器模式</code>，主要用于扩展能力和减少反射的使用</li>
</ul>
</li>
<li>扩展很难和其他的框架集成。譬如扩展依赖了一个 Spring Bean 的话原生的 JDK SPI 机制是不支持</li>
</ul>
<p>2）在 Dubbo 中 SPI 的常见扩展点</p>
<p><img src="/Dubbo-SPI%E6%9C%BA%E5%88%B6%E6%BA%90%E7%A0%81%E6%B5%85%E6%9E%90/005.png"></p>
<p>其实除了下面的 Service层（提供给客户端使用的API接口层）和 Config层（配置层）之外，其它都可通过 SPI 进行扩展。</p>
<p>这也是为什么微内核架构也叫插件式架构的原因</p>
<p><img src="/Dubbo-SPI%E6%9C%BA%E5%88%B6%E6%BA%90%E7%A0%81%E6%B5%85%E6%9E%90/006.png"></p>
<ul>
<li>proxy层：为消费者提供stub代理，用于模拟远程服务实例。为生产者提供Wrapper能力，减少反射调用</li>
<li>Registry层：实现为消费者拉取服务列表，为生产者注册服务列表等功能</li>
<li>Cluster层 ：实现服务调用路由规则、负载均衡、集群容错等功能（这些功能均通过 Invoker 实现）</li>
<li>Monitor层：实现消费者和生产者的数据统计，为监控提供支持</li>
<li>Protocol层：实现RPC通信协议。如支持 InJVM、HTTP、Dubbo、Hessiam、RMI、WebService 、Triple（Dubbo 3）等协议（默认使用 Dubbo）</li>
<li>Exchange层：实现请求和响应的方式，以及同步和异步的转换</li>
<li>Transport层：网络传输抽象，依赖于Netty 和 Mina</li>
<li>Serialize层：提供对传输数据进行序列化的能力。如支持 DubboSerialization、Hessian2Serialization、JavaSerialization、CompactedJavaSerialization、NativeJavaSerialization 等方式（默认使用 Hessian2）</li>
</ul>
<p>3）拓展：关于服务列表注册的小记</p>
<p><img src="/Dubbo-SPI%E6%9C%BA%E5%88%B6%E6%BA%90%E7%A0%81%E6%B5%85%E6%9E%90/007.png"></p>
<ul>
<li>先启动 Netty 然后再注册</li>
<li>期间 DubboProtocol 会通过 DubboExporter 获取要暴露的 Invoker 进行注册，而 Invoker 代表的是某个服务的一个提供者（具体信息保存在 Invocation 中）</li>
<li>Invoker 是 Cluster 层的实现者</li>
</ul>
<h3 id="快速入门案例-1"><a href="#快速入门案例-1" class="headerlink" title="快速入门案例"></a>快速入门案例</h3><p>一、创建 SPI 扩展接口</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> pub.tandi.ddd_demo.test;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.dubbo.common.extension.SPI;</span><br><span class="line"></span><br><span class="line"><span class="meta">@SPI(&quot;student&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">Person</span> &#123;</span><br><span class="line">  <span class="keyword">void</span> <span class="title function_">sayHi</span><span class="params">()</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>二、给 SPI 扩展接口提供扩展实现（实现必须带有空参构造方法）</p>
<p>Student</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> pub.tandi.ddd_demo.domain;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> pub.tandi.ddd_demo.test.Person;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Student</span> <span class="keyword">implements</span> <span class="title class_">Person</span> &#123;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">sayHi</span><span class="params">()</span> &#123;</span><br><span class="line">    System.out.println(<span class="string">&quot;你好，我是学无止境的小学鸡&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Worker</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> pub.tandi.ddd_demo.domain;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> pub.tandi.ddd_demo.test.Person;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Worker</span> <span class="keyword">implements</span> <span class="title class_">Person</span> &#123;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">sayHi</span><span class="params">()</span> &#123;</span><br><span class="line">    System.out.println(<span class="string">&quot;你好，我是玉树临风的工作人员&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>三、编写关联文件</p>
<ol>
<li><p>在类路径 META-INF&#x2F;dubbo&#x2F; 下，创建一个以 SPI 扩展接口全限定名为名称的普通文本文件。该文件无需扩展名，当前案例为 pub.tandi.ddd_demo.test.Person</p>
</li>
<li><p>将想要使用的具体实现的全限定名填写进去。当前例子如下：</p>
</li>
</ol>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">student</span>=<span class="string">pub.tandi.ddd_demo.domain.Student</span></span><br><span class="line"><span class="attr">worker</span>=<span class="string">pub.tandi.ddd_demo.domain.Worker</span></span><br></pre></td></tr></table></figure>

<ul>
<li><p>关联文件是 key - value 对</p>
</li>
<li><p>值得注意的是关联文件除了可以存放在 <code>META-INF/services/</code> 下，还可以放在 <code>META-INF/dubbo/</code> 和 <code>META-INF/internal/</code> 下。它们分别与 ServicesLoadingStrategy、DubboLoadingStrategy、DubboInternalLoadingStrategy 三种加载策略对应</p>
</li>
</ul>
<p>四、使用测试</p>
<p>普通模式使用：直接依赖 @SPI 操作</p>
<ul>
<li>@SPI 用于标注扩展点接口</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testDSPI</span><span class="params">()</span> &#123;</span><br><span class="line">  ExtensionLoader&lt;Person&gt; loader = ExtensionLoader.getExtensionLoader(Person.class);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 方式1：返回默认扩展实现。即@SPI(&quot;DefaultKey&quot;)</span></span><br><span class="line">  <span class="comment">//Person person = loader.getDefaultExtension();</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// 方式2：根据指定Key获取（找不到会返回默认扩展实现）</span></span><br><span class="line">  <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> <span class="string">&quot;worker&quot;</span>;</span><br><span class="line">  <span class="keyword">final</span> <span class="type">Person</span> <span class="variable">person</span> <span class="operator">=</span> loader.getOrDefaultExtension(key);</span><br><span class="line">  person.sayHi();</span><br><span class="line">  <span class="comment">// output: 你好，我是玉树临风的工作人员</span></span><br><span class="line"></span><br><span class="line">  System.out.println(person);</span><br><span class="line">  <span class="comment">// output: pub.tandi.ddd_demo.domain.Worker@f0c8a99</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>适配模式使用：@SPI + @Adaptive </p>
<ul>
<li>@Adaptive 为扩展接口提供适配模式支持</li>
<li>@Adaptive 可标注在<code>扩展点抽象方法</code>和<code>扩展点实现类</code>上<ul>
<li>当标注在扩展点实现类上时，表示这是一个装饰器类（参考：AdaptiveCompiler 类）</li>
<li>当标注在扩展点抽象方法上时，方法需在参数列表中添加 Dubbo 提供的 URL&#x2F;Invoker 类作为入参，否则会抛出 IllegalStateException 异常。其中 URL 用于传递参数，主要作用是为 AOP 适配具体实现提供条件依据</li>
</ul>
</li>
</ul>
<p>1）开启适配模式</p>
<p>扩展接口</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> pub.tandi.ddd_demo.test;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.dubbo.common.URL;</span><br><span class="line"><span class="keyword">import</span> org.apache.dubbo.common.extension.Adaptive;</span><br><span class="line"><span class="keyword">import</span> org.apache.dubbo.common.extension.SPI;</span><br><span class="line"></span><br><span class="line"><span class="meta">@SPI(&quot;student&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">Person</span> &#123;</span><br><span class="line">  <span class="comment">// 启用适配模式</span></span><br><span class="line">  <span class="comment">// value参数：定义URL中的参数名。用于根据该参数的值进行扩展点实现适配</span></span><br><span class="line">  <span class="meta">@Adaptive(value = &quot;active&quot;)</span></span><br><span class="line">  <span class="keyword">void</span> <span class="title function_">sayHi</span><span class="params">(URL url)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>扩展点实现</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> pub.tandi.ddd_demo.domain;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.dubbo.common.URL;</span><br><span class="line"><span class="keyword">import</span> pub.tandi.ddd_demo.test.Person;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Student</span> <span class="keyword">implements</span> <span class="title class_">Person</span> &#123;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">sayHi</span><span class="params">(URL url)</span> &#123;</span><br><span class="line">    System.out.println(<span class="string">&quot;你好，我是学无止境的小学鸡&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">package</span> pub.tandi.ddd_demo.domain;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.dubbo.common.URL;</span><br><span class="line"><span class="keyword">import</span> pub.tandi.ddd_demo.test.Person;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Worker</span> <span class="keyword">implements</span> <span class="title class_">Person</span> &#123;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">sayHi</span><span class="params">(URL url)</span> &#123;</span><br><span class="line">    System.out.println(<span class="string">&quot;你好，我是玉树临风的工作人员&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>2）使用测试</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testDSPIAdaptive</span><span class="params">()</span> &#123;</span><br><span class="line"></span><br><span class="line">  ExtensionLoader&lt;Person&gt; loader = ExtensionLoader.getExtensionLoader(Person.class);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 使用适配模式匹配</span></span><br><span class="line">  <span class="comment">// 因为使用运行时织入的AOP，所以这里返回的是一个代理实例</span></span><br><span class="line">  <span class="type">Person</span> <span class="variable">person</span> <span class="operator">=</span> loader.getAdaptiveExtension();</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 拼装URL</span></span><br><span class="line">  <span class="comment">// URL在Dubbo中用于传递配置，贯穿了整个RPC过程，比较重要</span></span><br><span class="line">  <span class="keyword">final</span> <span class="type">URL</span> <span class="variable">url</span> <span class="operator">=</span> URL.valueOf(<span class="string">&quot;https://www.baidu.com/?active=worker&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 适配调用</span></span><br><span class="line">  person.sayHi(url);</span><br><span class="line">  <span class="comment">// output: 你好，我是玉树临风的工作人员</span></span><br><span class="line"></span><br><span class="line">  System.out.println(person);</span><br><span class="line">  <span class="comment">// output: pub.tandi.ddd_demo.test.Person$Adaptive@5db45159</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>Dubbo 3.0.4 为止没有适配 JDK17，异常操作会出现反射异常，添加 <code>--illegal-access=permi</code> 亦无法解决</li>
</ul>
<p>激活模式：@SPI + @Activate</p>
<ul>
<li>在激活模式中扩展点接口无需使用 URL 作为入参，但依然需要 URL 来激活</li>
<li>@Activate 可以标注在<code>扩展点实现类</code>或<code>扩展点方法</code>上</li>
<li>@Activate 常见用法有两种：<ol>
<li>@Activate (value &#x3D; “xxx”)：指定激活参数。即URL中如果包含该值就激活对应的实现</li>
<li>@Activate (group&#x3D; “xxx”)：指定 group 值，当调用 getActivateExtension 时指定 group 值，那么被匹配的组将会被激活</li>
</ol>
</li>
</ul>
<p>@Activate (value &#x3D; “name”) 案例</p>
<p>1）配置</p>
<p>Worker类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> pub.tandi.ddd_demo.domain;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.dubbo.common.extension.Activate;</span><br><span class="line"><span class="keyword">import</span> pub.tandi.ddd_demo.test.Person;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Activate(value = &quot;worker&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Worker</span> <span class="keyword">implements</span> <span class="title class_">Person</span> &#123;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">sayHi</span><span class="params">()</span> &#123;</span><br><span class="line">    System.out.println(<span class="string">&quot;你好，我是玉树临风的工作人员&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Student类型</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> pub.tandi.ddd_demo.domain;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.dubbo.common.extension.Activate;</span><br><span class="line"><span class="keyword">import</span> pub.tandi.ddd_demo.test.Person;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Activate(value = &quot;student&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Student</span> <span class="keyword">implements</span> <span class="title class_">Person</span> &#123;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">sayHi</span><span class="params">()</span> &#123;</span><br><span class="line">    System.out.println(<span class="string">&quot;你好，我是学无止境的小学鸡&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>2）使用测试</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testDSPIActivate</span><span class="params">()</span> &#123;</span><br><span class="line"></span><br><span class="line">  ExtensionLoader&lt;Person&gt; loader = ExtensionLoader.getExtensionLoader(Person.class);</span><br><span class="line"></span><br><span class="line">  <span class="type">String</span> <span class="variable">request</span> <span class="operator">=</span> <span class="string">&quot;http://localhost&quot;</span>;</span><br><span class="line">  <span class="type">String</span> <span class="variable">params</span> <span class="operator">=</span> <span class="string">&quot;key=student&quot;</span>; <span class="comment">// 启用 @Activate 值为 student 的实现</span></span><br><span class="line">  <span class="type">URL</span> <span class="variable">url</span> <span class="operator">=</span> URL.valueOf(request + <span class="string">&quot;?&quot;</span> + params);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 通过激活模式激活扩展点实现</span></span><br><span class="line">  <span class="keyword">final</span> List&lt;Person&gt; persons = loader.getActivateExtension(url, <span class="string">&quot;key&quot;</span>);</span><br><span class="line">  persons.forEach(Person::sayHi);</span><br><span class="line">  <span class="comment">// output: 你好，我是学无止境的小学鸡</span></span><br><span class="line"></span><br><span class="line">  System.out.println(persons);</span><br><span class="line">  <span class="comment">// output: [pub.tandi.ddd_demo.domain.Student@64485a47]</span></span><br><span class="line">  <span class="comment">// 可以看到并不是代理，也就是说激活模式其实是普通模式的增强</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>@Activate (group&#x3D; “name”) 案例</p>
<p>1）配置</p>
<p>Student类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> pub.tandi.ddd_demo.domain;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.dubbo.common.extension.Activate;</span><br><span class="line"><span class="keyword">import</span> pub.tandi.ddd_demo.test.Person;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Activate(group = &quot;test&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Student</span> <span class="keyword">implements</span> <span class="title class_">Person</span> &#123;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">sayHi</span><span class="params">()</span> &#123;</span><br><span class="line">    System.out.println(<span class="string">&quot;你好，我是学无止境的小学鸡&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Worker类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> pub.tandi.ddd_demo.domain;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.dubbo.common.extension.Activate;</span><br><span class="line"><span class="keyword">import</span> pub.tandi.ddd_demo.test.Person;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Activate(group = &quot;test&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Worker</span> <span class="keyword">implements</span> <span class="title class_">Person</span> &#123;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">sayHi</span><span class="params">()</span> &#123;</span><br><span class="line">    System.out.println(<span class="string">&quot;你好，我是玉树临风的工作人员&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>2）使用测试</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testDSPIActivate</span><span class="params">()</span> &#123;</span><br><span class="line"></span><br><span class="line">  ExtensionLoader&lt;Person&gt; loader = ExtensionLoader.getExtensionLoader(Person.class);</span><br><span class="line"></span><br><span class="line">  <span class="type">String</span> <span class="variable">request</span> <span class="operator">=</span> <span class="string">&quot;http://localhost&quot;</span>;</span><br><span class="line">  <span class="type">String</span> <span class="variable">params</span> <span class="operator">=</span> <span class="string">&quot;key=student&quot;</span>; <span class="comment">// 启用 @Activate 值为 student 的实现</span></span><br><span class="line">  <span class="type">URL</span> <span class="variable">url</span> <span class="operator">=</span> URL.valueOf(request + <span class="string">&quot;?&quot;</span> + params);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 方式1：通过激活模式激活扩展点实现</span></span><br><span class="line">  <span class="comment">// final List&lt;Person&gt; persons = loader.getActivateExtension(url, &quot;key&quot;);</span></span><br><span class="line">  <span class="comment">// persons.forEach(Person::sayHi);</span></span><br><span class="line">  <span class="comment">// output: 你好，我是学无止境的小学鸡</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// 方式2：通过组名激活整个组的具体实现</span></span><br><span class="line">  <span class="keyword">final</span> <span class="type">String</span> <span class="variable">groupName</span> <span class="operator">=</span> <span class="string">&quot;test&quot;</span>;</span><br><span class="line">  <span class="keyword">final</span> List&lt;Person&gt; persons = loader.getActivateExtension(<span class="literal">null</span>, <span class="keyword">new</span> <span class="title class_">String</span>[]&#123;&#125;, groupName);;</span><br><span class="line">  persons.forEach(Person::sayHi);</span><br><span class="line">  <span class="comment">// output:</span></span><br><span class="line">  <span class="comment">// 你好，我是学无止境的小学鸡</span></span><br><span class="line">  <span class="comment">// 你好，我是玉树临风的工作人员</span></span><br><span class="line"></span><br><span class="line">  System.out.println(persons);</span><br><span class="line">  <span class="comment">// output: [pub.tandi.ddd_demo.domain.Student@64485a47, pub.tandi.ddd_demo.domain.Worker@25bbf683]</span></span><br><span class="line">  <span class="comment">// 可以看到并不是代理，也就是说激活模式其实是普通模式的增强</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="ExtensionLoader-源码浅析"><a href="#ExtensionLoader-源码浅析" class="headerlink" title="ExtensionLoader 源码浅析"></a>ExtensionLoader 源码浅析</h3><h4 id="普通模式"><a href="#普通模式" class="headerlink" title="普通模式"></a>普通模式</h4><p><img src="/Dubbo-SPI%E6%9C%BA%E5%88%B6%E6%BA%90%E7%A0%81%E6%B5%85%E6%9E%90/002.png"></p>
<p>getOrDefaultExtension(String name) 方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> T <span class="title function_">getOrDefaultExtension</span><span class="params">(String name)</span> &#123;</span><br><span class="line">  <span class="comment">// containsExtension(name)：会先加载SPI扩展配置文件，并判断key值name是否存在于加载内容中</span></span><br><span class="line">  <span class="comment">// 如果返回true，则直接调用 getExtension(name) 获取，否者加载默认值(既@SPI中的value值)</span></span><br><span class="line">  <span class="keyword">return</span> containsExtension(name) ? getExtension(name) : getDefaultExtension();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>containsExtension(name) 方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 判断key值name是否存在于加载内容中</span></span><br><span class="line"><span class="keyword">private</span> <span class="type">boolean</span> <span class="title function_">containsExtension</span><span class="params">(String name)</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> getExtensionClasses().containsKey(name);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>getExtensionClasses() 方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 获取SPI扩展实现</span></span><br><span class="line"><span class="keyword">private</span> Map&lt;String, Class&lt;?&gt;&gt; getExtensionClasses() &#123;</span><br><span class="line">  <span class="comment">// 先判断缓存中是否存在，避免无谓消耗</span></span><br><span class="line">  Map&lt;String, Class&lt;?&gt;&gt; classes = cachedClasses.get();</span><br><span class="line">  <span class="keyword">if</span> (classes == <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="keyword">synchronized</span> (cachedClasses) &#123;</span><br><span class="line">      classes = cachedClasses.get();</span><br><span class="line">      <span class="keyword">if</span> (classes == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="comment">// 加载关联文件</span></span><br><span class="line">        classes = loadExtensionClasses(); <span class="comment">// 加载扩展点实现的Class集合 </span></span><br><span class="line">        <span class="comment">// 将其保存到 Holder&lt;Map&lt;String, Class&lt;?&gt;&gt;&gt; cachedClasses 中缓存</span></span><br><span class="line">        cachedClasses.set(classes);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> classes;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>loadExtensionClasses() 方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 从SPI关联文件中加载扩展点实现</span></span><br><span class="line"><span class="keyword">private</span> Map&lt;String, Class&lt;?&gt;&gt; loadExtensionClasses() &#123;</span><br><span class="line">  <span class="comment">// 从扩展点的@SPI注解中得到默认的key值（如果有的话）</span></span><br><span class="line">  cacheDefaultExtensionName(); </span><br><span class="line">  <span class="comment">// 扩展点的实现</span></span><br><span class="line">  Map&lt;String, Class&lt;?&gt;&gt; extensionClasses = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 通过Dubbo内置的加载策略来加载SPI关联文件</span></span><br><span class="line">  <span class="keyword">for</span> (LoadingStrategy strategy : strategies) &#123;</span><br><span class="line">    <span class="comment">// 参数1：存放加载内容的容器</span></span><br><span class="line">    <span class="comment">// 参数2：加载目录</span></span><br><span class="line">    <span class="comment">// 参数3：扩展点名称</span></span><br><span class="line">    <span class="comment">// 参数4：类加载器</span></span><br><span class="line">    <span class="comment">// 参数5：是否开启覆盖</span></span><br><span class="line">    <span class="comment">// 参数6：查找时排除的包</span></span><br><span class="line">    loadDirectory(extensionClasses, strategy.directory(), type.getName(), strategy.preferExtensionClassLoader(), strategy.overridden(), strategy.excludedPackages());</span><br><span class="line">    loadDirectory(extensionClasses, strategy.directory(), type.getName().replace(<span class="string">&quot;org.apache&quot;</span>, <span class="string">&quot;com.alibaba&quot;</span>), strategy.preferExtensionClassLoader(), strategy.overridden(), strategy.excludedPackages());</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> extensionClasses;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在 Dubbo 中内置的加载策略有以下这些</p>
<ul>
<li>DubboInternalLoadingStrategy：从 <code>META-INF/dubbo/internal/</code> 中加载</li>
<li>DubboLoadingStrategy：从 <code>META-INF/dubbo/</code> 中加载</li>
<li>ServicesLoadingStrategy：从 <code>META-INF/services/</code> 中加载</li>
</ul>
<p>也就是说，Dubbo SPI 的关联文件可以存放在以上文件路径下。</p>
<p>除此之外，也可以通过实现 LoadingStrategy 接口，然后在 META-INF&#x2F;services 下添加关联文件来扩展 Dubbo 的加载策略。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyLoadingStrategy</span> <span class="keyword">implements</span> <span class="title class_">LoadingStrategy</span> &#123;</span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="keyword">public</span> String <span class="title function_">directory</span><span class="params">()</span> &#123; <span class="comment">// 自定义关联文件加载路径</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;META-INF/my/&quot;</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">overridden</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getPriority</span><span class="params">()</span> &#123; <span class="comment">// 优先级别</span></span><br><span class="line">    <span class="keyword">return</span> NORMAL_PRIORITY;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>loadDirectory(…) 方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 根据加载策略到指定的位置加载关联文件</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">loadDirectory</span><span class="params">(Map&lt;String, Class&lt;?&gt;&gt; extensionClasses, String dir, String type,</span></span><br><span class="line"><span class="params">                           <span class="type">boolean</span> extensionLoaderClassLoaderFirst, <span class="type">boolean</span> overridden, String... excludedPackages)</span> &#123;</span><br><span class="line">  <span class="type">String</span> <span class="variable">fileName</span> <span class="operator">=</span> dir + type; <span class="comment">// 关联文件的全限定名称</span></span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    Enumeration&lt;java.net.URL&gt; urls = <span class="literal">null</span>;</span><br><span class="line">    <span class="type">ClassLoader</span> <span class="variable">classLoader</span> <span class="operator">=</span> findClassLoader();</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="keyword">if</span> (urls == <span class="literal">null</span> || !urls.hasMoreElements()) &#123;</span><br><span class="line">      <span class="comment">// 这里和JDK SPI一样，如果没有指定类加载的前提下就使用加载当前类的类加载器加载</span></span><br><span class="line">      <span class="keyword">if</span> (classLoader != <span class="literal">null</span>) &#123;</span><br><span class="line">        urls = classLoader.getResources(fileName); </span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        urls = ClassLoader.getSystemResources(fileName);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (urls != <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="keyword">while</span> (urls.hasMoreElements()) &#123;</span><br><span class="line">        java.net.<span class="type">URL</span> <span class="variable">resourceURL</span> <span class="operator">=</span> urls.nextElement();</span><br><span class="line">        <span class="comment">// 进行资源加载</span></span><br><span class="line">        loadResource(extensionClasses, classLoader, resourceURL, overridden, excludedPackages);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; </span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>loadResource(…) 方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 解析关联文件，并将其实现Class添加到容器extensionClasses中保存</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">loadResource</span><span class="params">(Map&lt;String, Class&lt;?&gt;&gt; extensionClasses, ClassLoader classLoader,</span></span><br><span class="line"><span class="params">                          java.net.URL resourceURL, <span class="type">boolean</span> overridden, String... excludedPackages)</span> &#123;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">try</span> (<span class="type">BufferedReader</span> <span class="variable">reader</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BufferedReader</span>(<span class="keyword">new</span> <span class="title class_">InputStreamReader</span>(resourceURL.openStream(), StandardCharsets.UTF_8))) &#123;</span><br><span class="line">      String line;</span><br><span class="line">      <span class="comment">// 一次读取一行，一行的格式是：key=value</span></span><br><span class="line">      <span class="keyword">while</span> ((line = reader.readLine()) != <span class="literal">null</span>) &#123; </span><br><span class="line">        <span class="keyword">final</span> <span class="type">int</span> <span class="variable">ci</span> <span class="operator">=</span> line.indexOf(<span class="string">&#x27;#&#x27;</span>);</span><br><span class="line">        <span class="keyword">if</span> (ci &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">          line = line.substring(<span class="number">0</span>, ci);</span><br><span class="line">        &#125;</span><br><span class="line">        line = line.trim();</span><br><span class="line">        <span class="keyword">if</span> (line.length() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">          <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">name</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">            <span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> line.indexOf(<span class="string">&#x27;=&#x27;</span>);</span><br><span class="line">            <span class="keyword">if</span> (i &gt; <span class="number">0</span>) &#123;</span><br><span class="line">              name = line.substring(<span class="number">0</span>, i).trim();</span><br><span class="line">              line = line.substring(i + <span class="number">1</span>).trim();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (line.length() &gt; <span class="number">0</span> &amp;&amp; !isExcluded(line, excludedPackages)) &#123; <span class="comment">// 加载实现，并初始化</span></span><br><span class="line">              loadClass(extensionClasses, resourceURL, Class.forName(line, <span class="literal">true</span>, classLoader), name, overridden);</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="comment">// ...</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>getExtension(String name) 方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 根据name来获取实现</span></span><br><span class="line"><span class="keyword">public</span> T <span class="title function_">getExtension</span><span class="params">(String name)</span> &#123;</span><br><span class="line">  <span class="keyword">if</span> (<span class="string">&quot;true&quot;</span>.equals(name)) &#123;</span><br><span class="line">    <span class="keyword">return</span> getDefaultExtension();</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">final</span> Holder&lt;Object&gt; holder = getOrCreateHolder(name);</span><br><span class="line">  <span class="type">Object</span> <span class="variable">instance</span> <span class="operator">=</span> holder.get(); <span class="comment">// Object为Map&lt;String, Class&lt;?&gt;&gt;</span></span><br><span class="line">  <span class="keyword">if</span> (instance == <span class="literal">null</span>) &#123; <span class="comment">// 如果找不到，则扫描关联文件</span></span><br><span class="line">    <span class="keyword">synchronized</span> (holder) &#123;</span><br><span class="line">      instance = holder.get();</span><br><span class="line">      <span class="keyword">if</span> (instance == <span class="literal">null</span>) &#123;</span><br><span class="line">        instance = createExtension(name);</span><br><span class="line">        holder.set(instance);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> (T) instance;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>getDefaultExtension() 方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 获取默认实现</span></span><br><span class="line"><span class="keyword">public</span> T <span class="title function_">getDefaultExtension</span><span class="params">()</span> &#123;</span><br><span class="line">  <span class="comment">// 扫描关联文件</span></span><br><span class="line">  <span class="comment">// 注意，该方法并不会重复加载，因为在当前例子中调用getOrDefaultExtension()时结果已经被缓存</span></span><br><span class="line">  <span class="comment">// 这里调用getExtensionClasses()是因为当前方法getDefaultExtension()是public修饰的</span></span><br><span class="line">  <span class="comment">// 其实getOrDefaultExtension()方法只是组合了getExtension(name)和getDefaultExtension()两个public方法而已</span></span><br><span class="line">  getExtensionClasses(); </span><br><span class="line">  <span class="keyword">if</span> (StringUtils.isBlank(cachedDefaultName) || <span class="string">&quot;true&quot;</span>.equals(cachedDefaultName)) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 可以看到找到默认key后，实质最终也是用getExtension(name)查找的</span></span><br><span class="line">  <span class="keyword">return</span> getExtension(cachedDefaultName);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>注，cachedDefaultName  的值是在 loadExtensionClasses() 中的 cacheDefaultExtensionName() 确认的，其源码如下</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 从@SPI注解中得到默认key值</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">cacheDefaultExtensionName</span><span class="params">()</span> &#123;</span><br><span class="line">  <span class="comment">// 获取@SPI注解</span></span><br><span class="line">  <span class="keyword">final</span> <span class="type">SPI</span> <span class="variable">defaultAnnotation</span> <span class="operator">=</span> type.getAnnotation(SPI.class);</span><br><span class="line">  <span class="comment">// 没有指定注解</span></span><br><span class="line">  <span class="keyword">if</span> (defaultAnnotation == <span class="literal">null</span>) &#123; </span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 获取@SPI注解中的value值</span></span><br><span class="line">  <span class="type">String</span> <span class="variable">value</span> <span class="operator">=</span> defaultAnnotation.value();</span><br><span class="line">  <span class="comment">// value值不为空</span></span><br><span class="line">  <span class="keyword">if</span> ((value = value.trim()).length() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">    String[] names = NAME_SEPARATOR.split(value);</span><br><span class="line">    <span class="comment">// value值本身是String类型</span></span><br><span class="line">    <span class="comment">// 这里的意思是value值字符串不能存在&quot;,&quot;分隔符</span></span><br><span class="line">    <span class="keyword">if</span> (names.length &gt; <span class="number">1</span>) &#123;</span><br><span class="line">      <span class="comment">//...</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (names.length == <span class="number">1</span>) &#123;</span><br><span class="line">      cachedDefaultName = names[<span class="number">0</span>];</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="适配模式"><a href="#适配模式" class="headerlink" title="适配模式"></a>适配模式</h4><p><img src="/Dubbo-SPI%E6%9C%BA%E5%88%B6%E6%BA%90%E7%A0%81%E6%B5%85%E6%9E%90/003.png"></p>
<ul>
<li>Dubbo 内置的编译器有两种：JDK Compiler 和 Javasist Compiler</li>
</ul>
<p>getAdaptiveExtension() 方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 返回适配代理</span></span><br><span class="line"><span class="keyword">public</span> T <span class="title function_">getAdaptiveExtension</span><span class="params">()</span> &#123;</span><br><span class="line">  <span class="comment">// 先尝试从缓存中获取适配实现</span></span><br><span class="line">  <span class="type">Object</span> <span class="variable">instance</span> <span class="operator">=</span> cachedAdaptiveInstance.get();</span><br><span class="line">  <span class="comment">// 二次检测，以减少同步锁的判断</span></span><br><span class="line">  <span class="keyword">if</span> (instance == <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="keyword">synchronized</span> (cachedAdaptiveInstance) &#123;</span><br><span class="line">      instance = cachedAdaptiveInstance.get();</span><br><span class="line">      <span class="keyword">if</span> (instance == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">          <span class="comment">// 根据Class创建适配代理实例, 并将其缓存到cachedAdaptiveInstance中</span></span><br><span class="line">          instance = createAdaptiveExtension();</span><br><span class="line">          cachedAdaptiveInstance.set(instance);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">          <span class="comment">//...</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> (T) instance;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>createAdaptiveExtension() 方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> T <span class="title function_">createAdaptiveExtension</span><span class="params">()</span> &#123;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="comment">// 返回适配代理的Class并将其实例化</span></span><br><span class="line">    <span class="comment">// 如何有必要，则进行参数注入（针对非基本类型）</span></span><br><span class="line">    <span class="keyword">return</span> injectExtension((T) getAdaptiveExtensionClass().newInstance());</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// ..</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>getAdaptiveExtensionClass() 方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> Class&lt;?&gt; getAdaptiveExtensionClass() &#123;</span><br><span class="line">  <span class="comment">// 加载SPI实现</span></span><br><span class="line">  getExtensionClasses(); </span><br><span class="line">  <span class="keyword">if</span> (cachedAdaptiveClass != <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> cachedAdaptiveClass;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 创建Adaptive代理的源代码(.java)，并将其使用Compiler编译</span></span><br><span class="line">  <span class="type">return</span> <span class="variable">cachedAdaptiveClass</span> <span class="operator">=</span> createAdaptiveExtensionClass();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>createAdaptiveExtensionClass() 方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> Class&lt;?&gt; createAdaptiveExtensionClass() &#123;</span><br><span class="line">  <span class="comment">// 生成Java源码字</span></span><br><span class="line">  <span class="type">String</span> <span class="variable">code</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AdaptiveClassCodeGenerator</span>(type, cachedDefaultName).generate();</span><br><span class="line">  <span class="comment">// 获取类加载器</span></span><br><span class="line">  <span class="type">ClassLoader</span> <span class="variable">classLoader</span> <span class="operator">=</span> findClassLoader();</span><br><span class="line">  <span class="comment">// 对源码进行编译并加载到内存中（javassist）</span></span><br><span class="line">  org.apache.dubbo.common.compiler.<span class="type">Compiler</span> <span class="variable">compiler</span> <span class="operator">=</span> ExtensionLoader.getExtensionLoader(org.apache.dubbo.common.compiler.Compiler.class).getAdaptiveExtension();</span><br><span class="line">  <span class="keyword">return</span> compiler.compile(code, classLoader);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>以当前案例为例，根据 Person 扩展点所生产的适配代理源码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Person$Adaptive</span> <span class="keyword">implements</span> <span class="title class_">spi</span>.Person &#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">sayHi</span><span class="params">(org.apache.dubbo.common.URL arg0)</span> &#123;</span><br><span class="line">    <span class="comment">// 可以看到代理是不允许传入null值的</span></span><br><span class="line">    <span class="keyword">if</span> (arg0 == <span class="literal">null</span>) <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalArgumentException</span>(<span class="string">&quot;url == null&quot;</span>);</span><br><span class="line">    org.apache.dubbo.common.<span class="type">URL</span> <span class="variable">url</span> <span class="operator">=</span> arg0;</span><br><span class="line">    <span class="comment">// 从URL参数列表中获取active对应的值，如果没有则使用默认值</span></span><br><span class="line">    <span class="comment">// 默认值为@SPI的value值</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">extName</span> <span class="operator">=</span> url.getParameter(<span class="string">&quot;active&quot;</span>, <span class="string">&quot;student&quot;</span>);</span><br><span class="line">    <span class="comment">// 根据value值，再使用getExtensionLoader获取实现实例，如何执行目标方法</span></span><br><span class="line">    spi.<span class="type">Person</span> <span class="variable">extension</span> <span class="operator">=</span> (spi.Person) ExtensionLoader.getExtensionLoader(spi.Person.class).getExtension(extName);</span><br><span class="line">    extension.sayHi(arg0);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>injectExtension(T instance) 方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 给Adapter代理实例进行参数注入（IOC），如果有必要的话</span></span><br><span class="line"><span class="comment">// 如果你没忘记，Dubbo认为JDK SPI的缺点之一就是扩展性差，譬如无法注入Spring Bean</span></span><br><span class="line"><span class="comment">// 而该方法就是解决这一问题的</span></span><br><span class="line"><span class="keyword">private</span> T <span class="title function_">injectExtension</span><span class="params">(T instance)</span> &#123;</span><br><span class="line">  <span class="keyword">if</span> (objectFactory == <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> instance;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="comment">// 获取代理的所有方法</span></span><br><span class="line">    <span class="keyword">for</span> (Method method : instance.getClass().getMethods()) &#123;</span><br><span class="line">      <span class="comment">// 如果不是Setter，则跳过</span></span><br><span class="line">      <span class="keyword">if</span> (!isSetter(method)) &#123;</span><br><span class="line">        <span class="keyword">continue</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// 如果方法被@DisableInject注解，则跳过</span></span><br><span class="line">      <span class="keyword">if</span> (method.getAnnotation(DisableInject.class) != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">continue</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// 如果参数是基本数据类型（包含装箱类），则跳过</span></span><br><span class="line">      <span class="comment">// 这里只获取第一个参数是因为，Setter正常情况下只有1个参数</span></span><br><span class="line">      Class&lt;?&gt; pt = method.getParameterTypes()[<span class="number">0</span>];</span><br><span class="line">      <span class="keyword">if</span> (ReflectUtils.isPrimitives(pt)) &#123;</span><br><span class="line">        <span class="keyword">continue</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// 根据属性Setter方法名称，返回字段的名称（既去除set前三个字符）</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">property</span> <span class="operator">=</span> getSetterProperty(method);</span><br><span class="line">        <span class="comment">// 根据字段在实际扩展实现中得到对应的值</span></span><br><span class="line">        <span class="type">Object</span> <span class="variable">object</span> <span class="operator">=</span> objectFactory.getExtension(pt, property);</span><br><span class="line">        <span class="keyword">if</span> (object != <span class="literal">null</span>) &#123;</span><br><span class="line">          <span class="comment">// 将其注入到代理中</span></span><br><span class="line">          method.invoke(instance, object);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        <span class="comment">//...</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> instance;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="激活模式"><a href="#激活模式" class="headerlink" title="激活模式"></a>激活模式</h4><p><img src="/Dubbo-SPI%E6%9C%BA%E5%88%B6%E6%BA%90%E7%A0%81%E6%B5%85%E6%9E%90/004.png"></p>
<p>getActivateExtension(URL url, String[] values, String group) 方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 根据条件来激活扩展实现</span></span><br><span class="line"><span class="comment">// 参数1：URL条件信息</span></span><br><span class="line"><span class="comment">// 参数2：必须激活的实现</span></span><br><span class="line"><span class="comment">// 参数3：组的名称，以组的形式激活一个或多个实现</span></span><br><span class="line"><span class="keyword">public</span> List&lt;T&gt; <span class="title function_">getActivateExtension</span><span class="params">(URL url, String[] values, String group)</span> &#123;</span><br><span class="line">  List&lt;T&gt; activateExtensions = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">  List&lt;String&gt; names = values == <span class="literal">null</span> ? <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;(<span class="number">0</span>) : asList(values); <span class="comment">//</span></span><br><span class="line">  <span class="keyword">if</span> (!names.contains(REMOVE_VALUE_PREFIX + DEFAULT_KEY)) &#123; <span class="comment">// REMOVE_VALUE_PREFIX=-,DEFAULT_KEY=default</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 加载SPI扩展实现</span></span><br><span class="line">    getExtensionClasses();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 激活筛选逻辑</span></span><br><span class="line">    <span class="keyword">for</span> (Map.Entry&lt;String, Object&gt; entry : cachedActivates.entrySet()) &#123;</span><br><span class="line">      <span class="type">String</span> <span class="variable">name</span> <span class="operator">=</span> entry.getKey(); <span class="comment">// 实现的key值</span></span><br><span class="line">      <span class="type">Object</span> <span class="variable">activate</span> <span class="operator">=</span> entry.getValue(); <span class="comment">// @Activate注解对象</span></span><br><span class="line">      String[] activateGroup, activateValue; <span class="comment">// @Activate注解中的值</span></span><br><span class="line">      <span class="comment">// 获取@Activate注解中的value值和group值</span></span><br><span class="line">      <span class="keyword">if</span> (activate <span class="keyword">instanceof</span> Activate) &#123; <span class="comment">// 新注解</span></span><br><span class="line">        activateGroup = ((Activate) activate).group(); <span class="comment">// group值</span></span><br><span class="line">        activateValue = ((Activate) activate).value(); <span class="comment">// value值</span></span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (activate <span class="keyword">instanceof</span> com.alibaba.dubbo.common.extension.Activate) &#123; <span class="comment">// 旧注解</span></span><br><span class="line">        activateGroup = ((com.alibaba.dubbo.common.extension.Activate) activate).group();</span><br><span class="line">        activateValue = ((com.alibaba.dubbo.common.extension.Activate) activate).value();</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">continue</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (isMatchGroup(group, activateGroup) <span class="comment">// 根据group参数激活，如果没有指定group则默认返回true</span></span><br><span class="line">          &amp;&amp; !names.contains(name)</span><br><span class="line">          &amp;&amp; !names.contains(REMOVE_VALUE_PREFIX + name)</span><br><span class="line">          &amp;&amp; isActive(activateValue, url)) &#123; <span class="comment">// 根据URL激活，如果没有指定URL则默认返回true</span></span><br><span class="line">        <span class="comment">// 加载实现并将其实例对象暂存到activateExtensions中</span></span><br><span class="line">        activateExtensions.add(getExtension(name));</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    activateExtensions.sort(ActivateComparator.COMPARATOR);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 加载必须的实现</span></span><br><span class="line">  List&lt;T&gt; loadedExtensions = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">  <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; names.size(); i++) &#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">name</span> <span class="operator">=</span> names.get(i);</span><br><span class="line">    <span class="keyword">if</span> (!name.startsWith(REMOVE_VALUE_PREFIX)</span><br><span class="line">        &amp;&amp; !names.contains(REMOVE_VALUE_PREFIX + name)) &#123;</span><br><span class="line">      <span class="keyword">if</span> (DEFAULT_KEY.equals(name)) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!loadedExtensions.isEmpty()) &#123;</span><br><span class="line">          activateExtensions.addAll(<span class="number">0</span>, loadedExtensions);</span><br><span class="line">          loadedExtensions.clear();</span><br><span class="line">        &#125;</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        loadedExtensions.add(getExtension(name));</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (!loadedExtensions.isEmpty()) &#123;</span><br><span class="line">    activateExtensions.addAll(loadedExtensions);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 返回激活了的实现实例集合</span></span><br><span class="line">  <span class="keyword">return</span> activateExtensions;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>cacheActivateClass(Class&lt;?&gt; clazz, String name) 方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 缓存带有@Activate注解的实现</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">cacheActivateClass</span><span class="params">(Class&lt;?&gt; clazz, String name)</span> &#123;</span><br><span class="line">  <span class="comment">// 获取当前扩展类的@Activate注解</span></span><br><span class="line">  <span class="type">Activate</span> <span class="variable">activate</span> <span class="operator">=</span> clazz.getAnnotation(Activate.class);</span><br><span class="line">  <span class="keyword">if</span> (activate != <span class="literal">null</span>) &#123;</span><br><span class="line">    cachedActivates.put(name, activate);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// 如果新注解没有，则检查是否有用到旧注解，旧注解包名包含为alibaba，新注解为apache</span></span><br><span class="line">    <span class="comment">// support com.alibaba.dubbo.common.extension.Activate</span></span><br><span class="line">    com.alibaba.dubbo.common.extension.<span class="type">Activate</span> <span class="variable">oldActivate</span> <span class="operator">=</span> clazz.getAnnotation(com.alibaba.dubbo.common.extension.Activate.class);</span><br><span class="line">    <span class="keyword">if</span> (oldActivate != <span class="literal">null</span>) &#123;</span><br><span class="line">      cachedActivates.put(name, oldActivate);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><ul>
<li><a target="_blank" rel="noopener" href="http://dubbo.apache.org/zh-cn/blog/introduction-to-dubbo-spi.html">Dubbo可扩展机制实战</a></li>
</ul>

  </div>
  
    
      <a id="older" class="blog-nav" href="/IDEA%E6%80%A7%E8%83%BD%E8%B0%83%E4%BC%98%E5%B0%8F%E8%AE%B0/">OLDER&nbsp;&gt;</a>
      
        
          <a id="newer" class="blog-nav" href="/SpringMVC%E5%86%8D%E5%85%A5%E9%97%A8/">&lt;&nbsp;NEWER</a>
          
            
</div>
        <div class="footer">
  
    <div class="footer-more">
      
        <a href="/"><em style="color:red;">新站点正在开发中，网站暂停更新。</em></a>
        
    </div>
  
    <div class="footer-more">
      
        <a href="/">Copyright © DeeTam 2022</a>
        
    </div>
  
</div>

      </div>

      <div class="back-to-top hidden">
  <a href="javascript: void(0)">
    <i class="iconfont icon-chevronup"></i>
  </a>
</div>


<script src="/js/backtotop.js"></script>



      
  <div class="search-icon" id="search-icon">
    <a href="javascript: void(0)">
      <i class="iconfont icon-search"></i>
    </a>
  </div>

  <div class="search-overlay hidden">
    <div class="search-content" tabindex="0">
      <div class="search-box">
        <div class="search-title">
          <!-- <span class="search-icon-input">
            <a href="javascript: void(0)">
              <i class="iconfont icon-search"></i>
            </a>
          </span> -->
          
            <input type="text" class="search-input" id="search-input" placeholder="搜索...">
          
          <span class="search-close-icon" id="search-close-icon">
            <a href="javascript: void(0)">
              <i class="iconfont icon-close"></i>
            </a>
          </span>
        </div>
        <div class="search-result" id="search-result"></div>
      </div>
    </div>
  </div>

  <script type="text/javascript">
    var inputArea = document.querySelector("#search-input")
    var searchOverlayArea = document.querySelector(".search-overlay")

    // inputArea.onclick = function() {
    //   getSearchFile()
    //   this.onclick = null
    // }

    inputArea.onkeydown = function() {
      if(event.keyCode == 13)
        return false
    }

    function openOrHideSearchContent() {
      let isHidden = searchOverlayArea.classList.contains('hidden')
      if (isHidden) {
        searchOverlayArea.classList.remove('hidden')
        document.body.classList.add('hidden')
        inputArea.focus()
        getSearchFile()
      } else {
        searchOverlayArea.classList.add('hidden')
        document.body.classList.remove('hidden')
      }
    }

    function blurSearchContent(e) {
      if (e.target === searchOverlayArea) {
        openOrHideSearchContent()
      }
    }

    document.querySelector("#search-icon").addEventListener("click", openOrHideSearchContent, false)
    document.querySelector("#search-close-icon").addEventListener("click", openOrHideSearchContent, false)
    searchOverlayArea.addEventListener("click", blurSearchContent, false)

    var searchFunc = function (path, search_id, content_id) {
      'use strict';
      var $input = document.getElementById(search_id);
      var $resultContent = document.getElementById(content_id);
      $resultContent.innerHTML = "<ul><span class='local-search-empty'><span></ul>";
      // $resultContent.innerHTML = "<ul><span class='local-search-empty'>首次搜索，正在载入索引文件，请稍后……<span></ul>";
      $.ajax({
        // 0x01. load xml file
        url: path,
        dataType: "xml",
        success: function (xmlResponse) {
          // 0x02. parse xml file
          var datas = $("entry", xmlResponse).map(function () {
            return {
              title: $("title", this).text(),
              content: $("content", this).text(),
              url: $("url", this).text()
            };
          }).get();
          $resultContent.innerHTML = "";

          $input.addEventListener('input', function () {
            // 0x03. parse query to keywords list
            var str = '<ul class=\"search-result-list\">';
            var keywords = this.value.trim().toLowerCase().split(/[\s\-]+/);
            $resultContent.innerHTML = "";
            if (this.value.trim().length <= 0) {
              return;
            }
            // 0x04. perform local searching
            datas.forEach(function (data) {
              var isMatch = true;
              var content_index = [];
              if (!data.title || data.title.trim() === '') {
                data.title = "Untitled";
              }
              var orig_data_title = data.title.trim();
              var data_title = orig_data_title.toLowerCase();
              var orig_data_content = data.content.trim().replace(/<[^>]+>/g, "");
              var data_content = orig_data_content.toLowerCase();
              var data_url = data.url;
              var index_title = -1;
              var index_content = -1;
              var first_occur = -1;
              // only match artiles with not empty contents
              if (data_content !== '') {
                keywords.forEach(function (keyword, i) {
                  index_title = data_title.indexOf(keyword);
                  index_content = data_content.indexOf(keyword);

                  if (index_title < 0 && index_content < 0) {
                    isMatch = false;
                  } else {
                    if (index_content < 0) {
                      index_content = 0;
                    }
                    if (i == 0) {
                      first_occur = index_content;
                    }
                    // content_index.push({index_content:index_content, keyword_len:keyword_len});
                  }
                });
              } else {
                isMatch = false;
              }
              // 0x05. show search results
              if (isMatch) {
                str += "<li><a href='/" + data_url + "' class='search-result-title'><h2>" + orig_data_title + "</h2></a>";
                var content = orig_data_content;
                if (first_occur >= 0) {
                  // cut out 100 characters
                  var start = first_occur - 20;
                  var end = first_occur + 80;

                  if (start < 0) {
                    start = 0;
                  }

                  if (start == 0) {
                    end = 100;
                  }

                  if (end > content.length) {
                    end = content.length;
                  }

                  var match_content = content.substr(start, end);

                  // highlight all keywords
                  keywords.forEach(function (keyword) {
                    var regS = new RegExp(keyword, "gi");
                    match_content = match_content.replace(regS, "<span class=\"search-keyword\">" + keyword + "</span>");
                  });

                  str += "<h3 class=\"search-result-abstract\">" + match_content + "...</h3>"
                }
                str += "<hr></li>";
              }
            });
            str += "</ul>";
            if (str.indexOf('<li>') === -1) {
              return $resultContent.innerHTML = "<ul><span class='local-search-empty'>没有找到内容，请尝试更换检索词。<span></ul>";
            }
            $resultContent.innerHTML = str;
          });
        },
        error: function(xhr, status, error) {
          $resultContent.innerHTML = ""
          if (xhr.status === 404) {
            $resultContent.innerHTML = "<ul><span class='local-search-empty'>未找到search.xml文件，具体请参考：<a href='https://github.com/leedom92/hexo-theme-leedom#configuration' target='_black'>configuration</a><span></ul>";
          } else {
            $resultContent.innerHTML = "<ul><span class='local-search-empty'>请求失败，尝试重新刷新页面或稍后重试。<span></ul>";
          }
        }
      });
      $(document).on('click', '#search-close-icon', function() {
        $('#search-input').val('');
        $('#search-result').html('');
      });
    }

    var getSearchFile = function() {
        var path = "/search.xml";
        searchFunc(path, 'search-input', 'search-result');
    }
  </script>




    </div>
  </body>
</html>

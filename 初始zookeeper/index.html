<!DOCTYPE html>
<html lang="zh-CN">

  <head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="keywords" content="" />
  <meta name="author" content="DeeTam" />
  <meta name="description" content="学然后知不足" />
  
  
  <title>
    
      初识ZooKeeper 
      
      
    
  </title>

  
    <link rel="apple-touch-icon" href="/images/favicon.png">
    <link rel="icon" href="/images/favicon.png">
  

  <!-- Raleway-Font -->
  <link href="https://fonts.googleapis.com/css?family=Montserrat|Roboto:400,400italic,600|Roboto+Mono" rel="stylesheet">

  <!-- hexo site css -->
  
<link rel="stylesheet" href="/css/base.css">
<link rel="stylesheet" href="/css/common.css">
<link rel="stylesheet" href="/iconfont/iconfont.css">


  

  
    
<link rel="stylesheet" href="/css/post.css">

  

  <!-- jquery3.3.1 -->
  <script src="https://cdn.bootcss.com/jquery/3.3.1/jquery.min.js"></script>

  <!-- fancybox -->
  <link href="https://cdn.bootcss.com/fancybox/3.5.2/jquery.fancybox.min.css" rel="stylesheet">
  <script async src="https://cdn.bootcss.com/fancybox/3.5.2/jquery.fancybox.min.js"></script>
  
<script src="/js/fancybox.js"></script>


<meta name="generator" content="Hexo 6.3.0"></head>


  <body>
    <div id="app">
      <div class="header">
  <a href="/">DEE TAM</a>
</div>


      <p class="links">
  
    <a title="归档" target="" href="/archives/">
      <i class="iconfont icon-bookmark"></i>
    </a>
  
    <a title="邮箱" target="" href="mailto:oomgomgxx@gmail.com">
      <i class="iconfont icon-envelope"></i>
    </a>
  
    <a title="QQ" target="" href="tencent://message/?Menu=yes&uin=0x1DACE601&Service=300&sigT=45a1e5847943b64c6ff3990f8a9e644d2b31356cb0b4ac6b24663a3c8dd0f8aa12a595b1714f9d45">
      <i class="iconfont icon-qq"></i>
    </a>
  
    <a title="关于" target="" href="/about/">
      <i class="iconfont icon-emoji-friendly"></i>
    </a>
  
</p>


      <div class="main">
        <!-- 文章详情页，展示文章具体内容，url形式：https://yoursite/文章标题/ -->
<!-- 同时为「标签tag」，「朋友friend」，「分类categories」，「关于about」页面的承载页面，具体展示取决于page.type -->

<!-- LaTex Display -->
<script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
<script type="text/javascript" id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js">
</script>
<script>
  MathJax = {
    tex: {
      inlineMath: [['$', '$'], ['\\(', '\\)']]
    }
  };
</script>

<div class="post">
  
  <!--
  
    <h3 class="date">
    Aug 14, 2017
  </h3>
  
  -->

  
  <center>
    <h1>
      初识ZooKeeper
    </h1>
  </center>
  

  <div class="content markdown-body">
    <h2 id="内容修订"><a href="#内容修订" class="headerlink" title="内容修订"></a>内容修订</h2><ul>
<li>2019年7月09日08:40:40 — 迁移ZAB协议相关内容到<a target="_blank" rel="noopener" href="https://tandi.pub/%E5%88%86%E5%B8%83%E5%BC%8F%E7%9A%84%E4%B8%80%E8%87%B4%E6%80%A7%E5%92%8C%E5%85%B1%E8%AF%86%E6%80%A7/">分布式的一致性和共识性</a></li>
<li>2020年9月02日16:55:12 — 增加 3.5.0 版本后配置改动相关内容</li>
</ul>
<h2 id="基本介绍"><a href="#基本介绍" class="headerlink" title="基本介绍"></a>基本介绍</h2><blockquote>
<p>简介</p>
</blockquote>
<ul>
<li>Zookeeper 是一个分布式协调服务。简单说就是可以利用 Zookeeper 的数据特点来协调分布式服务运行。譬如 Dobbo 利用 Zookeeper 提供的命名服务（既DNS服务）来实现服务的注册和发现</li>
<li>保证节点状态一致性优先的前提下，Zookeeper 集群只要过半节点能够通信就能正常提供服务</li>
<li>Zookeeper 在内存中存储的数据模型叫 Data Tree ，实质就是和文件系统目录结构一样呈现树状。在 Data Tree 上的节点被称为 ZNode ，ZNode 除了保存子节点之外，自身还可以存储数据，而且带有Version版本号等元数据信息</li>
<li>Zookeeper 并不适合存储大量数据。也就是说数据应该尽量少，而且这些数据对于分布式服务协调来说是至关重要的</li>
<li>Zookeeper 并不适合高并发写的场景。这是因为写操作只能在 Leader 节点上进行，除此之外 Leader 节点在处理一个写请求的同时，当前 Leader 节点是不能再处理其它读写请求的，因为它是（会话）串行(FIFO形式)处理请求的，所以 Zookeeper 相当于降低了系统的可用性来提高一致性。这也是为什么 Kafka 不再使用 Zookeeper 来保存消费者偏移量的原因，因为消费者提交偏移量是一个非常频繁的写操作</li>
<li>在 Zookeeper 中，同一个会话的操作是先进先出（FIFO）按顺序被操作的</li>
</ul>
<blockquote>
<p>Data Tree</p>
</blockquote>
<p><img src="/%E5%88%9D%E5%A7%8Bzookeeper/005.png"></p>
<h2 id="安装ZooKeeper"><a href="#安装ZooKeeper" class="headerlink" title="安装ZooKeeper"></a>安装ZooKeeper</h2><blockquote>
<p>ZooKeeper 使用 Java 开发，所以应该先安装和配置好 Java 环境</p>
</blockquote>
<p>ZooKeeper安装：<a target="_blank" rel="noopener" href="https://www.apache.org/dyn/closer.cgi/zookeeper/">官网下载地址</a></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost opt]# wget http://mirror.bit.edu.cn/apache/zookeeper/zookeeper-3.4.14/zookeeper-3.4.14.tar.gz </span><br></pre></td></tr></table></figure>

<p>解压后目录如下：<br><img src="/%E5%88%9D%E5%A7%8Bzookeeper/001.png"><br><img src="/%E5%88%9D%E5%A7%8Bzookeeper/002.png"></p>
<h2 id="基本使用"><a href="#基本使用" class="headerlink" title="基本使用"></a>基本使用</h2><h3 id="启动server"><a href="#启动server" class="headerlink" title="启动server"></a>启动server</h3><p>如果启动时不指定配置文件，则默认使用 conf 文件夹下名为 <code>zoo.cfg</code> 的配置文件</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost zookeeper-3.4.14]# bin/zkServer.sh start conf/zoo_sample.cfg</span><br><span class="line">[root@localhost zookeeper-3.4.14]# jps -l</span><br><span class="line">31623 org.apache.zookeeper.server.quorum.QuorumPeerMain</span><br><span class="line">31640 sun.tools.jps.Jps</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">可以从输出信息中看到 zookeeper.server 已经成功启动</span></span><br></pre></td></tr></table></figure>

<h3 id="启动client"><a href="#启动client" class="headerlink" title="启动client"></a>启动client</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost zookeeper-3.4.14]# bin/zkCli.sh -server 127.0.0.1:2181 </span><br></pre></td></tr></table></figure>

<h3 id="操作命令"><a href="#操作命令" class="headerlink" title="操作命令"></a>操作命令</h3><p>可以随便输入一些内容，只要不是命令，就会输出命令说明。</p>
<blockquote>
<p>常用命令如下</p>
</blockquote>
<p>节点命令</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">ls [-s] [-w] [-R] path # 列出路径中的节点,-w表示加上一个监听器</span><br><span class="line">ls2 path [watch] # 列出路径中的节点和节点的状态</span><br><span class="line">stat [-w] path # 打印节点状态,-w表示加上一个监听器</span><br><span class="line">create [-s] [-e] [-c] [-t ttl] path [data] [acl] # 创建节点，-e临时节点，-s顺序节点</span><br><span class="line">set [-s] [-v version] path data # 设置节点值</span><br><span class="line">get [-s] [-w] path # 返回节点值,-w表示加上一个监听器</span><br><span class="line">delete [-v version] path # 删除节点</span><br><span class="line">deleteall path # 删除所有节点,用来代替rmr（rmr在新版本中已经标注为过时）</span><br><span class="line">sync path # 节点同步</span><br></pre></td></tr></table></figure>

<p>acl机制命令</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">addauth scheme auth # 创建认证策略并指定权限</span><br><span class="line">setAcl [-s] [-v version] [-R] path acl # 设置节点访问权限</span><br><span class="line">getAcl [-s] path # 返回节点的权限</span><br></pre></td></tr></table></figure>

<p>quota机制命令</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">listquota path # 列出节点quota</span><br><span class="line">setquota -n|-b val path # 设置节点的quota限定，-n 节点个数，-b 节点大小</span><br><span class="line">delquota [-n|-b] path # 删除节点的quota限定</span><br></pre></td></tr></table></figure>

<p>watcher命令</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">printwatches on|off </span><br><span class="line">removewatches path [-c|-d|-a] [-l]</span><br></pre></td></tr></table></figure>

<p>行为命令</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">history # 显示使用过的命令</span><br><span class="line">redo cmdno # 可以根据history查询出来的命令编号重新调用这些命令</span><br><span class="line">close # 断开当前的服务端连接</span><br><span class="line">quit # 退出当前客户端</span><br><span class="line">connect host:port # 重新接连到其他的服务端</span><br></pre></td></tr></table></figure>


<h2 id="关于节点（ZNode）"><a href="#关于节点（ZNode）" class="headerlink" title="关于节点（ZNode）"></a>关于节点（ZNode）</h2><blockquote>
<p>注：</p>
<ul>
<li>一个 ZNode 默认最多能存 1M 大小的数据</li>
<li>可通过  jute.maxbuffer 配置修改，值的单位是字节（ 默认值为 1048575）</li>
</ul>
</blockquote>
<h3 id="节点类型"><a href="#节点类型" class="headerlink" title="节点类型"></a>节点类型</h3><p><strong>zookeeper节点的基本类型：</strong></p>
<ol>
<li>持久(persistent)节点</li>
<li>临时(ephemeral)节点（会话级别）</li>
<li>顺序节点</li>
</ol>
<p><strong>组合节点类型：</strong></p>
<ol>
<li>持久(persistent)节点</li>
<li>临时(ephemeral)节点</li>
<li>持久顺序节点</li>
<li>临时顺序节点</li>
</ol>
<h3 id="节点操作"><a href="#节点操作" class="headerlink" title="节点操作"></a>节点操作</h3><p><strong>创建持久节点（默认）</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[zk: localhost:2181(CONNECTED) 13] create /zookeeper/person &#x27;p1&#x27;</span><br><span class="line">[zk: localhost:2181(CONNECTED) 14] stat /zookeeper/person</span><br><span class="line">cZxid = 0x12	#节点创建时的zxid</span><br><span class="line">ctime = Mon Aug 12 05:09:56 CST 2019	#节点创时间</span><br><span class="line">mZxid = 0x12	#节点修改时的zxid</span><br><span class="line">mtime = Mon Aug 12 05:09:56 CST 2019	#节点最后一次修改的时间</span><br><span class="line">pZxid = 0x12	#子节点最近一次创建/删除的zxid</span><br><span class="line">cversion = 0	#子节点的更新次数（乐观锁version）</span><br><span class="line">dataVersion = 0	#节点数据的更新次数（乐观锁version）</span><br><span class="line">aclVersion = 0	#节点acl的更新次数（乐观锁version）</span><br><span class="line">ephemeralOwner = 0x0	#是否为临时节点，0为false,非0为true</span><br><span class="line">dataLength = 2	#节点数据长度（字节）</span><br><span class="line">numChildren = 0 #字节点个数</span><br></pre></td></tr></table></figure>

<p><strong>创建临时节点（会话结束自动删除）</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[zk: localhost:2181(CONNECTED) 0] create -e /zookeeper/person2 &#x27;p2&#x27;</span><br><span class="line">[zk: localhost:2181(CONNECTED) 1] stat /zookeeper/person2</span><br><span class="line">cZxid = 0x15</span><br><span class="line">ctime = Mon Aug 12 05:18:38 CST 2019</span><br><span class="line">mZxid = 0x15</span><br><span class="line">mtime = Mon Aug 12 05:18:38 CST 2019</span><br><span class="line">pZxid = 0x15</span><br><span class="line">cversion = 0</span><br><span class="line">dataVersion = 0</span><br><span class="line">aclVersion = 0</span><br><span class="line">ephemeralOwner = 0x10004ee71460002 #非0就是临时节点</span><br><span class="line">dataLength = 2</span><br><span class="line">numChildren = 0</span><br></pre></td></tr></table></figure>

<p><strong>创建顺序节点</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[zk: localhost:2181(CONNECTED) 6] create -s /zookeeper/person3 &#x27;p3&#x27;</span><br><span class="line">Created /zookeeper/person30000000007 # 创建顺序节点时最会在节点名字后添加顺序后续</span><br><span class="line">[zk: localhost:2181(CONNECTED) 8] create -s /zookeeper/person4 &#x27;p4&#x27;</span><br><span class="line">Created /zookeeper/person40000000008 # 可以看到后续是有序递增的</span><br></pre></td></tr></table></figure>

<p><strong>删除节点</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[zk: localhost:2181(CONNECTED) 12] delete /zookeeper/person30000000007</span><br><span class="line">[zk: localhost:2181(CONNECTED) 14] deleteall /zookeeper/person40000000008</span><br></pre></td></tr></table></figure>


<h3 id="acl策略"><a href="#acl策略" class="headerlink" title="acl策略"></a>acl策略</h3><p><strong>作用：</strong>对节点进行访问控制</p>
<p><strong>使用说明</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[支持的认证策略]</span><br><span class="line">world：默认，所有会话可以访问</span><br><span class="line">auth：auth策略。使用前需要先用 authadd 添加认证策略</span><br><span class="line">digest：用户密码策略。会话访问节点时需要正确的用户和密码</span><br><span class="line">ip：ip绑定策略。会话访问节点时需要是特定的IP才能访问</span><br><span class="line"></span><br><span class="line">[支持的访问权限（默认crwda，表示有所有操作权限）]</span><br><span class="line">CREATE： 创建</span><br><span class="line">READ： 读取</span><br><span class="line">WRITE： 写入</span><br><span class="line">DELETE： 删除</span><br><span class="line">ADMIN： 管理</span><br></pre></td></tr></table></figure>

<p><strong>acl策略使用</strong></p>
<p>1）ip模式</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">create /test ip:<span class="number">127.0</span>.<span class="number">0.1</span>:crwda</span><br></pre></td></tr></table></figure>

<p>2）digest模式</p>
<blockquote>
<p>注意：设置节点的 digest 时，需要对密码部分进行编码。</p>
<p>使用 org.apache.zookeeper.server.auth.DigestAuthenticationProvider ，譬如：</p>
<p>java -cp .&#x2F;lib&#x2F;<em>:.&#x2F;</em> org.apache.zookeeper.server.auth.DigestAuthenticationProvider 账号:密码 </p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">create /test/t3 &#x27;t3&#x27;</span><br><span class="line">setAcl /test/t3 digest:test:V28q/NynI4JI3Rk54h0r8O5kMug=:crwda</span><br><span class="line">addauth digest test:test</span><br></pre></td></tr></table></figure>

<p>3）auth模式</p>
<blockquote>
<p>auth 和 digest 差不多，但 auth 模式需要先使用 addauth 添加权限再操作，其次是 auth 模式下无需对密码进行编码</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">addauth digest aaa:aaa</span><br><span class="line">setAcl /test/t4 auth:aaa:aaa:crwda</span><br></pre></td></tr></table></figure>


<h3 id="quota策略"><a href="#quota策略" class="headerlink" title="quota策略"></a>quota策略</h3><p>作用：给节点设置配额限制</p>
<blockquote>
<p>重点注意：设置-n后并不是如我们所愿zookeeper会阻止节点的创建，实质只会超额后发出警告</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">[zk: localhost:2181(CONNECTED) 20] create /test/t7 &#x27;t7&#x27;</span><br><span class="line">[zk: localhost:2181(CONNECTED) 21] setquota -b 10 /test/t7</span><br><span class="line">[zk: localhost:2181(CONNECTED) 22] setquota -n 2 /test/t7</span><br><span class="line">[zk: localhost:2181(CONNECTED) 23] listquota /test/t7</span><br><span class="line">absolute path is /zookeeper/quota/test/t7/zookeeper_limits</span><br><span class="line">Output quota for /test/t7 count=2,bytes=-1</span><br><span class="line">Output stat for /test/t7 count=5,bytes=2</span><br><span class="line"></span><br><span class="line">[zk: localhost:2181(CONNECTED) 25] stat /test/t7</span><br><span class="line">cZxid = 0x20</span><br><span class="line">ctime = Tue Aug 13 07:42:04 CST 2019</span><br><span class="line">mZxid = 0x20</span><br><span class="line">mtime = Tue Aug 13 07:42:04 CST 2019</span><br><span class="line">pZxid = 0x28</span><br><span class="line">cversion = 4</span><br><span class="line">dataVersion = 0</span><br><span class="line">aclVersion = 0</span><br><span class="line">ephemeralOwner = 0x0</span><br><span class="line">dataLength = 2 长度为2个字节</span><br><span class="line">numChildren = 4</span><br></pre></td></tr></table></figure>


<h2 id="客户端"><a href="#客户端" class="headerlink" title="客户端"></a>客户端</h2><p>除了开源的zkClient客户端之外，Java方面还有 zookeeper 和 curator 两个API</p>
<h3 id="zookeeper"><a href="#zookeeper" class="headerlink" title="zookeeper"></a>zookeeper</h3><h4 id="依赖"><a href="#依赖" class="headerlink" title="依赖"></a>依赖</h4><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.zookeeper<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>zookeeper<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.4.6<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h4 id="缺点"><a href="#缺点" class="headerlink" title="缺点"></a>缺点</h4><ul>
<li>watcher无法复用</li>
<li>没有提供连接失败重试的实现</li>
<li>没有提供创建多级节点的实现</li>
</ul>
<h4 id="基本使用-1"><a href="#基本使用-1" class="headerlink" title="基本使用"></a>基本使用</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TestZookeeper</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Logger</span> <span class="variable">LOGGER</span> <span class="operator">=</span> LoggerFactory.getLogger(TestZookeeper.class);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 因为Zookeeper连接操作时异步的，所以需要等待其连接成功后，否则主线程会先关闭</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">CountDownLatch</span> <span class="variable">countDownLatch</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CountDownLatch</span>(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> ZooKeeper <span class="title function_">connect</span><span class="params">(String server, <span class="type">int</span> timeout, Watcher watcher)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ZooKeeper</span>(<span class="string">&quot;127.0.0.1:2181&quot;</span>, <span class="number">20000</span>, watcher);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line"></span><br><span class="line">        <span class="type">Watcher</span> <span class="variable">masterWatcher</span> <span class="operator">=</span> watchedEvent -&gt; &#123;</span><br><span class="line">            <span class="comment">// 判断连接状态</span></span><br><span class="line">            <span class="keyword">if</span> (watchedEvent.getState() == Watcher.Event.KeeperState.SyncConnected) &#123;</span><br><span class="line">                LOGGER.info(<span class="string">&quot;连接成功&quot;</span>);</span><br><span class="line">                countDownLatch.countDown();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="type">Watcher</span> <span class="variable">createWatcher</span> <span class="operator">=</span> watchedEvent -&gt; &#123;</span><br><span class="line">            <span class="comment">// 判断操作类型</span></span><br><span class="line">            <span class="keyword">if</span> (watchedEvent.getType() == Watcher.Event.EventType.NodeCreated) &#123;</span><br><span class="line">                LOGGER.info(<span class="string">&quot;创建节点成功&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="type">ZooKeeper</span> <span class="variable">zooKeeper</span> <span class="operator">=</span> connect(<span class="string">&quot;127.0.0.1:2181&quot;</span>, <span class="number">5000</span>, masterWatcher);</span><br><span class="line">        countDownLatch.await();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 根节点</span></span><br><span class="line">        <span class="keyword">if</span> (zooKeeper.exists(<span class="string">&quot;/test&quot;</span>, createWatcher) == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="comment">// 创建所有会话可操作的持久化节点</span></span><br><span class="line">            zooKeeper.create(<span class="string">&quot;/test&quot;</span>, <span class="literal">null</span>, ZooDefs.Ids.OPEN_ACL_UNSAFE, CreateMode.PERSISTENT);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 创建临时节点</span></span><br><span class="line">        zooKeeper.create(<span class="string">&quot;/test/t1&quot;</span>, <span class="string">&quot;t1&quot;</span>.getBytes(), ZooDefs.Ids.OPEN_ACL_UNSAFE, CreateMode.EPHEMERAL);</span><br><span class="line">        zooKeeper.create(<span class="string">&quot;/test/t2&quot;</span>, <span class="string">&quot;t2&quot;</span>.getBytes(), ZooDefs.Ids.OPEN_ACL_UNSAFE, CreateMode.EPHEMERAL);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 添加认证</span></span><br><span class="line">        zooKeeper.addAuthInfo(<span class="string">&quot;digest&quot;</span>, <span class="string">&quot;aaa:aaa&quot;</span>.getBytes());</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 设置acl - digest</span></span><br><span class="line">        List&lt;ACL&gt; digest = TestZookeeper.getAcls(<span class="string">&quot;digest&quot;</span>, DigestAuthenticationProvider.generateDigest(<span class="string">&quot;aaa:aaa&quot;</span>));</span><br><span class="line">        <span class="comment">// version是乐观所的期望值，如果与zookeeper中的不一直则会操作失败,当版本号设置为-1时，忽略节点的版本号</span></span><br><span class="line">        <span class="type">Stat</span> <span class="variable">stat</span> <span class="operator">=</span> zooKeeper.setACL(<span class="string">&quot;/test/t1&quot;</span>, digest, -<span class="number">1</span>);</span><br><span class="line">        LOGGER.info(zooKeeper.getACL(<span class="string">&quot;/test/t1&quot;</span>, stat).toString());</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 设置acl - ip</span></span><br><span class="line">        List&lt;ACL&gt; ip = TestZookeeper.getAcls(<span class="string">&quot;ip&quot;</span>, <span class="string">&quot;127.0.0.1&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">Stat</span> <span class="variable">t2Stat</span> <span class="operator">=</span> zooKeeper.exists(<span class="string">&quot;/test/t2&quot;</span>, <span class="literal">null</span>);</span><br><span class="line">        t2Stat = zooKeeper.setACL(<span class="string">&quot;/test/t2&quot;</span>, ip, t2Stat.getVersion());</span><br><span class="line">        LOGGER.info(zooKeeper.getACL(<span class="string">&quot;/test/t2&quot;</span>, t2Stat).toString());</span><br><span class="line">        <span class="type">byte</span>[] data = zooKeeper.getData(<span class="string">&quot;/test/t2&quot;</span>, <span class="literal">null</span>, t2Stat);</span><br><span class="line">        LOGGER.info(<span class="keyword">new</span> <span class="title class_">String</span>(data));</span><br><span class="line"></span><br><span class="line">        TimeUnit.SECONDS.sleep(<span class="number">10</span>);</span><br><span class="line">        zooKeeper.delete(<span class="string">&quot;/test/t1&quot;</span>, -<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">        TimeUnit.SECONDS.sleep(<span class="number">30</span>);</span><br><span class="line">        zooKeeper.close();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> List&lt;ACL&gt; <span class="title function_">getAcls</span><span class="params">(String scheme, String id)</span> &#123;</span><br><span class="line">        <span class="type">ACL</span> <span class="variable">auth</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ACL</span>(ZooDefs.Perms.ALL, <span class="keyword">new</span> <span class="title class_">Id</span>(scheme, id));</span><br><span class="line">        <span class="keyword">final</span> List&lt;ACL&gt; aclList = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">        aclList.add(auth);</span><br><span class="line">        <span class="keyword">return</span> aclList;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<h3 id="curator"><a href="#curator" class="headerlink" title="curator"></a>curator</h3><p>对Zookeeper库的扩展</p>
<h4 id="依赖-1"><a href="#依赖-1" class="headerlink" title="依赖"></a>依赖</h4><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.curator<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>curator-recipes<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.2.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h4 id="基本使用-2"><a href="#基本使用-2" class="headerlink" title="基本使用"></a>基本使用</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TestCurator</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Logger</span> <span class="variable">LOGGER</span> <span class="operator">=</span> LoggerFactory.getLogger(TestZookeeper.class);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">SERVERS</span> <span class="operator">=</span> <span class="string">&quot;127.0.0.1:2181&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">ROOT_PATH</span> <span class="operator">=</span> <span class="string">&quot;/test&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> CuratorFramework <span class="title function_">createConn</span><span class="params">(String servers, </span></span><br><span class="line"><span class="params">                                           <span class="type">int</span> timeout,  // 超时时间</span></span><br><span class="line"><span class="params">                                           <span class="type">int</span> n, // 重试次数</span></span><br><span class="line"><span class="params">                                           <span class="type">int</span> sleepMsBetweenRetries)</span> &#123; <span class="comment">// 重试间隔 </span></span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 重试策略</span></span><br><span class="line">        <span class="type">RetryNTimes</span> <span class="variable">retryNTimes</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RetryNTimes</span>(n, sleepMsBetweenRetries);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 连接Zookeeper</span></span><br><span class="line">        <span class="type">CuratorFramework</span> <span class="variable">client</span> <span class="operator">=</span> CuratorFrameworkFactory.builder()</span><br><span class="line">                .connectString(SERVERS) <span class="comment">// Zookeeper地址</span></span><br><span class="line">                .sessionTimeoutMs(timeout) <span class="comment">// 连接超时</span></span><br><span class="line">                .retryPolicy(retryNTimes)  <span class="comment">// 重试策略</span></span><br><span class="line">                .build();</span><br><span class="line">		</span><br><span class="line">        <span class="comment">// 连接</span></span><br><span class="line">        client.start();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> client;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 获取连接</span></span><br><span class="line">        <span class="type">CuratorFramework</span> <span class="variable">client</span> <span class="operator">=</span> createConn(SERVERS, <span class="number">10000</span>, <span class="number">10</span>, <span class="number">5000</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 创建一个临时（根）节点，并初始内容为空</span></span><br><span class="line">        <span class="keyword">if</span> (client.checkExists().forPath(ROOT_PATH) == <span class="literal">null</span>) &#123;</span><br><span class="line">            client.create().withMode(CreateMode.EPHEMERAL).forPath(ROOT_PATH);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 注册可重用监听</span></span><br><span class="line">        <span class="type">PathChildrenCache</span> <span class="variable">cache</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">PathChildrenCache</span>(client, ROOT_PATH, <span class="literal">true</span>);</span><br><span class="line">        cache.start();</span><br><span class="line">        <span class="type">PathChildrenCacheListener</span> <span class="variable">cacheListener</span> <span class="operator">=</span> (client1, event) -&gt; &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;事件类型：&quot;</span> + event.getType());</span><br><span class="line">            <span class="keyword">if</span> (<span class="literal">null</span> != event.getData()) &#123;</span><br><span class="line">                System.out.println(<span class="string">&quot;节点数据：&quot;</span> + event.getData().getPath() + <span class="string">&quot; = &quot;</span> + <span class="keyword">new</span> <span class="title class_">String</span>(event.getData().getData()));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">        cache.getListenable().addListener(cacheListener);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 递归创建一个临时节点</span></span><br><span class="line">        <span class="comment">// 递归创建：即使没有根节点都可以创建成功</span></span><br><span class="line">        client.create().creatingParentContainersIfNeeded().withMode(CreateMode.EPHEMERAL).forPath(<span class="string">&quot;/test/t1&quot;</span>,<span class="string">&quot;t1&quot;</span>.getBytes());</span><br><span class="line">        TimeUnit.SECONDS.sleep(<span class="number">10</span>);</span><br><span class="line">        <span class="comment">// 如果主节点是临时的话，就不能构建其子节点。</span></span><br><span class="line">        <span class="comment">//client.create().creatingParentContainersIfNeeded().withMode(CreateMode.EPHEMERAL).forPath(&quot;/test/t1/t11&quot;,&quot;t11&quot;.getBytes());</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 设置acl操作</span></span><br><span class="line">        List&lt;ACL&gt; ip = TestZookeeper.getAcls(<span class="string">&quot;ip&quot;</span>, <span class="string">&quot;127.0.0.1&quot;</span>);</span><br><span class="line">        client.setACL().withACL(ip).forPath(<span class="string">&quot;/test/t1&quot;</span>);</span><br><span class="line">        System.out.println(client.getACL().forPath(<span class="string">&quot;/test/t1&quot;</span>));</span><br><span class="line">        TimeUnit.SECONDS.sleep(<span class="number">30</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">int</span> <span class="variable">version</span> <span class="operator">=</span> client.checkExists().forPath(ROOT_PATH).getVersion();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 递归删除子节点</span></span><br><span class="line"><span class="comment">//        client.delete().deletingChildrenIfNeeded().forPath(&quot;/test/t1&quot;);</span></span><br><span class="line">        <span class="comment">// 指定版本号</span></span><br><span class="line">        client.delete().deletingChildrenIfNeeded().withVersion(version).forPath(<span class="string">&quot;/test/t1&quot;</span>);</span><br><span class="line"></span><br><span class="line">        client.close();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> List&lt;ACL&gt; <span class="title function_">getAcls</span><span class="params">(String scheme, String id)</span> &#123;</span><br><span class="line">        <span class="type">ACL</span> <span class="variable">auth</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ACL</span>(ZooDefs.Perms.ALL, <span class="keyword">new</span> <span class="title class_">Id</span>(scheme, id));</span><br><span class="line">        <span class="keyword">final</span> List&lt;ACL&gt; aclList = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">        aclList.add(auth);</span><br><span class="line">        <span class="keyword">return</span> aclList;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h2 id="可视化工具"><a href="#可视化工具" class="headerlink" title="可视化工具"></a>可视化工具</h2><blockquote>
<p>zookeeper可视化工具</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">yum install git maven</span><br><span class="line">git <span class="built_in">clone</span> https://github.com/zzhang5/zooinspector.git</span><br><span class="line"><span class="built_in">cd</span> zooinspector</span><br><span class="line">mvn clean package</span><br><span class="line"><span class="built_in">chmod</span> +x target/zooinspector-pkg/bin/zooinspector.sh</span><br><span class="line">target/zooinspector-pkg/bin/zooinspector.sh</span><br></pre></td></tr></table></figure>

<h2 id="常用监控手段"><a href="#常用监控手段" class="headerlink" title="常用监控手段"></a>常用监控手段</h2><ul>
<li><p>四字命令： <a target="_blank" rel="noopener" href="https://www.cnblogs.com/kuku0223/p/8428341.html">https://www.cnblogs.com/kuku0223/p/8428341.html</a> </p>
</li>
<li><p>JMX： <a target="_blank" rel="noopener" href="https://www.jianshu.com/p/4f11d7bfc9ce">https://www.jianshu.com/p/4f11d7bfc9ce</a></p>
</li>
</ul>
<h2 id="数据持久化了解"><a href="#数据持久化了解" class="headerlink" title="数据持久化了解"></a>数据持久化了解</h2><blockquote>
<p>简介</p>
</blockquote>
<p>&amp;emsp;&amp;emsp;在 Zookeeper 中负责数据持久化和启动数据恢复的组件叫<strong>ZKDatabase</strong>。ZKDatabase 是 Zookeeper 的内存数据库，主要负责<strong>会话管理</strong>、<strong>事务日志</strong>、<strong>生成DataTree快照</strong>以及<strong>重启时恢复数据</strong>等工作。</p>
<p>&amp;emsp;&amp;emsp;Zookeeper 的持久化方案和 Redis 非常相似，分别有<strong>事务日志</strong>（类似AOF）和<strong>DataTree快照</strong>（类似RDB）两种。ZKDatabase 会在事务产生时将日志写入到事务日志缓冲后再由系统负责定时冲刷到磁盘，以及在特定时间生成 DataTree 快照并将其持久化。</p>
<blockquote>
<p>Zookeeper 启动数据恢复流程</p>
</blockquote>
<p><img src="/%E5%88%9D%E5%A7%8Bzookeeper/007.png"></p>
<h2 id="集群"><a href="#集群" class="headerlink" title="集群"></a>集群</h2><h3 id="关于Leader选举以及ZAB协议相关内容"><a href="#关于Leader选举以及ZAB协议相关内容" class="headerlink" title="关于Leader选举以及ZAB协议相关内容"></a>关于Leader选举以及ZAB协议相关内容</h3><p>移步到另一篇文章 <a target="_blank" rel="noopener" href="https://tandi.pub/%E5%88%86%E5%B8%83%E5%BC%8F%E7%9A%84%E4%B8%80%E8%87%B4%E6%80%A7%E5%92%8C%E5%85%B1%E8%AF%86%E6%80%A7/">分布式的一致性和共识性</a></p>
<h3 id="集群配置"><a href="#集群配置" class="headerlink" title="集群配置"></a>集群配置</h3><h4 id="案例说明"><a href="#案例说明" class="headerlink" title="案例说明"></a>案例说明</h4><p>案例使用 3 个节点来搭建一个伪集群。所谓的伪集群指的是在同一台机器上通过错开端口的形式来模拟物理集群。伪集群通常用于调研阶段，因为方便。</p>
<h4 id="搭建步骤"><a href="#搭建步骤" class="headerlink" title="搭建步骤"></a>搭建步骤</h4><p>1）在各个 Zookeeper 目录下创建data目录并添加 myid 文件</p>
<p>server1</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">➜  apache-zookeeper-3.5.5-bin-01 <span class="built_in">mkdir</span> data</span><br><span class="line">➜  apache-zookeeper-3.5.5-bin-01 <span class="built_in">echo</span> <span class="string">&quot;1&quot;</span> &gt; data/myid <span class="comment"># 设置Zookeeper集群节点ID号</span></span><br></pre></td></tr></table></figure>

<p>server2</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">➜  apache-zookeeper-3.5.5-bin-02 <span class="built_in">mkdir</span> data</span><br><span class="line">➜  apache-zookeeper-3.5.5-bin-02 <span class="built_in">echo</span> <span class="string">&quot;2&quot;</span> &gt; data/myid <span class="comment"># 设置Zookeeper集群节点ID号</span></span><br></pre></td></tr></table></figure>

<p>server3</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">➜  apache-zookeeper-3.5.5-bin-03 <span class="built_in">mkdir</span> data</span><br><span class="line">➜  apache-zookeeper-3.5.5-bin-03 <span class="built_in">echo</span> <span class="string">&quot;3&quot;</span> &gt; data/myid <span class="comment"># 设置Zookeeper集群节点ID号</span></span><br></pre></td></tr></table></figure>



<p>2）修改配置文件</p>
<p>server1</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 心跳包间隔，单位为毫秒</span></span><br><span class="line"><span class="attr">tickTime</span>=<span class="string">2000</span></span><br><span class="line"><span class="comment"># Follower节点启动连接上Leader的时限（包含了同步Leader数据的时间），单位为秒</span></span><br><span class="line"><span class="comment"># 相当说在10s内没能同步完数据并提供服务则会断开重连。在数据量较大时建议调到该值</span></span><br><span class="line"><span class="attr">initLimit</span>=<span class="string">10</span></span><br><span class="line"><span class="comment"># 副本节点同步数据的最大延时，不能满足则会端口重连</span></span><br><span class="line"><span class="attr">syncLimit</span>=<span class="string">5</span></span><br><span class="line"><span class="comment"># 注意：这里不要放在中文目录下，可能会出现找不到myid的问题</span></span><br><span class="line"><span class="attr">dataDir</span>=<span class="string">/home/tandi/zookeeper-test/apache-zookeeper-3.5.5-bin-01/data</span></span><br><span class="line"><span class="attr">clientPort</span>=<span class="string">2181</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"># 2888为节点通信端口</span></span><br><span class="line"><span class="comment"># 3888为节点选举端口</span></span><br><span class="line"><span class="attr">server.1</span>=<span class="string">127.0.0.1:2888:3888</span></span><br><span class="line"><span class="attr">server.2</span>=<span class="string">127.0.0.1:2889:3889</span></span><br><span class="line"><span class="attr">server.3</span>=<span class="string">127.0.0.1:2890:3890</span></span><br></pre></td></tr></table></figure>

<p>server2</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">tickTime</span>=<span class="string">2000</span></span><br><span class="line"><span class="attr">initLimit</span>=<span class="string">10</span></span><br><span class="line"><span class="attr">syncLimit</span>=<span class="string">5</span></span><br><span class="line"><span class="attr">dataDir</span>=<span class="string">/home/tandi/zookeeper-test/apache-zookeeper-3.5.5-bin-01/data</span></span><br><span class="line"><span class="attr">clientPort</span>=<span class="string">2182</span></span><br><span class="line"></span><br><span class="line"><span class="attr">server.1</span>=<span class="string">127.0.0.1:2888:3888</span></span><br><span class="line"><span class="attr">server.2</span>=<span class="string">127.0.0.1:2889:3889</span></span><br><span class="line"><span class="attr">server.3</span>=<span class="string">127.0.0.1:2890:3890</span></span><br></pre></td></tr></table></figure>

<p>server3</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">tickTime</span>=<span class="string">2000</span></span><br><span class="line"><span class="attr">initLimit</span>=<span class="string">10</span></span><br><span class="line"><span class="attr">syncLimit</span>=<span class="string">5</span></span><br><span class="line"><span class="attr">dataDir</span>=<span class="string">/home/tandi/zookeeper-test/apache-zookeeper-3.5.5-bin-03/data</span></span><br><span class="line"><span class="attr">clientPort</span>=<span class="string">2183</span></span><br><span class="line"></span><br><span class="line"><span class="attr">server.1</span>=<span class="string">127.0.0.1:2888:3888</span></span><br><span class="line"><span class="attr">server.2</span>=<span class="string">127.0.0.1:2889:3889</span></span><br><span class="line"><span class="attr">server.3</span>=<span class="string">127.0.0.1:2890:3890</span></span><br></pre></td></tr></table></figure>



<p>3）启动集群节点</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">➜  apache-zookeeper-3.5.5-bin-01 bin/zkServer.sh start conf/zoo.cfg </span><br><span class="line">➜  apache-zookeeper-3.5.5-bin-02 bin/zkServer.sh start conf/zoo.cfg </span><br><span class="line">➜  apache-zookeeper-3.5.5-bin-03 bin/zkServer.sh start conf/zoo.cfg </span><br></pre></td></tr></table></figure>



<h4 id="测试集群"><a href="#测试集群" class="headerlink" title="测试集群"></a>测试集群</h4><p>1）先在任意一个集群节点中添加一个node</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">➜  bin/zkCli.sh -server localhost:2181</span><br><span class="line">[zk: localhost:2181(CONNECTED) 1] create /test &#x27;t1&#x27;</span><br></pre></td></tr></table></figure>

<p>2）在集群的其它节点中观察是否同步成功</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">➜  bin/zkCli.sh -server localhost:2182</span><br><span class="line">[zk: localhost:2182(CONNECTED) 0] ls /</span><br><span class="line">[test, zookeeper]</span><br><span class="line">[zk: localhost:2182(CONNECTED) 1] get /test</span><br><span class="line">t1</span><br></pre></td></tr></table></figure>

<p>3）查看节点在集群中的角色</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">➜  apache-zookeeper-3.5.5-bin-01 bin/zkServer.sh status             </span><br><span class="line">ZooKeeper JMX enabled by default</span><br><span class="line">Using config: /home/tandi/zookeeper-test/apache-zookeeper-3.5.5-bin-01/bin/../conf/zoo.cfg</span><br><span class="line">Client port found: 2181. Client address: localhost.</span><br><span class="line">Mode: follower # 从节点</span><br><span class="line"></span><br><span class="line">➜  apache-zookeeper-3.5.5-bin-02 bin/zkServer.sh status             </span><br><span class="line">ZooKeeper JMX enabled by default</span><br><span class="line">Using config: /home/tandi/zookeeper-test/apache-zookeeper-3.5.5-bin-02/bin/../conf/zoo.cfg</span><br><span class="line">Client port found: 2182. Client address: localhost.</span><br><span class="line">Mode: leader # 主节点</span><br><span class="line"></span><br><span class="line">➜  apache-zookeeper-3.5.5-bin-03 bin/zkServer.sh status</span><br><span class="line">ZooKeeper JMX enabled by default</span><br><span class="line">Using config: /home/tandi/zookeeper-test/apache-zookeeper-3.5.5-bin-03/bin/../conf/zoo.cfg</span><br><span class="line">Client port found: 2183. Client address: localhost.</span><br><span class="line">Mode: follower # 从节点</span><br></pre></td></tr></table></figure>



<p>为什么是 server2 做了 Leader？</p>
<p>&amp;emsp;&amp;emsp;首先服务器并不是同时启动的，在当前案例中我们先启动了 server1，再启动 server2，但因为 server2 的集群节点 myid 值比 server1 大，而且这时 server1 + server2 已经够过半票数了，所以 server2 就自然成为 Leader 了。虽然随后 server3 加入到集群，但因为集群中已经有了 Leader，因此 server3 就只能成为 Follower 了。</p>
<p>4）查看集群配置</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">前集群的配置信息位于节点<span class="string">&quot;/zookeeper/config&quot;</span>中</span></span><br><span class="line">[zk: localhost:2181(CONNECTED) 0] get /zookeeper/config</span><br><span class="line">server.1=localhost:2888:3888:participant</span><br><span class="line">server.2=localhost:2889:3889:participant</span><br><span class="line">server.3=localhost:2890:3890:participant</span><br><span class="line">version=0</span><br></pre></td></tr></table></figure>



<h2 id="3-5-x-版本配置变动"><a href="#3-5-x-版本配置变动" class="headerlink" title="3.5.x 版本配置变动"></a>3.5.x 版本配置变动</h2><blockquote>
<p>新增重要特性</p>
</blockquote>
<p>新增 Dynamic Reconfiguration （动态配置）功能，解决手动扩容时可能导致已提交事务被覆盖从而丢失数据的问题。</p>
<img src="初始zookeeper/006.png" style="zoom: 80%;" />

<blockquote>
<p>配置变动</p>
</blockquote>
<ul>
<li><p>3.5.3 版本开始，动态配置默认关闭，需要通过<code>reconfigEnabled=true</code>开启</p>
</li>
<li><p>3.5.0 版本开始，Zookeeper 默认为单节点模式（Standalone），在该模式下无法对其进行扩展，因此如果要部署集群，则需要在配置中设置<code>standaloneEnabled=false</code></p>
</li>
<li><p>3.5.0 版本开始，原来提供客户端服务的 clientPort（服务端口）、clientPortAddress（服务地址） 两个配置项被弃用，而被修改为如下格式：</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 格式</span></span><br><span class="line"><span class="attr">server.&lt;positive</span> <span class="string">id&gt; = &lt;address&gt;:&lt;port1&gt;:&lt;port2&gt;[:role];[&lt;client port address&gt;:]&lt;client port&gt;</span></span><br><span class="line"><span class="comment"># role 有两种，分别是participant(参与者)和observer(观察者)，不设置默认为participant</span></span><br><span class="line"><span class="comment"># client address相当于原来的clientPortAddress，既提供客户端服务的IP地址，默认值和address一致</span></span><br><span class="line"><span class="comment"># client port相当于原来的clientPort，既提供客户端服务的端口</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"># 例子（集群）=======================</span></span><br><span class="line"><span class="comment"># 其中1234为集群通信端口，而1235为选举端口</span></span><br><span class="line"><span class="attr">server.1</span> = <span class="string">192.168.0.201:1234:1235;2181</span></span><br><span class="line"><span class="attr">server.2</span> = <span class="string">192.168.0.202:1234:1235:participant;2181</span></span><br><span class="line"><span class="attr">server.3</span> = <span class="string">192.168.0.203:1234:1235:participant;2181</span></span><br><span class="line"><span class="attr">server.4</span> = <span class="string">192.168.0.205:1234:1235:observer;2181</span></span><br><span class="line"><span class="comment"># 以上配置表示server.1、server.2、server.3为普通节点，可以参与选举投票。而server.4为Observer节点，只用于备份和扩展读操作，不参与选举投票</span></span><br></pre></td></tr></table></figure></li>
</ul>
<blockquote>
<p>启用动态配置例子</p>
</blockquote>
<p>zookeeper.cfg</p>
<ul>
<li>静态配置，不可变</li>
</ul>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">tickTime</span>=<span class="string">2000</span></span><br><span class="line"><span class="attr">initLimit</span>=<span class="string">10</span></span><br><span class="line"><span class="attr">syncLimit</span>=<span class="string">5</span></span><br><span class="line"><span class="attr">reconfigEnabled</span>=<span class="string">true</span></span><br><span class="line"><span class="attr">standaloneEnabled</span>=<span class="string">false</span></span><br><span class="line"><span class="attr">dataDir</span>=<span class="string">/zookeeper/data/zookeeper1</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"># 动态配置项文件</span></span><br><span class="line"><span class="comment"># 动态配置如果变动，则由Zookeeper推送，静态配置不变</span></span><br><span class="line"><span class="attr">dynamicConfigFile</span>=<span class="string">/zookeeper/conf/zookeeper_1.dynamic</span></span><br></pre></td></tr></table></figure>

<p>zookeeper_1.dynamic</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server.1</span>=<span class="string">125.23.63.23:2780:2783:participant;2181</span></span><br><span class="line"><span class="attr">server.2</span>=<span class="string">125.23.63.24:2780:2783:participant;2181</span></span><br><span class="line"><span class="attr">server.3</span>=<span class="string">125.23.63.25:2780:2783:participant;2181</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>动态扩容例子</p>
</blockquote>
<ol>
<li>假设现在集群中已经有了 3 个节点（集群节点必须都配置 reconfigEnabled&#x3D;true 和 standaloneEnabled&#x3D;false）</li>
<li>现在打算给该集群新增1个节点，但在此之前必须使用 Zookeeper 提供的 superDigest 产生一个超级用户权限，这是使用动态配置的前提。因此需要执行以下两个步骤的操作：<ol>
<li>使用<code>java -cp ./lib/*:./* org.apache.zookeeper.server.auth.DigestAuthenticationProvider super:passwd</code> 得出编码后的账号密码信息。譬如执行后得到<code>super:passwd -&gt; super:gACzJ4L2A0F2ygTno5HQnfabuik=</code></li>
<li>然后将第一步得到的内容配置到 Zookeeper 中。譬如可以通过设置环境变量来实现，即直接执行<code>export SERVER_JVMFLAGS=&quot;-Dzookeeper.DigestAuthenticationProvider.superDigest=super:gACzJ4L2A0F2ygTno5HQnfabuik=&quot;</code> 即可</li>
</ol>
</li>
<li>在第二步操作过后，重启当前机器上的 Zookeeper 节点（集群中的其中一个节点），然后在重启完成后使用命令行客户端连接上，执行如下两个命令：<ol>
<li>先执行<code>addauth digest super:passwd</code>进行权限认证</li>
<li>然后通过动态修改配置往集群中增加一个节点（在这之前新节点应该是正在运行的）。执行命令<code>reconfig -add server.4=125.23.63.26:2780:2783:participant;2181</code> 即可</li>
</ol>
</li>
</ol>
<h2 id="常见-Zookeeper-使用场景"><a href="#常见-Zookeeper-使用场景" class="headerlink" title="常见 Zookeeper 使用场景"></a>常见 Zookeeper 使用场景</h2><h3 id="配置管理"><a href="#配置管理" class="headerlink" title="配置管理"></a>配置管理</h3><p>将共享配置存放到 ZooKeeper 节点中。</p>
<p>应用在启动时到 ZooKeeper 中获取节点信息，同时也可以在其节点上添加 Watch 来监听配置内容的变更以实现动态更新配置。</p>
<h3 id="全局ID"><a href="#全局ID" class="headerlink" title="全局ID"></a>全局ID</h3><p>利用 ZooKeeper 的<strong>顺序节点</strong>和 API 特性来实现。</p>
<p>譬如 create() 一个名称为 <code>id-</code> 的顺序节点，该方法就会返回一个诸如<code>id-0000000005</code>的节点名称。那么就可以使用这个节点名称来做全局 ID 了。除此之外，还可以在 <code>id-0000000005</code> 的基础上增加一些额外的信息。譬如 <code>type-id-0000000005</code> 以实现更富有内涵的全局 ID。</p>
<h3 id="主备切换-热备"><a href="#主备切换-热备" class="headerlink" title="主备切换( 热备 )"></a>主备切换( 热备 )</h3><ul>
<li>方法1</li>
</ul>
<p>&amp;emsp;&amp;emsp;利用<code>临时节点</code>。例如两台服务器启动时先成功创建节点的就先提供服务，而创建节点失败的服务器则则需要在该节点上添加一个 Watch 来监听节点的消失，因为一旦该节点消失就可以顶替已经宕机的服务器来继续对外提供服务了</p>
<ul>
<li>方法2</li>
</ul>
<p>&amp;emsp;&amp;emsp;利用<code>临时顺序节点</code>。例如多台服务器在启动时，在持久性节点 instances 下创建临时顺序节点。创建完成后判断自己的序号是否为最小，如果是则对外提供服务，即 RUNNING 状态。如果不是则为 STANDBY ，并监听 instances 节点的变化来切换自己的状态</p>
<h3 id="Master选举"><a href="#Master选举" class="headerlink" title="Master选举"></a>Master选举</h3><p>Master 选举和上面主备切换的方法1是一样的。既先成功创建节点的就为 Master，而 Slave 则是在该节点上添加Watch ，一旦发现节点消失则顶替 Master 继续提供服务。</p>
<h3 id="命名服务（DNS服务）"><a href="#命名服务（DNS服务）" class="headerlink" title="命名服务（DNS服务）"></a>命名服务（DNS服务）</h3><p>利用<code>临时节点</code>来存储服务提供者 IP 地址。</p>
<p>譬如可以先创建一个持久性节点 <strong>&#x2F;services&#x2F;tiket-services</strong> 用于聚集服务列表，然后<strong>服务提供者</strong>在启动时将自己注册到该节点上。例如注册时可以创建一个临时节点，名称为<strong>address-127.0.0.1:8080</strong>。然后<strong>服务消费者</strong>通过获取持久节点 <strong>&#x2F;services&#x2F;tiket-services</strong> 下的子节点列表再进行服务调用。</p>
<p>当然，具体的实现方式千差万别，但基本原理是一样的。</p>
<h3 id="分布式锁"><a href="#分布式锁" class="headerlink" title="分布式锁"></a>分布式锁</h3><ul>
<li>排它锁</li>
</ul>
<p>利用<code>临时节点</code>和<code>Watch</code>（和上面提到的Master选举操作是一样）。</p>
<p>譬如获取锁时可以在持久节点**&#x2F;exclusive_lock<strong>中创建一个</strong>临时节点lock<strong>。那么即使是并发创建也只会有一个客户端创建成功（成功即表示获取到锁），而没有成功的客户端就在</strong>临时节点lock**上添加 Watch 来监听其状态编号，一旦该节点消失或被主动删除（释放）后就再竞争创建该节点（竞争锁）。</p>
<p>而之所以使用临时节点原因是避免获取到锁的客户端因为特殊原因而无法主动释放锁而造成死锁。</p>
<p><img src="/%E5%88%9D%E5%A7%8Bzookeeper/003.png"></p>
<ul>
<li>共享锁</li>
</ul>
<p>利用<code>临时顺序节点</code>和<code>Watch</code>。</p>
<p>例如获取锁时可以在持久节点**&#x2F;shared_lock<strong>中创建一个</strong>临时顺序节点**，但这时和排它锁就稍有区别了。</p>
<p>1）读锁获取过程：</p>
<ol>
<li>创建<strong>临时顺序节点</strong>。例如名称为**主机IP-R-**。如果创建成功 Zookeeper 就会生成一个名称诸如为 <strong>主机IP-R-0000000001</strong> 的临时顺序节点</li>
<li>然后客户端程序需要再获取**&#x2F;shared_lock**下的子节点列表</li>
<li>最后判断是否获取锁成功，会有以下种情况放生：<ol>
<li>通过判断，发现当前创建的节点的序列号最小，则获取共享锁成功</li>
<li>如果不是最小，则需要接着判断在比自己序号小的节点中<code>是否存在写节点</code>，如果不存在则获取共享锁成功</li>
<li>如果比自己序号小的节点中存在写节点，则获取共享锁失败，需要进入等待状态，并在距离自己最近且比自己序号小的<code>写节点</code>上添加 Watch 监听其释放，当触发事件时则表示获取共享锁成功（因为已经没有写锁了，只剩下共享锁）</li>
</ol>
</li>
</ol>
<p>2）写锁获取过程：</p>
<ol>
<li>创建<strong>临时顺序节点</strong>。例如名称为<strong>主机IP-W-<strong>。如果创建成功 Zookeeper 就会生成一个名称诸如为</strong>主机IP-W-0000000001</strong> 的临时顺序节点</li>
<li>然后客户端程序需要再获取**&#x2F;shared_lock**下的子节点列表</li>
<li>最后判断是否获取锁成功，会有以下种情况放生：<ol>
<li>通过判断，自己的序号是否为最小，如果是则获取写锁成功</li>
<li>如果自己的序号不是最小，则进入等待状态，并在距离自己最近且比自己序号小的节点上添加 Watch 监听其消失，当触发事件时则表示获取写锁成功</li>
</ol>
</li>
</ol>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><ul>
<li>《从Paxos到ZooKeeper 分布式一致性原理与实战》</li>
<li><a target="_blank" rel="noopener" href="https://www.geek-book.com/src/docs/zookeeper3.6.1/zookeeper3.6.1/zookeeper.apache.org/doc/r3.6.1/zookeeperReconfig.html#ch_reconfig_dyn">ZooKeeper Dynamic Reconfiguration</a></li>
<li><a target="_blank" rel="noopener" href="https://www.geek-book.com/src/docs/zookeeper3.6.1/zookeeper3.6.1/zookeeper.apache.org/doc/r3.6.1/zookeeperAdmin.html#sc_authOptions">ZooKeeper Administrator’s Guide</a></li>
</ul>

  </div>
  
    
      <a id="older" class="blog-nav" href="/Nginx%E7%AE%80%E5%8D%95%E4%BD%BF%E7%94%A8/">OLDER&nbsp;&gt;</a>
      
        
          <a id="newer" class="blog-nav" href="/%E4%BB%8EConcurrentModificationException%E5%88%86%E6%9E%90ArrayList%E8%BF%AD%E4%BB%A3%E5%99%A8/">&lt;&nbsp;NEWER</a>
          
            
</div>
        <div class="footer">
  
    <div class="footer-more">
      
        <a href="/"><em style="color:red;">新站点正在开发中，网站暂停更新。</em></a>
        
    </div>
  
    <div class="footer-more">
      
        <a href="/">Copyright © DeeTam 2022</a>
        
    </div>
  
</div>

      </div>

      <div class="back-to-top hidden">
  <a href="javascript: void(0)">
    <i class="iconfont icon-chevronup"></i>
  </a>
</div>


<script src="/js/backtotop.js"></script>



      
  <div class="search-icon" id="search-icon">
    <a href="javascript: void(0)">
      <i class="iconfont icon-search"></i>
    </a>
  </div>

  <div class="search-overlay hidden">
    <div class="search-content" tabindex="0">
      <div class="search-box">
        <div class="search-title">
          <!-- <span class="search-icon-input">
            <a href="javascript: void(0)">
              <i class="iconfont icon-search"></i>
            </a>
          </span> -->
          
            <input type="text" class="search-input" id="search-input" placeholder="搜索...">
          
          <span class="search-close-icon" id="search-close-icon">
            <a href="javascript: void(0)">
              <i class="iconfont icon-close"></i>
            </a>
          </span>
        </div>
        <div class="search-result" id="search-result"></div>
      </div>
    </div>
  </div>

  <script type="text/javascript">
    var inputArea = document.querySelector("#search-input")
    var searchOverlayArea = document.querySelector(".search-overlay")

    // inputArea.onclick = function() {
    //   getSearchFile()
    //   this.onclick = null
    // }

    inputArea.onkeydown = function() {
      if(event.keyCode == 13)
        return false
    }

    function openOrHideSearchContent() {
      let isHidden = searchOverlayArea.classList.contains('hidden')
      if (isHidden) {
        searchOverlayArea.classList.remove('hidden')
        document.body.classList.add('hidden')
        inputArea.focus()
        getSearchFile()
      } else {
        searchOverlayArea.classList.add('hidden')
        document.body.classList.remove('hidden')
      }
    }

    function blurSearchContent(e) {
      if (e.target === searchOverlayArea) {
        openOrHideSearchContent()
      }
    }

    document.querySelector("#search-icon").addEventListener("click", openOrHideSearchContent, false)
    document.querySelector("#search-close-icon").addEventListener("click", openOrHideSearchContent, false)
    searchOverlayArea.addEventListener("click", blurSearchContent, false)

    var searchFunc = function (path, search_id, content_id) {
      'use strict';
      var $input = document.getElementById(search_id);
      var $resultContent = document.getElementById(content_id);
      $resultContent.innerHTML = "<ul><span class='local-search-empty'><span></ul>";
      // $resultContent.innerHTML = "<ul><span class='local-search-empty'>首次搜索，正在载入索引文件，请稍后……<span></ul>";
      $.ajax({
        // 0x01. load xml file
        url: path,
        dataType: "xml",
        success: function (xmlResponse) {
          // 0x02. parse xml file
          var datas = $("entry", xmlResponse).map(function () {
            return {
              title: $("title", this).text(),
              content: $("content", this).text(),
              url: $("url", this).text()
            };
          }).get();
          $resultContent.innerHTML = "";

          $input.addEventListener('input', function () {
            // 0x03. parse query to keywords list
            var str = '<ul class=\"search-result-list\">';
            var keywords = this.value.trim().toLowerCase().split(/[\s\-]+/);
            $resultContent.innerHTML = "";
            if (this.value.trim().length <= 0) {
              return;
            }
            // 0x04. perform local searching
            datas.forEach(function (data) {
              var isMatch = true;
              var content_index = [];
              if (!data.title || data.title.trim() === '') {
                data.title = "Untitled";
              }
              var orig_data_title = data.title.trim();
              var data_title = orig_data_title.toLowerCase();
              var orig_data_content = data.content.trim().replace(/<[^>]+>/g, "");
              var data_content = orig_data_content.toLowerCase();
              var data_url = data.url;
              var index_title = -1;
              var index_content = -1;
              var first_occur = -1;
              // only match artiles with not empty contents
              if (data_content !== '') {
                keywords.forEach(function (keyword, i) {
                  index_title = data_title.indexOf(keyword);
                  index_content = data_content.indexOf(keyword);

                  if (index_title < 0 && index_content < 0) {
                    isMatch = false;
                  } else {
                    if (index_content < 0) {
                      index_content = 0;
                    }
                    if (i == 0) {
                      first_occur = index_content;
                    }
                    // content_index.push({index_content:index_content, keyword_len:keyword_len});
                  }
                });
              } else {
                isMatch = false;
              }
              // 0x05. show search results
              if (isMatch) {
                str += "<li><a href='/" + data_url + "' class='search-result-title'><h2>" + orig_data_title + "</h2></a>";
                var content = orig_data_content;
                if (first_occur >= 0) {
                  // cut out 100 characters
                  var start = first_occur - 20;
                  var end = first_occur + 80;

                  if (start < 0) {
                    start = 0;
                  }

                  if (start == 0) {
                    end = 100;
                  }

                  if (end > content.length) {
                    end = content.length;
                  }

                  var match_content = content.substr(start, end);

                  // highlight all keywords
                  keywords.forEach(function (keyword) {
                    var regS = new RegExp(keyword, "gi");
                    match_content = match_content.replace(regS, "<span class=\"search-keyword\">" + keyword + "</span>");
                  });

                  str += "<h3 class=\"search-result-abstract\">" + match_content + "...</h3>"
                }
                str += "<hr></li>";
              }
            });
            str += "</ul>";
            if (str.indexOf('<li>') === -1) {
              return $resultContent.innerHTML = "<ul><span class='local-search-empty'>没有找到内容，请尝试更换检索词。<span></ul>";
            }
            $resultContent.innerHTML = str;
          });
        },
        error: function(xhr, status, error) {
          $resultContent.innerHTML = ""
          if (xhr.status === 404) {
            $resultContent.innerHTML = "<ul><span class='local-search-empty'>未找到search.xml文件，具体请参考：<a href='https://github.com/leedom92/hexo-theme-leedom#configuration' target='_black'>configuration</a><span></ul>";
          } else {
            $resultContent.innerHTML = "<ul><span class='local-search-empty'>请求失败，尝试重新刷新页面或稍后重试。<span></ul>";
          }
        }
      });
      $(document).on('click', '#search-close-icon', function() {
        $('#search-input').val('');
        $('#search-result').html('');
      });
    }

    var getSearchFile = function() {
        var path = "/search.xml";
        searchFunc(path, 'search-input', 'search-result');
    }
  </script>




    </div>
  </body>
</html>

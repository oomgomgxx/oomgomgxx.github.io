<!DOCTYPE html>
<html lang="zh-CN">

  <head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="keywords" content="" />
  <meta name="author" content="DeeTam" />
  <meta name="description" content="学然后知不足" />
  
  
  <title>
    
      Docker的基本使用 
      
      
    
  </title>

  
    <link rel="apple-touch-icon" href="/images/favicon.png">
    <link rel="icon" href="/images/favicon.png">
  

  <!-- Raleway-Font -->
  <link href="https://fonts.googleapis.com/css?family=Montserrat|Roboto:400,400italic,600|Roboto+Mono" rel="stylesheet">

  <!-- hexo site css -->
  
<link rel="stylesheet" href="/css/base.css">
<link rel="stylesheet" href="/css/common.css">
<link rel="stylesheet" href="/iconfont/iconfont.css">


  

  
    
<link rel="stylesheet" href="/css/post.css">

  

  <!-- jquery3.3.1 -->
  <script src="https://cdn.bootcss.com/jquery/3.3.1/jquery.min.js"></script>

  <!-- fancybox -->
  <link href="https://cdn.bootcss.com/fancybox/3.5.2/jquery.fancybox.min.css" rel="stylesheet">
  <script async src="https://cdn.bootcss.com/fancybox/3.5.2/jquery.fancybox.min.js"></script>
  
<script src="/js/fancybox.js"></script>


<meta name="generator" content="Hexo 6.3.0"></head>


  <body>
    <div id="app">
      <div class="header">
  <a href="/">DEE TAM</a>
</div>


      <p class="links">
  
    <a title="归档" target="" href="/archives/">
      <i class="iconfont icon-bookmark"></i>
    </a>
  
    <a title="邮箱" target="" href="mailto:oomgomgxx@gmail.com">
      <i class="iconfont icon-envelope"></i>
    </a>
  
    <a title="QQ" target="" href="tencent://message/?Menu=yes&uin=0x1DACE601&Service=300&sigT=45a1e5847943b64c6ff3990f8a9e644d2b31356cb0b4ac6b24663a3c8dd0f8aa12a595b1714f9d45">
      <i class="iconfont icon-qq"></i>
    </a>
  
    <a title="关于" target="" href="/about/">
      <i class="iconfont icon-emoji-friendly"></i>
    </a>
  
</p>


      <div class="main">
        <!-- 文章详情页，展示文章具体内容，url形式：https://yoursite/文章标题/ -->
<!-- 同时为「标签tag」，「朋友friend」，「分类categories」，「关于about」页面的承载页面，具体展示取决于page.type -->

<!-- LaTex Display -->
<script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
<script type="text/javascript" id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js">
</script>
<script>
  MathJax = {
    tex: {
      inlineMath: [['$', '$'], ['\\(', '\\)']]
    }
  };
</script>

<div class="post">
  
  <!--
  
    <h3 class="date">
    Jul 23, 2018
  </h3>
  
  -->

  
  <center>
    <h1>
      Docker的基本使用
    </h1>
  </center>
  

  <div class="content markdown-body">
    <h2 id="认识Docker"><a href="#认识Docker" class="headerlink" title="认识Docker"></a>认识Docker</h2><ul>
<li>Docker是一个应用容器引擎，可实现环境的一次封装到处运行</li>
<li>Docker支持多容器同时运行，利用容器可以实现产品的：<code>标准化打包</code>、<code>环境隔离</code>、<code>标准化部署</code>等功能</li>
</ul>
<blockquote>
<p>个人感受：</p>
<p>作为一个开发者来说可能Docker并不是你百分需要掌握的技能，但是如果你会Docker的话，个人认为这将会大大提高你的学习和生产能力。</p>
<p>就我个人而言就最为讨厌配置环境，因为环境不同或者稍有些许配置错误都将会浪费很多时间，这使得我不能专注于技术本身而将时间浪费在了弄环境上。这时Docker（或者说容器技术）就打救了我。使用Docker只需一两条命令就很便捷地搭建出一个数据库或各种应用服务，设置各种集群等，无疑这对于广大开发者来说是一种福音。</p>
</blockquote>
<h2 id="容器化与虚拟化的区别"><a href="#容器化与虚拟化的区别" class="headerlink" title="容器化与虚拟化的区别"></a>容器化与虚拟化的区别</h2><p><img src="/docker%E5%BA%94%E7%94%A8%E5%AE%B9%E5%99%A8%E5%BC%95%E6%93%8E/001.png"></p>
<ul>
<li>容器化可以简单理解为现今的一种轻量级虚拟化技术</li>
<li>容器引擎的虚拟化和隔离主要依赖的是操作系统的隔离技术。譬如network namespace做到网卡、cgroup做资源（cpu、内存的用量）隔离等</li>
<li>虚拟化是从物理硬件上虚拟出一套虚拟硬件，所以位于虚拟化上的应用限制于虚拟硬件（<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/Hypervisor">Hypervisor层</a>)。而容器技术则直接受限于物理硬件，换句话就是容器技术可以更加充分地利用物理机上的资源。这点是作为使用者应该知道的最重要的区别。</li>
</ul>
<h2 id="组件介绍"><a href="#组件介绍" class="headerlink" title="组件介绍"></a>组件介绍</h2><p><img src="/docker%E5%BA%94%E7%94%A8%E5%AE%B9%E5%99%A8%E5%BC%95%E6%93%8E/012.png"></p>
<ul>
<li><strong>Docker Client：</strong>负责接收用户的 Docker Command 和 Restful API</li>
<li><strong>Docker Deamon：</strong>可理解为Docker Server，即我们所理解的容器引擎。负责处理Docker Client请求并协调处理其他Docker组件</li>
<li><strong>Docker Image：</strong>镜像可以理解为对某个应用及其环境的封装。在Docker中镜像的特点是：只读、可重用和可叠加</li>
<li><strong>Docker Container：</strong>容器是镜像的运行时。在Docker中容器之间可以做到资源隔离，这就是所谓的” 船舱隔离 “</li>
<li><strong>Docker Regitry：</strong>Regitry是Docker Image的托管仓库。Regitry可以分为公共和私有两种。公司内部或者个人可以搭建自己的私有仓库在保存一些不想被外界使用的镜像。而一般的开源应用服务如果支持容器化的话都会将自己的镜像放到公共仓库中提供给大家使用（类似于maven中央仓库概念）。例如我们现在想要安装一个MySQL，这时我们就可以到公共仓库中找到对应的镜像文件然后拉下来使用即可。</li>
</ul>
<blockquote>
<p>常见的公共镜像仓库（Regitry）有哪些？</p>
<p><a target="_blank" rel="noopener" href="https://hub.docker.com/">DockerHub</a>（Docker默认）</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://quay.io/">Quay</a></li>
<li><a target="_blank" rel="noopener" href="https://cloud.google.com/container-registry/">Google Container Registry</a></li>
<li><a target="_blank" rel="noopener" href="https://azure.microsoft.com/en-us/services/container-registry/">Azure Container Registry</a></li>
</ul>
<p>以上公共镜像仓库均位于国外，所以拉取镜像时可能比较缓慢甚至失败。因此国内出现了不少CDN加速站点，例如以下这些：</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://registry.docker-cn.com/">Docker cn</a></li>
<li><a target="_blank" rel="noopener" href="https://dockerhub.azk8s.cn/">Azure 中国镜像</a></li>
<li><a target="_blank" rel="noopener" href="https://reg-mirror.qiniu.com/">七牛</a></li>
<li><a target="_blank" rel="noopener" href="https://hub-mirror.c.163.com/">网易163</a></li>
<li><a target="_blank" rel="noopener" href="https://mirror.ccs.tencentyun.com/">腾讯云</a></li>
</ul>
</blockquote>
<h2 id="基本使用"><a href="#基本使用" class="headerlink" title="基本使用"></a>基本使用</h2><h3 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install  -y docker</span><br></pre></td></tr></table></figure>

<h3 id="快速入门"><a href="#快速入门" class="headerlink" title="快速入门"></a>快速入门</h3><blockquote>
<p>以Tomcat为例子</p>
</blockquote>
<p>拉取镜像</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">➜ docker pull tomcat</span><br><span class="line">Using default tag: latest</span><br><span class="line">Trying to pull repository docker.io/library/tomcat ... </span><br><span class="line">latest: Pulling from docker.io/library/tomcat</span><br><span class="line">844c33c7e6ea: Pull complete </span><br><span class="line">ada5d61ae65d: Pull complete </span><br><span class="line">f8427fdf4292: Pull complete </span><br><span class="line">f025bafc4ab8: Pull complete </span><br><span class="line">67b8714e1225: Pull complete </span><br><span class="line">64b12da521a3: Pull complete </span><br><span class="line">2e38df533772: Pull complete </span><br><span class="line">4144d55bbb47: Pull complete </span><br><span class="line">fc059d90e2b2: Pull complete </span><br><span class="line">9d8f80ed8620: Pull complete </span><br><span class="line">Digest: sha256:68355b27adee5fc76c23e3d3cb994bd2733f05aa8e2c070a61346e16eed308ac</span><br><span class="line">Status: Downloaded newer image for docker.io/tomcat:latest</span><br></pre></td></tr></table></figure>

<p>启动tomcat</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">➜  ~ docker images</span><br><span class="line">REPOSITORY          TAG                 IMAGE ID            CREATED             SIZE</span><br><span class="line">docker.io/tomcat    latest              6fa48e047721        7 hours ago         507 MB</span><br><span class="line">➜  ~ docker run --name tomcat -p 8080:8080 -d 6fa48e047721  </span><br><span class="line">7e7d2242f369250999c9c79b47255b3d310a6dd1aff3c45fc99685108579b61b</span><br></pre></td></tr></table></figure>

<ul>
<li>–name：指定容器名称</li>
<li>-p：指定端口映射</li>
<li>-d：后台运行并打印容器id</li>
</ul>
<p>上面的两步操作可以合成一步，即直接run。这样docker会自动拉取镜像再运行，如下。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run --name tomcat -p 8080:8080 -d tomcat</span><br></pre></td></tr></table></figure>

<h3 id="服务相关"><a href="#服务相关" class="headerlink" title="服务相关"></a>服务相关</h3><p>启动</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl start docker</span><br></pre></td></tr></table></figure>

<p>停止</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl stop docker</span><br></pre></td></tr></table></figure>

<p>重启</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl restart docker</span><br></pre></td></tr></table></figure>

<p>查看状态</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl status docker</span><br></pre></td></tr></table></figure>

<p>设置开机启动</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl enable docker</span><br></pre></td></tr></table></figure>



<h3 id="容器相关"><a href="#容器相关" class="headerlink" title="容器相关"></a>容器相关</h3><p>查看容器状态</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">docker ps</span><br><span class="line">docker ps -a （包含历史）</span><br></pre></td></tr></table></figure>

<p>查看元数据（如：ip、网关等等）</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker inspect 容器运行时名称</span><br></pre></td></tr></table></figure>

<p>输出容器中应用日志</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker logs 容器id或容器名字</span><br></pre></td></tr></table></figure>

<p>在容器中执行命令</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">docker exec -it 容器id或容器名字 命令</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">例如启动容器中的shell</span></span><br><span class="line">docker exec -it 容器id或容器名字 bash</span><br></pre></td></tr></table></figure>

<p>停止所有docker容器</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">停止指定容器</span></span><br><span class="line">docker stop 容器名称或id</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">停止所有</span></span><br><span class="line">docker stop $(docker ps -qa)</span><br></pre></td></tr></table></figure>

<p>删除容器</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker rm 容器id或容器名字</span><br></pre></td></tr></table></figure>

<p>实时监控容器</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker stats tomcat</span><br></pre></td></tr></table></figure>

<p>查看容器的映射端口</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">➜  ~ docker port tomcat</span><br><span class="line">8080/tcp -&gt; 0.0.0.0:8080</span><br></pre></td></tr></table></figure>

<p>连接正在运行的容器</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker attach --sig-proxy=false tomcat</span><br></pre></td></tr></table></figure>

<ul>
<li><code>--sig-proxy=false</code>作用是 ctrl+c 退出连接不关闭容器</li>
</ul>
<h3 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h3><p>查找镜像</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">docker search 镜像名称</span><br><span class="line"><span class="meta prompt_">&gt;</span><span class="language-bash">&gt;&gt;&gt;&gt;&gt;</span></span><br><span class="line">NAME：仓库名称</span><br><span class="line">DESCRIPTION：镜像描述</span><br><span class="line">STARS：用户评价，反应一个镜像的受欢迎程度</span><br><span class="line">OFFICIAL：是否官方</span><br></pre></td></tr></table></figure>

<p>删除镜像</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">删除指定镜像</span></span><br><span class="line">docker rmi 镜像</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">删除所有镜像</span></span><br><span class="line">docker rmi $(docker images -q)</span><br></pre></td></tr></table></figure>

<p>查看docker容器目前支持的网络模式</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">➜  ~ docker network ls</span><br><span class="line">NETWORK ID          NAME                DRIVER              SCOPE</span><br><span class="line">f4a3530daab5        bridge              bridge              local</span><br><span class="line">f0d6c1700eb9        host                host                local</span><br><span class="line">7ede4aa145a3        none                null                local</span><br></pre></td></tr></table></figure>

<ul>
<li>可在除此run镜像时使用<code>--net</code>指定</li>
</ul>
<p>查看docker容器目前的挂载目录</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">➜  ~ docker volume ls</span><br><span class="line">DRIVER              VOLUME NAME</span><br></pre></td></tr></table></figure>

<p>docker run常用参数</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">-a stdin: 指定标准输入输出内容类型，可选 STDIN/STDOUT/STDERR 三项；</span><br><span class="line"></span><br><span class="line">-d: 后台运行容器，并返回容器ID；</span><br><span class="line"></span><br><span class="line">-i: 以交互模式运行容器，通常与 -t 同时使用；</span><br><span class="line"></span><br><span class="line">-p: 端口映射，格式为：主机(宿主)端口:容器端口；</span><br><span class="line"></span><br><span class="line">-t: 为容器重新分配一个伪输入终端；</span><br><span class="line"></span><br><span class="line">--name=&quot;nginx-lb&quot;: 为容器指定一个名称；</span><br><span class="line"></span><br><span class="line">--dns 8.8.8.8: 指定容器使用的DNS服务器，默认和宿主一致；</span><br><span class="line"></span><br><span class="line">--dns-search example.com: 指定容器DNS搜索域名，默认和宿主一致；</span><br><span class="line"></span><br><span class="line">-h &quot;mars&quot;: 指定容器的hostname；</span><br><span class="line"></span><br><span class="line">-e username=&quot;ritchie&quot;: 设置环境变量；</span><br><span class="line"></span><br><span class="line">--env-file=[]: 从指定文件读入环境变量；</span><br><span class="line"></span><br><span class="line">--cpuset=&quot;0-2&quot; or --cpuset=&quot;0,1,2&quot;: 绑定容器到指定CPU运行；</span><br><span class="line"></span><br><span class="line">-m :设置容器使用内存最大值；</span><br><span class="line"></span><br><span class="line">--net=&quot;bridge&quot;: 指定容器的网络模式，支持 bridge/host/none/container: 四种类型；</span><br><span class="line"></span><br><span class="line">--link=[]: 添加链接(连接的容器ip会配合到DNS中)；</span><br><span class="line"></span><br><span class="line">--expose=[]: 开放一个端口或一组端口；</span><br><span class="line"></span><br><span class="line">--restart=no ：指定宕机重启策略，支持no/no-failure/always/unless-stopped</span><br></pre></td></tr></table></figure>



<h2 id="配置国内镜像加速站点"><a href="#配置国内镜像加速站点" class="headerlink" title="配置国内镜像加速站点"></a>配置国内镜像加速站点</h2><ul>
<li>我当前使用的系统是CentOS</li>
</ul>
<blockquote>
<p>步骤1：将加速站点添加到 &#x2F;etc&#x2F;docker&#x2F;daemon.json 中</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  &quot;registry-mirrors&quot;:[&quot;https://registry.docker-cn.com&quot;]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>步骤2：重启docker服务</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">从文件系统中获取更改的配置并重新生成依赖树</span></span><br><span class="line">➜  ~ sudo systemctl daemon-reload</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">重启服务</span></span><br><span class="line">➜  ~ sudo systemctl restart docker.service</span><br></pre></td></tr></table></figure>

<blockquote>
<p>查看是否配置成功</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">➜  ~ docker info</span><br><span class="line">...</span><br><span class="line">Registry Mirrors:</span><br><span class="line"> https://registry.docker-cn.com</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<h2 id="构建镜像"><a href="#构建镜像" class="headerlink" title="构建镜像"></a>构建镜像</h2><h3 id="了解镜像的构建"><a href="#了解镜像的构建" class="headerlink" title="了解镜像的构建"></a>了解镜像的构建</h3><p><img src="/docker%E5%BA%94%E7%94%A8%E5%AE%B9%E5%99%A8%E5%BC%95%E6%93%8E/002.png"></p>
<ul>
<li>首先 Docker Image 本身是<code>只读</code>且<code>可复用</code>的。那么如何复用呢？在Docker中镜像复用是通过镜像叠加来实现的</li>
<li>如上图所示，因为镜像本身是只读的，所以每一次修改都会生成一个新的镜像层（layer）</li>
<li>图中的 bootfs（引导文件系统） 主要用于加载和初始化内核相关内容，完成后会自动unmount。而 Base Image 是整个镜像的最基层，即 rootfs（根文件系统），可以简单理解为是一个最简约轻量的文件系统。随后的 emacs、apache 等等实质都是一些软件应用的打包，而在容器运行时，容器将会包含所有镜像中的内容</li>
</ul>
<h3 id="基于容器构建"><a href="#基于容器构建" class="headerlink" title="基于容器构建"></a>基于容器构建</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo docker commit 容器id或名称 镜像名称</span><br></pre></td></tr></table></figure>

<ul>
<li>不推荐这种方式，因为使用的人无法直观得知镜像的构建过程</li>
</ul>
<h3 id="使用Dockerfile构建-推荐"><a href="#使用Dockerfile构建-推荐" class="headerlink" title="使用Dockerfile构建(推荐)"></a>使用Dockerfile构建(推荐)</h3><h4 id="快速入门-1"><a href="#快速入门-1" class="headerlink" title="快速入门"></a>快速入门</h4><blockquote>
<p>步骤1：编写 Dockerfile 文件。vim Dockerfile </p>
</blockquote>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 基础镜像</span></span><br><span class="line"><span class="keyword">FROM</span> tomcat</span><br><span class="line"><span class="comment"># 构建过程中执行命令</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> <span class="built_in">echo</span> <span class="string">&#x27;helle dockerfile ~~~~~&#x27;</span></span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>步骤2：基于 Dockerfile 构建镜像</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">当前所处路径</span></span><br><span class="line">➜  dockerfile pwd</span><br><span class="line">/home/vagrant/dockerfile</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">构建镜像</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">格式：docker build -t 库名称(可省略)/镜像名称:标签  Dockerfile所在路径</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">镜像名称为 mytomcat</span></span><br><span class="line">➜  dockerfile docker build -t mytomcat .          </span><br><span class="line">Sending build context to Docker daemon 2.048 kB</span><br><span class="line">Step 1/2 : FROM tomcat</span><br><span class="line"><span class="meta prompt_"> ---&gt; </span><span class="language-bash">6fa48e047721 <span class="comment"># 镜像ID</span></span></span><br><span class="line">Step 2/2 : RUN echo &#x27;helle dockerfile ~~~~~&#x27;</span><br><span class="line"><span class="meta prompt_"> ---&gt; </span><span class="language-bash">Running <span class="keyword">in</span> 3b8b12856cac <span class="comment"># 1.基于镜像6fa48e047721启动一个容器</span></span></span><br><span class="line">helle dockerfile ~~~~~ # 2.修改当前容器3b8b12856cac</span><br><span class="line"><span class="meta prompt_"> ---&gt; </span><span class="language-bash">fdd8fa08e7fe <span class="comment"># 3.根据修改过后的容器生产一个镜像</span></span></span><br><span class="line">Removing intermediate container 3b8b12856cac # 4.成功生产镜像后移除原来容器</span><br><span class="line">Successfully built fdd8fa08e7fe # 最终镜像ID</span><br></pre></td></tr></table></figure>

<ul>
<li>除此之外还可以从构建过程看出每一个Dockerfile指令都是一个 Step</li>
</ul>
<blockquote>
<p>查看生产的镜像</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">➜  dockerfile docker images</span><br><span class="line">REPOSITORY          TAG                 IMAGE ID            CREATED             SIZE</span><br><span class="line">mytomcat            latest              fdd8fa08e7fe        3 minutes ago       507 MB</span><br><span class="line">docker.io/tomcat    latest              6fa48e047721        9 hours ago         507 MB</span><br></pre></td></tr></table></figure>



<h4 id="Dockerfile语法"><a href="#Dockerfile语法" class="headerlink" title="Dockerfile语法"></a>Dockerfile语法</h4><h5 id="FROM"><a href="#FROM" class="headerlink" title="FROM"></a>FROM</h5><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 基础镜像（注意：FROM必须在文件顶部）</span></span><br><span class="line"><span class="keyword">FROM</span> 镜像名称 </span><br></pre></td></tr></table></figure>

<ul>
<li><p>scratch 是基础镜像的特殊值，表示当前镜像不基于任何镜像来构建镜像，例如只用作软件打包</p>
</li>
<li><p>最基础的镜像应该是系统镜像</p>
</li>
<li><p>如果是基于某些软件应用来构建自己的镜像，则无需显式指定系统镜像而只需直接基于某个软件应用镜像来构建即可。例如 FROM nginx，这里的nginx本身已经是基于系统镜像来构建的，所有已经有了 rootfs。因此在构建自己的镜像时，我们只需考虑如何使用基础镜像和挂载数据到基础镜像即可。如下：</p>
<p><img src="/docker%E5%BA%94%E7%94%A8%E5%AE%B9%E5%99%A8%E5%BC%95%E6%93%8E/003.png"></p>
</li>
</ul>
<h5 id="RUN"><a href="#RUN" class="headerlink" title="RUN"></a>RUN</h5><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 镜像构建时执行的命令</span></span><br><span class="line"><span class="comment"># 注意，每执行一次RUN都会生成新的Layer（其实每个大写指令都是一个层Layer)</span></span><br><span class="line"><span class="comment"># 所以，尽量将命令写在一行，如用 &amp;&amp; 拼接命令</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> 需要执行的linux命令</span></span><br></pre></td></tr></table></figure>

<h5 id="MAINTAINER"><a href="#MAINTAINER" class="headerlink" title="MAINTAINER"></a>MAINTAINER</h5><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 指定Dockerfile的元数据。例如创建者的信息</span></span><br><span class="line"><span class="keyword">MAINTAINER</span> 作者名称&lt;作者邮箱&gt;</span><br></pre></td></tr></table></figure>

<h5 id="ADD"><a href="#ADD" class="headerlink" title="ADD"></a>ADD</h5><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 添加文件到镜像的指定位置(因为镜像是只读的，所以该操作会产生新Layer，其他指令同理)</span></span><br><span class="line"><span class="comment"># 源文件可以是一个路径也可以是一个url地址（注意：会自动进行解压）</span></span><br><span class="line"><span class="keyword">ADD</span><span class="language-bash"> 源文件 目标文件</span></span><br><span class="line"><span class="keyword">ADD</span><span class="language-bash"> [<span class="string">&quot;源文件1&quot;</span>, <span class="string">&quot;源文件2&quot;</span>, ..., <span class="string">&quot;目标文件&quot;</span>]</span></span><br></pre></td></tr></table></figure>

<h5 id="COPY"><a href="#COPY" class="headerlink" title="COPY"></a>COPY</h5><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 添加文件到镜像的指定位置</span></span><br><span class="line"><span class="comment"># 功能和ADD一样，但不支持解压和URL</span></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> 源文件 目标文件</span></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> [<span class="string">&quot;源文件1&quot;</span>, <span class="string">&quot;源文件2&quot;</span>, ..., <span class="string">&quot;目标文件&quot;</span>]</span></span><br></pre></td></tr></table></figure>

<h5 id="ENV"><a href="#ENV" class="headerlink" title="ENV"></a>ENV</h5><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 设置环境变量</span></span><br><span class="line"><span class="keyword">ENV</span> key value</span><br><span class="line"><span class="keyword">ENV</span> key=value</span><br></pre></td></tr></table></figure>

<h5 id="ARG"><a href="#ARG" class="headerlink" title="ARG"></a>ARG</h5><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 指定构建时参数，功能和ENV一样，但是只在Dockerfile内有效</span></span><br><span class="line"><span class="keyword">ARG</span> key=value</span><br></pre></td></tr></table></figure>

<p>LABEL</p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 指定镜像元数据。可以使用 docker inspect 命令查看到</span></span><br><span class="line"><span class="keyword">LABEL</span><span class="language-bash"> 元数据</span></span><br><span class="line"><span class="keyword">LABEL</span><span class="language-bash"> version=<span class="string">&quot;2.0&quot;</span></span></span><br><span class="line"><span class="keyword">LABEL</span><span class="language-bash"> desc=<span class="string">&quot;其实就是描述信息&quot;</span></span></span><br></pre></td></tr></table></figure>

<h5 id="WORKDIR"><a href="#WORKDIR" class="headerlink" title="WORKDIR"></a>WORKDIR</h5><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 指定工作目录</span></span><br><span class="line"><span class="comment"># 注意：该指令相当于Linux的CD命令，在该命令之后的RUN/CMD/ENTRYPOINT，都将在该工作目录下进行</span></span><br><span class="line"><span class="keyword">WORKDIR</span><span class="language-bash"> 目录路径</span></span><br></pre></td></tr></table></figure>

<ul>
<li>注意：默认的工作目录是根路径（既 &#x2F; 下面）</li>
</ul>
<h5 id="VOLUME"><a href="#VOLUME" class="headerlink" title="VOLUME"></a>VOLUME</h5><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 指定数据挂载点。可将容器数据目录挂载到宿主机器上</span></span><br><span class="line"><span class="comment"># 非常重要，用于避免数据因容器重启而丢失</span></span><br><span class="line"><span class="comment"># 可以使用 docker volume ls 命令查看到</span></span><br><span class="line"><span class="comment"># 启动容器 docker run 的时候，可以通过-v参数修改挂载点</span></span><br><span class="line"><span class="keyword">VOLUME</span><span class="language-bash"> 路径</span></span><br></pre></td></tr></table></figure>

<h5 id="EXPOSE"><a href="#EXPOSE" class="headerlink" title="EXPOSE"></a>EXPOSE</h5><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 暴露容器端口（只针对容器之间）</span></span><br><span class="line"><span class="comment"># 注意1：该配置只作声明作用，有助于观看Dockerfile的人得知端口信息</span></span><br><span class="line"><span class="comment"># 注意2：如果外部需要访问，则使用参数-p</span></span><br><span class="line"><span class="keyword">EXPOSE</span> 端口号</span><br><span class="line"><span class="keyword">EXPOSE</span> 端口号/协议</span><br></pre></td></tr></table></figure>

<h5 id="CMD"><a href="#CMD" class="headerlink" title="CMD"></a>CMD</h5><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 设置容器启动时执行的默认命令</span></span><br><span class="line"><span class="comment"># 注意1: CMD在Dockerfile中是唯一的，既即使定义多个CMD都会被最后的覆盖</span></span><br><span class="line"><span class="keyword">CMD</span><span class="language-bash"> [<span class="string">&quot;命令&quot;</span>]</span></span><br><span class="line"><span class="keyword">CMD</span><span class="language-bash"> [<span class="string">&quot;命令&quot;</span>,<span class="string">&quot;命令参数1&quot;</span>,<span class="string">&quot;命令参数2&quot;</span>]</span></span><br><span class="line"><span class="keyword">CMD</span><span class="language-bash"> 命令 命令参数</span></span><br><span class="line"><span class="comment"># 注意2：CMD只是默认的，如果docker run的指定了命令则CMD会被覆盖</span></span><br><span class="line"><span class="comment"># 例如：docker run -it tomcat bin/bash</span></span><br></pre></td></tr></table></figure>

<h5 id="ENTRYPOINT"><a href="#ENTRYPOINT" class="headerlink" title="ENTRYPOINT"></a>ENTRYPOINT</h5><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 功能和CMD一样，但不会被 docker run 的命令行参数指定的指令所覆盖</span></span><br><span class="line"><span class="comment"># 如：ENTRYPOINT [&quot;/bin/echo&quot;]，然后docker run -itd xxxx hi传入参数，则会输出hi</span></span><br><span class="line"><span class="keyword">ENTRYPOINT</span><span class="language-bash"> [<span class="string">&quot;命令&quot;</span>]</span></span><br><span class="line"><span class="keyword">ENTRYPOINT</span><span class="language-bash"> [<span class="string">&quot;命令&quot;</span>,<span class="string">&quot;命令参数1&quot;</span>,<span class="string">&quot;命令参数2&quot;</span>]</span></span><br><span class="line"><span class="keyword">ENTRYPOINT</span><span class="language-bash"> 命令 命令参数</span></span><br></pre></td></tr></table></figure>

<h5 id="RUN、CMD、ENTRYPOINT之间的区别"><a href="#RUN、CMD、ENTRYPOINT之间的区别" class="headerlink" title="RUN、CMD、ENTRYPOINT之间的区别"></a>RUN、CMD、ENTRYPOINT之间的区别</h5><blockquote>
<p>说明：</p>
<ol>
<li>如果ENTRYPOINT在CMD之后定义，ENTRYPOINT中的命令会覆盖CMD中的命令</li>
<li>而且ENTRYPOINT中的命令，可以使用CMD中定义的参数</li>
<li>ENTRYPOINT使用参数的顺序：先使用自己定义的参数，再使用CMD中的定义的参数</li>
</ol>
</blockquote>
<p><img src="/docker%E5%BA%94%E7%94%A8%E5%AE%B9%E5%99%A8%E5%BC%95%E6%93%8E/007.png"></p>
<p><img src="/docker%E5%BA%94%E7%94%A8%E5%AE%B9%E5%99%A8%E5%BC%95%E6%93%8E/008.png"></p>
<ul>
<li>注意：shell格式能输出ENV变量，而exec格式不能</li>
</ul>
<blockquote>
<p>例子</p>
</blockquote>
<p><img src="/docker%E5%BA%94%E7%94%A8%E5%AE%B9%E5%99%A8%E5%BC%95%E6%93%8E/005.png"></p>
<p><img src="/docker%E5%BA%94%E7%94%A8%E5%AE%B9%E5%99%A8%E5%BC%95%E6%93%8E/006.png"></p>
<h5 id="最佳实践"><a href="#最佳实践" class="headerlink" title="最佳实践"></a>最佳实践</h5><blockquote>
<p>以下 Dockerfile 源自MySQL</p>
</blockquote>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> debian:stretch-slim</span><br><span class="line"></span><br><span class="line"><span class="comment"># 在debian layer(临时产生的容器)中添加用户和用户组</span></span><br><span class="line"><span class="comment"># 该操作会生成新的layer</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> groupadd -r mysql &amp;&amp; useradd -r -g mysql mysql</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 更新上一层layer(临时产生的容器)和下载配置相关上下文</span></span><br><span class="line"><span class="comment"># 该操作会生成新的layer</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> apt-get update &amp;&amp; apt-get install -y --no-install-recommends gnupg dirmngr &amp;&amp; <span class="built_in">rm</span> -rf /var/lib/apt/lists/*</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置环境变量</span></span><br><span class="line"><span class="keyword">ENV</span> GOSU_VERSION <span class="number">1.7</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 更新上一层layer(临时产生的容器)和配置相关上下文</span></span><br><span class="line"><span class="comment"># 该操作会生成新的layer</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> <span class="built_in">set</span> -x \</span></span><br><span class="line"><span class="language-bash">	&amp;&amp; apt-get update &amp;&amp; apt-get install -y --no-install-recommends ca-certificates wget &amp;&amp; <span class="built_in">rm</span> -rf /var/lib/apt/lists/* \</span></span><br><span class="line"><span class="language-bash">	&amp;&amp; wget -O /usr/local/bin/gosu <span class="string">&quot;https://github.com/tianon/gosu/releases/download/<span class="variable">$GOSU_VERSION</span>/gosu-<span class="subst">$(dpkg --print-architecture)</span>&quot;</span> \</span></span><br><span class="line"><span class="language-bash">	&amp;&amp; wget -O /usr/local/bin/gosu.asc <span class="string">&quot;https://github.com/tianon/gosu/releases/download/<span class="variable">$GOSU_VERSION</span>/gosu-<span class="subst">$(dpkg --print-architecture)</span>.asc&quot;</span> \</span></span><br><span class="line"><span class="language-bash">	&amp;&amp; <span class="built_in">export</span> GNUPGHOME=<span class="string">&quot;<span class="subst">$(mktemp -d)</span>&quot;</span> \</span></span><br><span class="line"><span class="language-bash">	&amp;&amp; gpg --batch --keyserver ha.pool.sks-keyservers.net --recv-keys B42F6819007F00F88E364FD4036A9C25BF357DD4 \</span></span><br><span class="line"><span class="language-bash">	&amp;&amp; gpg --batch --verify /usr/local/bin/gosu.asc /usr/local/bin/gosu \</span></span><br><span class="line"><span class="language-bash">	&amp;&amp; gpgconf --<span class="built_in">kill</span> all \</span></span><br><span class="line"><span class="language-bash">	&amp;&amp; <span class="built_in">rm</span> -rf <span class="string">&quot;<span class="variable">$GNUPGHOME</span>&quot;</span> /usr/local/bin/gosu.asc \</span></span><br><span class="line"><span class="language-bash">	&amp;&amp; <span class="built_in">chmod</span> +x /usr/local/bin/gosu \</span></span><br><span class="line"><span class="language-bash">	&amp;&amp; gosu nobody <span class="literal">true</span> \</span></span><br><span class="line"><span class="language-bash">	&amp;&amp; apt-get purge -y --auto-remove ca-certificates wget</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建文件夹docker-entrypoint-initdb.d</span></span><br><span class="line"><span class="comment"># 该操作会生成新的layer</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> <span class="built_in">mkdir</span> /docker-entrypoint-initdb.d</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 更新上一层layer(临时产生的容器)和配置相关上下文</span></span><br><span class="line"><span class="comment"># 该操作会生成新的layer</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> apt-get update &amp;&amp; apt-get install -y --no-install-recommends \</span></span><br><span class="line"><span class="language-bash"><span class="comment"># for MYSQL_RANDOM_ROOT_PASSWORD</span></span></span><br><span class="line">		pwgen \</span><br><span class="line">		openssl \</span><br><span class="line">		perl \</span><br><span class="line">	&amp;&amp; rm -rf /var/lib/apt/lists/*</span><br><span class="line"></span><br><span class="line"><span class="comment"># 配置相关上下文</span></span><br><span class="line"><span class="comment"># 该操作会生成新的layer</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> <span class="built_in">set</span> -ex; \</span></span><br><span class="line"><span class="language-bash"><span class="comment"># gpg: key 5072E1F5: public key &quot;MySQL Release Engineering &lt;mysql-build@oss.oracle.com&gt;&quot; imported</span></span></span><br><span class="line">	key=<span class="string">&#x27;A4A9406876FCBD3C456770C88C718D3B5072E1F5&#x27;</span>; \</span><br><span class="line">	export GNUPGHOME=<span class="string">&quot;$(mktemp -d)&quot;</span>; \</span><br><span class="line">	gpg --batch --keyserver ha.pool.sks-keyservers.net --recv-keys <span class="string">&quot;$key&quot;</span>; \</span><br><span class="line">	gpg --batch --export <span class="string">&quot;$key&quot;</span> &gt; /etc/apt/trusted.gpg.d/mysql.gpg; \</span><br><span class="line">	gpgconf --kill all; \</span><br><span class="line">	rm -rf <span class="string">&quot;$GNUPGHOME&quot;</span>; \</span><br><span class="line">	apt-key list &gt; /dev/null</span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置环境变量</span></span><br><span class="line"><span class="keyword">ENV</span> MYSQL_MAJOR <span class="number">8.0</span></span><br><span class="line"><span class="keyword">ENV</span> MYSQL_VERSION <span class="number">8.0</span>.<span class="number">18</span>-<span class="number">1</span>debian9</span><br><span class="line"></span><br><span class="line"><span class="comment"># 配置相关上下文</span></span><br><span class="line"><span class="comment"># 该操作会生成新的layer</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> <span class="built_in">echo</span> <span class="string">&quot;deb http://repo.mysql.com/apt/debian/ stretch mysql-<span class="variable">$&#123;MYSQL_MAJOR&#125;</span>&quot;</span> &gt; /etc/apt/sources.list.d/mysql.list</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 更新上一层layer(临时产生的容器)和配置相关上下文</span></span><br><span class="line"><span class="comment"># 该操作会生成新的layer</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> &#123; \</span></span><br><span class="line"><span class="language-bash">		<span class="built_in">echo</span> mysql-community-server mysql-community-server/data-dir select <span class="string">&#x27;&#x27;</span>; \</span></span><br><span class="line"><span class="language-bash">		<span class="built_in">echo</span> mysql-community-server mysql-community-server/root-pass password <span class="string">&#x27;&#x27;</span>; \</span></span><br><span class="line"><span class="language-bash">		<span class="built_in">echo</span> mysql-community-server mysql-community-server/re-root-pass password <span class="string">&#x27;&#x27;</span>; \</span></span><br><span class="line"><span class="language-bash">		<span class="built_in">echo</span> mysql-community-server mysql-community-server/remove-test-db select <span class="literal">false</span>; \</span></span><br><span class="line"><span class="language-bash">	&#125; | debconf-set-selections \</span></span><br><span class="line"><span class="language-bash">	&amp;&amp; apt-get update &amp;&amp; apt-get install -y mysql-community-client=<span class="string">&quot;<span class="variable">$&#123;MYSQL_VERSION&#125;</span>&quot;</span> mysql-community-server-core=<span class="string">&quot;<span class="variable">$&#123;MYSQL_VERSION&#125;</span>&quot;</span> &amp;&amp; <span class="built_in">rm</span> -rf /var/lib/apt/lists/* \</span></span><br><span class="line"><span class="language-bash">	&amp;&amp; <span class="built_in">rm</span> -rf /var/lib/mysql &amp;&amp; <span class="built_in">mkdir</span> -p /var/lib/mysql /var/run/mysqld \</span></span><br><span class="line"><span class="language-bash">	&amp;&amp; <span class="built_in">chown</span> -R mysql:mysql /var/lib/mysql /var/run/mysqld \</span></span><br><span class="line"><span class="language-bash"><span class="comment"># ensure that /var/run/mysqld (used for socket and lock files) is writable regardless of the UID our mysqld instance ends up having at runtime</span></span></span><br><span class="line">	&amp;&amp; chmod <span class="number">777</span> /var/<span class="keyword">run</span><span class="language-bash">/mysqld</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置挂载点</span></span><br><span class="line"><span class="keyword">VOLUME</span><span class="language-bash"> /var/lib/mysql</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 拷贝配置文件到容器中</span></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> config/ /etc/mysql/</span></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> docker-entrypoint.sh /usr/local/bin/</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 产生新的Layer</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> <span class="built_in">ln</span> -s usr/local/bin/docker-entrypoint.sh /entrypoint.sh</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 容器启动时指定脚本docker-entrypoint.sh</span></span><br><span class="line"><span class="keyword">ENTRYPOINT</span><span class="language-bash"> [<span class="string">&quot;docker-entrypoint.sh&quot;</span>]</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 暴露端口号</span></span><br><span class="line"><span class="keyword">EXPOSE</span> <span class="number">3306</span> <span class="number">33060</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 容器启动时启动mysql服务</span></span><br><span class="line"><span class="keyword">CMD</span><span class="language-bash"> [<span class="string">&quot;mysqld&quot;</span>]</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>基于以上 Dockerfile 生成 MySQL 镜像</p>
</blockquote>
<p>下载 Dockerfile 到当前目录</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">wget https://raw.githubusercontent.com/docker-library/mysql/6659750146b7a6b91a96c7867</span><br><span class="line">29b4d482cf49fe6/8.0/Dockerfile</span><br></pre></td></tr></table></figure>

<p>基于 Dockerfile 构 建MySQL</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">➜  dockerfile docker build -t mysql8 .</span><br></pre></td></tr></table></figure>



<h2 id="单机容器编排"><a href="#单机容器编排" class="headerlink" title="单机容器编排"></a>单机容器编排</h2><h3 id="Docker-Compose和容器编排"><a href="#Docker-Compose和容器编排" class="headerlink" title="Docker Compose和容器编排"></a>Docker Compose和容器编排</h3><ul>
<li>Docker的最佳实践是一个容器只运行一个进程</li>
<li>通常应用服务都不会单个存在，很多时候服务之间是存在依赖性的。例如应用依赖数据库服务和缓存服务，这时就需要对容器进行编排。例如在服务A启动之前需要保证服务B和服务C启动，否者服务A不能正常提供服务，这时我们就需要手动启动多个服务</li>
<li>针对以上情况，如果服务太多的话，启动服务的工作就会变得额外沉重。为了解决这个问题 Docker 提供了 Docker Compose 作为解决方案</li>
<li>Docker Compose 允许对容器进行编排并关联服务之间的关系</li>
<li>Docker Compose 使用 yaml 进行配置，通过解析 yaml 配置转为 docker 参数来运行组建容器</li>
<li>Docker Compose 使用步骤：<code>定义Dockerfile生成镜像</code>、<code>定义yaml</code>、运行<code>docker-compose up</code>命令</li>
</ul>
<h3 id="安装Docker-Compose"><a href="#安装Docker-Compose" class="headerlink" title="安装Docker Compose"></a>安装Docker Compose</h3><p>注意：新版Docker已内置compose功能，可通过 docker -h 查看知否支持</p>
<ul>
<li>官方文档：<a target="_blank" rel="noopener" href="https://docs.docker.com/compose/install/">https://docs.docker.com/compose/install/</a></li>
<li>Docker Compose的安装方式有两种：pip（因为Docker Compose是用Python开发的）、curl</li>
</ul>
<blockquote>
<p>步骤1：下载 docker-compose</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo curl -L &quot;https://github.com/docker/compose/releases/download/1.27.4/docker-compose-$(uname -s)-$(uname -m)&quot; -o /usr/local/bin/docker-compose</span><br></pre></td></tr></table></figure>

<blockquote>
<p>步骤2：授权</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo chmod +x /usr/local/bin/docker-compose</span><br></pre></td></tr></table></figure>



<h3 id="快速入门-2"><a href="#快速入门-2" class="headerlink" title="快速入门"></a>快速入门</h3><blockquote>
<p>步骤1：创建 docker-compose.yml 文件，注意docker-compose.yml是缺省文件名字</p>
</blockquote>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># docker compose版本号</span></span><br><span class="line"><span class="attr">version:</span> <span class="string">&#x27;3.3&#x27;</span></span><br><span class="line"><span class="attr">services:</span> </span><br><span class="line">	<span class="comment"># 服务名称（自定义）</span></span><br><span class="line">	<span class="attr">tomcat:</span> </span><br><span class="line">		<span class="comment"># dockerfile文件所在的位置</span></span><br><span class="line">		<span class="comment"># build: .  </span></span><br><span class="line">		<span class="comment"># 除了使用dockerfile还可以直接指定镜像,默认使用最新版本</span></span><br><span class="line">		<span class="attr">image:</span> <span class="string">tomcat</span></span><br><span class="line">		<span class="comment"># 端口映射，相当于 -p 8080:8080</span></span><br><span class="line">		<span class="attr">ports:</span></span><br><span class="line">			<span class="bullet">-</span> <span class="string">&quot;8080:8080&quot;</span> </span><br></pre></td></tr></table></figure>

<blockquote>
<p>步骤2：运行docker-compose.yml</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">构建（如果其中使用的Dockerfile，那么在up之前建议先执行如下命令构建）</span></span><br><span class="line">docker-compose build</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">后台运行（在docker-compose文件目录下执行）</span></span><br><span class="line">docker-compose up -d</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">指定文件启动</span></span><br><span class="line">docker-compose -f docker-compose.yml up -d</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">也可以指定多个</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">docker-compose -f docker-compose.yml -f docker-compose2.yml up -d</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">停止容器</span></span><br><span class="line">docker-compose stop</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">启动</span></span><br><span class="line">docker-compose start</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">停止并移除</span></span><br><span class="line">docker-compose down</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">移除容器</span></span><br><span class="line">docker-compose rm</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">查看容器</span></span><br><span class="line">docker-compose ps</span><br></pre></td></tr></table></figure>



<h3 id="docker-compose配置参考"><a href="#docker-compose配置参考" class="headerlink" title="docker-compose配置参考"></a>docker-compose配置参考</h3><ul>
<li><a target="_blank" rel="noopener" href="https://github.com/docker/docker.github.io/blob/master/compose/index.md#common-use-cases">https://github.com/docker/docker.github.io/blob/master/compose/index.md#common-use-cases</a> </li>
<li><a target="_blank" rel="noopener" href="https://docs.docker.com/compose/compose-file/">https://docs.docker.com/compose/compose-file/</a></li>
</ul>
<h3 id="最佳实践-1"><a href="#最佳实践-1" class="headerlink" title="最佳实践"></a>最佳实践</h3><blockquote>
<p>下面以 elasticsearch + cerebro + kibana  为例子。因为博主机器内存有限，所以只能单节点做例子，而集群配置可以参考官方文档（注意版本）：</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/elasticsearch/reference/7.5/docker.html">https://www.elastic.co/guide/en/elasticsearch/reference/7.5/docker.html</a></li>
</ul>
</blockquote>
<p>步骤1：扩大宿主机限制，否则 Elasticsearch 可能启动不成功</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo sysctl -w vm.max_map_count=262144</span><br></pre></td></tr></table></figure>

<p>步骤2：编写 docker-compose.yml 文件</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">&quot;3.6&quot;</span></span><br><span class="line"><span class="attr">services:</span> </span><br><span class="line">		<span class="comment"># 服务名称（会写入容器DNS）</span></span><br><span class="line">    <span class="attr">elasticsearch:</span></span><br><span class="line">    		</span><br><span class="line">    		<span class="comment"># 容器名称</span></span><br><span class="line">        <span class="attr">container_name:</span> <span class="string">elasticsearch</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># 镜像</span></span><br><span class="line">        <span class="comment"># 注意需要指定版本号，否则拉取不成功</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">elasticsearch:7.5.</span>        </span><br><span class="line">        <span class="comment"># 也可以指定Dockerfile文件</span></span><br><span class="line">        <span class="comment">#build: ./Dockerfile</span></span><br><span class="line">                </span><br><span class="line">        <span class="comment"># 端口映射</span></span><br><span class="line">        <span class="attr">ports:</span> </span><br><span class="line">            <span class="bullet">-</span> <span class="number">9200</span><span class="string">:9200</span></span><br><span class="line">        <span class="comment"># 容器环境变量</span></span><br><span class="line">        <span class="attr">environment:</span> </span><br><span class="line">            <span class="bullet">-</span> <span class="string">node.name=es-node-1</span> <span class="comment"># 指定节点名称</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">bootstrap.memory_lock=true</span> <span class="comment"># 锁定内存大小</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">discovery.type=single-node</span> <span class="comment"># 单节点模式</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">ES_JAVA_OPTS=-Xms512m</span> <span class="string">-Xmx512m</span> <span class="comment"># 配置堆大小</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#				environment: </span></span><br><span class="line"><span class="comment">#        		node.name: es-node-1</span></span><br><span class="line"><span class="comment">#            bootstrap.memory_lock: true</span></span><br><span class="line"><span class="comment">#            discovery.type: single-node</span></span><br><span class="line"><span class="comment">#            ES_JAVA_OPTS: -Xms512m -Xmx512m          </span></span><br><span class="line"></span><br><span class="line">				<span class="comment"># 容器限制</span></span><br><span class="line">        <span class="attr">ulimits:</span></span><br><span class="line">            <span class="attr">memlock:</span></span><br><span class="line">                <span class="attr">soft:</span> <span class="number">-1</span></span><br><span class="line">                <span class="attr">hard:</span> <span class="number">-1</span></span><br><span class="line">        <span class="comment"># 重启策略（相对容器服务）</span></span><br><span class="line">        <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line">        <span class="comment"># 网络</span></span><br><span class="line">        <span class="attr">networks:</span> </span><br><span class="line">            <span class="bullet">-</span> <span class="string">elastic</span>     </span><br><span class="line"></span><br><span class="line">    <span class="attr">kibana:</span></span><br><span class="line">        <span class="attr">container_name:</span> <span class="string">kibana</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">kibana:7.5.0</span></span><br><span class="line">        <span class="attr">ports:</span> </span><br><span class="line">            <span class="bullet">-</span> <span class="number">5601</span><span class="string">:5601</span></span><br><span class="line">        <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line">        <span class="comment"># 先后顺序</span></span><br><span class="line">        <span class="comment"># 表示必须等待elasticsearch服务启动后当前服务才接着启动</span></span><br><span class="line">        <span class="attr">depends_on:</span> </span><br><span class="line">            <span class="bullet">-</span> <span class="string">elasticsearch</span></span><br><span class="line">        <span class="attr">networks:</span> </span><br><span class="line">            <span class="bullet">-</span> <span class="string">elastic</span></span><br><span class="line"></span><br><span class="line">	<span class="comment"># cerebro可用于监控es节点，如内存、cpu等等指标</span></span><br><span class="line">    <span class="attr">cerebro:</span> </span><br><span class="line">        <span class="attr">container_name:</span> <span class="string">cerebro</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">lmenezes/cerebro</span></span><br><span class="line">        <span class="attr">ports:</span> </span><br><span class="line">            <span class="bullet">-</span> <span class="number">9000</span><span class="string">:9000</span></span><br><span class="line">        <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line">        <span class="attr">depends_on:</span> </span><br><span class="line">            <span class="bullet">-</span> <span class="string">elasticsearch</span></span><br><span class="line">        <span class="attr">networks:</span> </span><br><span class="line">            <span class="bullet">-</span> <span class="string">elastic</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 定义（创建）一个网络，用于服务之间通信使用</span></span><br><span class="line"><span class="attr">networks:</span></span><br><span class="line">    <span class="attr">elastic:</span></span><br><span class="line">        <span class="attr">driver:</span> <span class="string">bridge</span></span><br><span class="line"><span class="comment"># 也可以写成这样，采用默认配置</span></span><br><span class="line"><span class="attr">networks:</span></span><br><span class="line">		<span class="attr">elastic:</span> &#123;&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>书写规范：<a target="_blank" rel="noopener" href="https://github.com/compose-spec/compose-spec/blob/master/spec.md">https://github.com/compose-spec/compose-spec/blob/master/spec.md</a></li>
</ul>
<h2 id="注册中心相关"><a href="#注册中心相关" class="headerlink" title="注册中心相关"></a>注册中心相关</h2><ul>
<li>以下操作需要将加速站点配置为DaoCloud</li>
</ul>
<blockquote>
<p>步骤1：在DockerHub上注册一个账号</p>
</blockquote>
<p>账号：<a href="mailto:&#x78;&#x78;&#120;&#x78;&#120;&#x78;&#x78;&#64;&#120;&#x78;&#120;&#46;&#x63;&#111;&#x6d;">&#x78;&#x78;&#120;&#x78;&#120;&#x78;&#x78;&#64;&#120;&#x78;&#120;&#46;&#x63;&#111;&#x6d;</a></p>
<p>密码：dh———————–</p>
<blockquote>
<p>步骤2：Docker登录到注册中心</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker login</span><br></pre></td></tr></table></figure>

<blockquote>
<p>步骤3：编写Dockerfile</p>
</blockquote>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> scratch</span><br><span class="line"><span class="keyword">LABEL</span><span class="language-bash"> desc=测试镜像上传到注册中心</span></span><br><span class="line"><span class="keyword">CMD</span><span class="language-bash"> <span class="built_in">echo</span> <span class="string">&quot;hello...&quot;</span></span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>步骤4：构建镜像</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">格式：docker build -t 库名称/镜像名称 dockerfile文件所在路径</span><br><span class="line">docker build -t tandi/hello-test .</span><br></pre></td></tr></table></figure>

<blockquote>
<p>步骤5：上传镜像</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker push tandi/hello-test</span><br></pre></td></tr></table></figure>

<blockquote>
<p>查看是否上传成功</p>
</blockquote>
<p><img src="/docker%E5%BA%94%E7%94%A8%E5%AE%B9%E5%99%A8%E5%BC%95%E6%93%8E/009.png"></p>
<p><img src="/docker%E5%BA%94%E7%94%A8%E5%AE%B9%E5%99%A8%E5%BC%95%E6%93%8E/010.png"></p>
<blockquote>
<p>从注册中心拉取镜像</p>
<p>注意：拉取前必须确认库是public的</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker pull tandi/hello-test</span><br></pre></td></tr></table></figure>



<p><strong>搭建私有注册中心</strong></p>
<blockquote>
<p>步骤1：拉取docker hub上的registry</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -e REGISTRY_HTTP_HOST=对应的域名 -d -p 5000:5000 --restart always --name registry registry</span><br></pre></td></tr></table></figure>

<ul>
<li>注：如果不配置 -e REGISTRY_HTTP_HOST，则在 docker push 时可能会出现 Retrying 的情况。</li>
</ul>
<blockquote>
<p>步骤2：构建一个镜像</p>
</blockquote>
<p>Dockerfile</p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> scratch</span><br><span class="line"><span class="keyword">LABEL</span><span class="language-bash"> desc=测试镜像上传到注册中心</span></span><br><span class="line"><span class="keyword">CMD</span><span class="language-bash"> <span class="built_in">echo</span> <span class="string">&quot;hello...&quot;</span></span></span><br></pre></td></tr></table></figure>

<p>构建镜像</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">格式：docker build -t 注册中心所在主机ip:5000/镜像名称 .</span><br><span class="line">docker build -t 192.168.1.102:5000/hello-test .</span><br></pre></td></tr></table></figure>

<p>配置注册中心信任</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/docker/daemon.json</span><br><span class="line">&#123;</span><br><span class="line">  &quot;registry-mirrors&quot;: [&quot;http://f1361db2.m.daocloud.io&quot;], # 镜像加速</span><br><span class="line">  &quot;insecure-registries&quot;: [&quot;192.168.1.102:5000&quot;] # 非SSL源管理镜像</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>重启docker服务</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl daemon-reload ; systemctl restart docker</span><br></pre></td></tr></table></figure>

<blockquote>
<p>步骤3：启动注册中心容器</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -d -p 5000:5000 116995fd6624</span><br></pre></td></tr></table></figure>

<blockquote>
<p>步骤4：将镜像push到私有注册中心</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker push 192.168.1.102:5000/hello-test</span><br></pre></td></tr></table></figure>

<blockquote>
<p>步骤5：检验是否push成功</p>
</blockquote>
<p>浏览器：<a target="_blank" rel="noopener" href="http://192.168.1.102:5000/v2/_catalog">http://192.168.1.102:5000/v2/_catalog</a></p>
<p><img src="/docker%E5%BA%94%E7%94%A8%E5%AE%B9%E5%99%A8%E5%BC%95%E6%93%8E/011.png"></p>
<h2 id="安装可视化工具-Portainer"><a href="#安装可视化工具-Portainer" class="headerlink" title="安装可视化工具 - Portainer"></a>安装可视化工具 - Portainer</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">docker pull portainer/portainer </span><br><span class="line">docker run --name portainer-ui -d -p 9000:9000 -v /var/run/docker.sock:/var/run/docker.sock portainer/portainer</span><br></pre></td></tr></table></figure>



<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><ul>
<li><a target="_blank" rel="noopener" href="https://docs.docker.com/">Docker Documentation</a></li>
<li><a target="_blank" rel="noopener" href="https://www.accenture.com/us-en/blogs/blogs-reshma-shinde-docker-containerization-devops">Evolution of Linux containerization helped in simplifying DevOps using Docker</a></li>
<li><a target="_blank" rel="noopener" href="https://woshijpf.github.io/%E5%86%85%E6%A0%B8/2017/06/14/ramfs-rootfs-initramfs%E7%9A%84%E5%8C%BA%E5%88%AB.html">ramfs, tmpfs, rootfs, initramfs的区别</a></li>
<li><a target="_blank" rel="noopener" href="https://juejin.im/post/5cd2cf01f265da0374189441">Docker Hub 镜像加速器</a></li>
<li>《Docker进阶与实战》</li>
<li>《Docker微服务架构实战》</li>
</ul>
<h2 id="内容修订"><a href="#内容修订" class="headerlink" title="内容修订"></a>内容修订</h2><ul>
<li>2019年12月14日02:09:53 — 重新编排并丰富Docker概念和使用内容</li>
</ul>

  </div>
  
    
      <a id="older" class="blog-nav" href="/SpringSecurity2/">OLDER&nbsp;&gt;</a>
      
        
          <a id="newer" class="blog-nav" href="/consul%E5%85%A5%E9%97%A8/">&lt;&nbsp;NEWER</a>
          
            
</div>
        <div class="footer">
  
    <div class="footer-more">
      
        <a href="/"><em style="color:red;">新站点正在开发中，网站暂停更新。</em></a>
        
    </div>
  
    <div class="footer-more">
      
        <a href="/">Copyright © DeeTam 2022</a>
        
    </div>
  
</div>

      </div>

      <div class="back-to-top hidden">
  <a href="javascript: void(0)">
    <i class="iconfont icon-chevronup"></i>
  </a>
</div>


<script src="/js/backtotop.js"></script>



      
  <div class="search-icon" id="search-icon">
    <a href="javascript: void(0)">
      <i class="iconfont icon-search"></i>
    </a>
  </div>

  <div class="search-overlay hidden">
    <div class="search-content" tabindex="0">
      <div class="search-box">
        <div class="search-title">
          <!-- <span class="search-icon-input">
            <a href="javascript: void(0)">
              <i class="iconfont icon-search"></i>
            </a>
          </span> -->
          
            <input type="text" class="search-input" id="search-input" placeholder="搜索...">
          
          <span class="search-close-icon" id="search-close-icon">
            <a href="javascript: void(0)">
              <i class="iconfont icon-close"></i>
            </a>
          </span>
        </div>
        <div class="search-result" id="search-result"></div>
      </div>
    </div>
  </div>

  <script type="text/javascript">
    var inputArea = document.querySelector("#search-input")
    var searchOverlayArea = document.querySelector(".search-overlay")

    // inputArea.onclick = function() {
    //   getSearchFile()
    //   this.onclick = null
    // }

    inputArea.onkeydown = function() {
      if(event.keyCode == 13)
        return false
    }

    function openOrHideSearchContent() {
      let isHidden = searchOverlayArea.classList.contains('hidden')
      if (isHidden) {
        searchOverlayArea.classList.remove('hidden')
        document.body.classList.add('hidden')
        inputArea.focus()
        getSearchFile()
      } else {
        searchOverlayArea.classList.add('hidden')
        document.body.classList.remove('hidden')
      }
    }

    function blurSearchContent(e) {
      if (e.target === searchOverlayArea) {
        openOrHideSearchContent()
      }
    }

    document.querySelector("#search-icon").addEventListener("click", openOrHideSearchContent, false)
    document.querySelector("#search-close-icon").addEventListener("click", openOrHideSearchContent, false)
    searchOverlayArea.addEventListener("click", blurSearchContent, false)

    var searchFunc = function (path, search_id, content_id) {
      'use strict';
      var $input = document.getElementById(search_id);
      var $resultContent = document.getElementById(content_id);
      $resultContent.innerHTML = "<ul><span class='local-search-empty'><span></ul>";
      // $resultContent.innerHTML = "<ul><span class='local-search-empty'>首次搜索，正在载入索引文件，请稍后……<span></ul>";
      $.ajax({
        // 0x01. load xml file
        url: path,
        dataType: "xml",
        success: function (xmlResponse) {
          // 0x02. parse xml file
          var datas = $("entry", xmlResponse).map(function () {
            return {
              title: $("title", this).text(),
              content: $("content", this).text(),
              url: $("url", this).text()
            };
          }).get();
          $resultContent.innerHTML = "";

          $input.addEventListener('input', function () {
            // 0x03. parse query to keywords list
            var str = '<ul class=\"search-result-list\">';
            var keywords = this.value.trim().toLowerCase().split(/[\s\-]+/);
            $resultContent.innerHTML = "";
            if (this.value.trim().length <= 0) {
              return;
            }
            // 0x04. perform local searching
            datas.forEach(function (data) {
              var isMatch = true;
              var content_index = [];
              if (!data.title || data.title.trim() === '') {
                data.title = "Untitled";
              }
              var orig_data_title = data.title.trim();
              var data_title = orig_data_title.toLowerCase();
              var orig_data_content = data.content.trim().replace(/<[^>]+>/g, "");
              var data_content = orig_data_content.toLowerCase();
              var data_url = data.url;
              var index_title = -1;
              var index_content = -1;
              var first_occur = -1;
              // only match artiles with not empty contents
              if (data_content !== '') {
                keywords.forEach(function (keyword, i) {
                  index_title = data_title.indexOf(keyword);
                  index_content = data_content.indexOf(keyword);

                  if (index_title < 0 && index_content < 0) {
                    isMatch = false;
                  } else {
                    if (index_content < 0) {
                      index_content = 0;
                    }
                    if (i == 0) {
                      first_occur = index_content;
                    }
                    // content_index.push({index_content:index_content, keyword_len:keyword_len});
                  }
                });
              } else {
                isMatch = false;
              }
              // 0x05. show search results
              if (isMatch) {
                str += "<li><a href='/" + data_url + "' class='search-result-title'><h2>" + orig_data_title + "</h2></a>";
                var content = orig_data_content;
                if (first_occur >= 0) {
                  // cut out 100 characters
                  var start = first_occur - 20;
                  var end = first_occur + 80;

                  if (start < 0) {
                    start = 0;
                  }

                  if (start == 0) {
                    end = 100;
                  }

                  if (end > content.length) {
                    end = content.length;
                  }

                  var match_content = content.substr(start, end);

                  // highlight all keywords
                  keywords.forEach(function (keyword) {
                    var regS = new RegExp(keyword, "gi");
                    match_content = match_content.replace(regS, "<span class=\"search-keyword\">" + keyword + "</span>");
                  });

                  str += "<h3 class=\"search-result-abstract\">" + match_content + "...</h3>"
                }
                str += "<hr></li>";
              }
            });
            str += "</ul>";
            if (str.indexOf('<li>') === -1) {
              return $resultContent.innerHTML = "<ul><span class='local-search-empty'>没有找到内容，请尝试更换检索词。<span></ul>";
            }
            $resultContent.innerHTML = str;
          });
        },
        error: function(xhr, status, error) {
          $resultContent.innerHTML = ""
          if (xhr.status === 404) {
            $resultContent.innerHTML = "<ul><span class='local-search-empty'>未找到search.xml文件，具体请参考：<a href='https://github.com/leedom92/hexo-theme-leedom#configuration' target='_black'>configuration</a><span></ul>";
          } else {
            $resultContent.innerHTML = "<ul><span class='local-search-empty'>请求失败，尝试重新刷新页面或稍后重试。<span></ul>";
          }
        }
      });
      $(document).on('click', '#search-close-icon', function() {
        $('#search-input').val('');
        $('#search-result').html('');
      });
    }

    var getSearchFile = function() {
        var path = "/search.xml";
        searchFunc(path, 'search-input', 'search-result');
    }
  </script>




    </div>
  </body>
</html>

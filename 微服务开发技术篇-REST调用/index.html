<!DOCTYPE html>
<html lang="zh-CN">

  <head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="keywords" content="" />
  <meta name="author" content="DeeTam" />
  <meta name="description" content="学然后知不足" />
  
  
  <title>
    
      微服务开发技术篇-REST调用 
      
      
    
  </title>

  
    <link rel="apple-touch-icon" href="/images/favicon.png">
    <link rel="icon" href="/images/favicon.png">
  

  <!-- Raleway-Font -->
  <link href="https://fonts.googleapis.com/css?family=Montserrat|Roboto:400,400italic,600|Roboto+Mono" rel="stylesheet">

  <!-- hexo site css -->
  
<link rel="stylesheet" href="/css/base.css">
<link rel="stylesheet" href="/css/common.css">
<link rel="stylesheet" href="/iconfont/iconfont.css">


  

  
    
<link rel="stylesheet" href="/css/post.css">

  

  <!-- jquery3.3.1 -->
  <script src="https://cdn.bootcss.com/jquery/3.3.1/jquery.min.js"></script>

  <!-- fancybox -->
  <link href="https://cdn.bootcss.com/fancybox/3.5.2/jquery.fancybox.min.css" rel="stylesheet">
  <script async src="https://cdn.bootcss.com/fancybox/3.5.2/jquery.fancybox.min.js"></script>
  
<script src="/js/fancybox.js"></script>


<meta name="generator" content="Hexo 6.3.0"></head>


  <body>
    <div id="app">
      <div class="header">
  <a href="/">DEE TAM</a>
</div>


      <p class="links">
  
    <a title="归档" target="" href="/archives/">
      <i class="iconfont icon-bookmark"></i>
    </a>
  
    <a title="邮箱" target="" href="mailto:oomgomgxx@gmail.com">
      <i class="iconfont icon-envelope"></i>
    </a>
  
    <a title="QQ" target="" href="tencent://message/?Menu=yes&uin=0x1DACE601&Service=300&sigT=45a1e5847943b64c6ff3990f8a9e644d2b31356cb0b4ac6b24663a3c8dd0f8aa12a595b1714f9d45">
      <i class="iconfont icon-qq"></i>
    </a>
  
    <a title="关于" target="" href="/about/">
      <i class="iconfont icon-emoji-friendly"></i>
    </a>
  
</p>


      <div class="main">
        <!-- 文章详情页，展示文章具体内容，url形式：https://yoursite/文章标题/ -->
<!-- 同时为「标签tag」，「朋友friend」，「分类categories」，「关于about」页面的承载页面，具体展示取决于page.type -->

<!-- LaTex Display -->
<script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
<script type="text/javascript" id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js">
</script>
<script>
  MathJax = {
    tex: {
      inlineMath: [['$', '$'], ['\\(', '\\)']]
    }
  };
</script>

<div class="post">
  
  <!--
  
    <h3 class="date">
    Aug 21, 2018
  </h3>
  
  -->

  
  <center>
    <h1>
      微服务开发技术篇-REST调用
    </h1>
  </center>
  

  <div class="content markdown-body">
    <h2 id="内容修订"><a href="#内容修订" class="headerlink" title="内容修订"></a>内容修订</h2><h2 id="常见HTTP客户端工具"><a href="#常见HTTP客户端工具" class="headerlink" title="常见HTTP客户端工具"></a>常见HTTP客户端工具</h2><h3 id="HttpURLConnection"><a href="#HttpURLConnection" class="headerlink" title="HttpURLConnection"></a>HttpURLConnection</h3><blockquote>
<p>HttpURLConnection是JDK内置的HTTP请求工具</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> String <span class="title function_">inputContent</span><span class="params">(HttpURLConnection connection)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">    <span class="type">BufferedInputStream</span> <span class="variable">bis</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BufferedInputStream</span>(connection.getInputStream());</span><br><span class="line">    <span class="type">byte</span>[] buff = <span class="keyword">new</span> <span class="title class_">byte</span>[bis.available()];</span><br><span class="line">    <span class="type">int</span> <span class="variable">len</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">    <span class="type">StringBuilder</span> <span class="variable">sb</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuilder</span>();</span><br><span class="line">    <span class="keyword">while</span> ((len=bis.read(buff)) != -<span class="number">1</span>) &#123;</span><br><span class="line">        sb.append(<span class="keyword">new</span> <span class="title class_">String</span>(buff, <span class="number">0</span>, buff.length));</span><br><span class="line">    &#125;</span><br><span class="line">    bis.close();</span><br><span class="line">    <span class="keyword">return</span> sb.toString();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>DELETE</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@DeleteMapping(&quot;/delete/&#123;id&#125;&quot;)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">testDelete</span><span class="params">(<span class="meta">@PathVariable</span> Long id)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    <span class="comment">// 拼装请求</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">u</span> <span class="operator">=</span> <span class="string">&quot;http://localhost:8080/user/delete/&#123;id&#125;&quot;</span>;</span><br><span class="line">    <span class="type">URL</span> <span class="variable">url</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">URL</span>(u.replace(<span class="string">&quot;&#123;id&#125;&quot;</span>, String.valueOf(id)));</span><br><span class="line">    <span class="type">HttpURLConnection</span> <span class="variable">connection</span> <span class="operator">=</span> (HttpURLConnection)url.openConnection();</span><br><span class="line">    connection.setRequestMethod(<span class="string">&quot;DELETE&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> inputContent(connection);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>GET</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;/get&quot;)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">testGet</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    <span class="comment">// 拼装请求</span></span><br><span class="line">    <span class="type">URL</span> <span class="variable">url</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">URL</span>(<span class="string">&quot;http://localhost:8080/user/find/all&quot;</span>);</span><br><span class="line">    <span class="type">HttpURLConnection</span> <span class="variable">connection</span> <span class="operator">=</span> (HttpURLConnection)url.openConnection();</span><br><span class="line">    connection.setRequestMethod(<span class="string">&quot;GET&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> inputContent(connection);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>POST</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@PostMapping(&quot;/post&quot;)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">testPost</span><span class="params">(User user, HttpServletRequest request)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 拼装请求</span></span><br><span class="line">    <span class="type">URL</span> <span class="variable">url</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">URL</span>(<span class="string">&quot;http://localhost:8080/user/add&quot;</span>);</span><br><span class="line">    <span class="type">HttpURLConnection</span> <span class="variable">connection</span> <span class="operator">=</span> (HttpURLConnection)url.openConnection();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 初始化请求</span></span><br><span class="line">    connection.setRequestMethod(<span class="string">&quot;POST&quot;</span>);</span><br><span class="line">    connection.setDoOutput(<span class="literal">true</span>);</span><br><span class="line">    connection.setRequestProperty(<span class="string">&quot;Charset&quot;</span>, <span class="string">&quot;UTF-8&quot;</span>);</span><br><span class="line">    connection.setRequestProperty(<span class="string">&quot;Content-Type&quot;</span>, <span class="string">&quot;application/x-www-form-urlencoded&quot;</span>);</span><br><span class="line">    <span class="comment">//connection.setRequestProperty(&quot;Connection&quot;, &quot;Keep-Alive&quot;);</span></span><br><span class="line">    <span class="comment">//connection.setRequestProperty(&quot;referer&quot;, &quot;localhost:8080&quot;);</span></span><br><span class="line">    <span class="comment">//connection.setRequestProperty(&quot;user-agent&quot;, &quot;Mozilla/5.0 (Windows NT 6.1; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/78.0.3904.108 Safari/537.36&quot;);</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 拼接提交数据</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">u</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuilder</span>().append(<span class="string">&quot;id=&quot;</span>).append(user.getId()).append(<span class="string">&quot;&amp;&quot;</span>)</span><br><span class="line">        .append(<span class="string">&quot;name=&quot;</span>).append(user.getName()).append(<span class="string">&quot;&amp;&quot;</span>)</span><br><span class="line">        .append(<span class="string">&quot;age=&quot;</span>).append(user.getAge()).toString();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 写入数据</span></span><br><span class="line">    connection.getOutputStream().write(u.getBytes());</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 获取返回内容</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">code</span> <span class="operator">=</span> connection.getResponseCode();</span><br><span class="line">    <span class="keyword">if</span> (code == HttpURLConnection.HTTP_OK) &#123;</span><br><span class="line">        <span class="keyword">return</span> inputContent(connection);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> String.valueOf(code);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Apache-HttpClient"><a href="#Apache-HttpClient" class="headerlink" title="Apache HttpClient"></a>Apache HttpClient</h3><p>依赖</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.httpcomponents<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>httpclient<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.5.10<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>GET</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;/get&quot;)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">testGet</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    <span class="comment">// 拼装请求</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">url</span> <span class="operator">=</span> <span class="string">&quot;http://localhost:8080/user/find/all&quot;</span>;</span><br><span class="line">    <span class="type">HttpClient</span> <span class="variable">httpClient</span> <span class="operator">=</span> HttpClientBuilder.create().build();</span><br><span class="line">    <span class="type">HttpGet</span> <span class="variable">get</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HttpGet</span>(url);</span><br><span class="line">    <span class="type">HttpResponse</span> <span class="variable">response</span> <span class="operator">=</span> httpClient.execute(get);</span><br><span class="line">    <span class="keyword">return</span> EntityUtils.toString(response.getEntity());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>DELETE</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@DeleteMapping(&quot;/delete/&#123;id&#125;&quot;)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">testDelete</span><span class="params">(<span class="meta">@PathVariable</span> Long id)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    <span class="comment">// 拼装请求</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">u</span> <span class="operator">=</span> <span class="string">&quot;http://localhost:8080/user/delete/&#123;id&#125;&quot;</span>;</span><br><span class="line">    <span class="type">HttpClient</span> <span class="variable">httpClient</span> <span class="operator">=</span> HttpClientBuilder.create().build();</span><br><span class="line">    <span class="type">HttpDelete</span> <span class="variable">delete</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HttpDelete</span>(u.replace(<span class="string">&quot;&#123;id&#125;&quot;</span>, String.valueOf(id)));</span><br><span class="line">    <span class="type">HttpResponse</span> <span class="variable">response</span> <span class="operator">=</span> httpClient.execute(delete);</span><br><span class="line">    <span class="keyword">return</span> EntityUtils.toString(response.getEntity());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>POST</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@PostMapping(&quot;/post&quot;)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">testPost</span><span class="params">(User user)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    <span class="comment">// 拼接提交数据</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">u</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuilder</span>().append(<span class="string">&quot;id=&quot;</span>).append(user.getId()).append(<span class="string">&quot;&amp;&quot;</span>)</span><br><span class="line">        .append(<span class="string">&quot;name=&quot;</span>).append(user.getName()).append(<span class="string">&quot;&amp;&quot;</span>)</span><br><span class="line">        .append(<span class="string">&quot;age=&quot;</span>).append(user.getAge()).toString();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 拼装请求</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">url</span> <span class="operator">=</span> <span class="string">&quot;http://localhost:8080/user/add&quot;</span>;</span><br><span class="line">    <span class="type">HttpClient</span> <span class="variable">httpClient</span> <span class="operator">=</span> HttpClientBuilder.create().build();</span><br><span class="line">    </span><br><span class="line">    <span class="type">StringEntity</span> <span class="variable">entity</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringEntity</span>(u);</span><br><span class="line">    entity.setContentEncoding(<span class="string">&quot;UTF-8&quot;</span>);</span><br><span class="line">    entity.setContentType(<span class="string">&quot;application/x-www-form-urlencoded&quot;</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="type">HttpPost</span> <span class="variable">post</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HttpPost</span>(url);</span><br><span class="line">    post.setEntity(entity);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 执行请求</span></span><br><span class="line">    <span class="type">HttpResponse</span> <span class="variable">response</span> <span class="operator">=</span> httpClient.execute(post);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 获取返回内容</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">code</span> <span class="operator">=</span> response.getStatusLine().getStatusCode();</span><br><span class="line">    <span class="keyword">if</span> (code == HttpStatus.SC_OK) &#123;</span><br><span class="line">        <span class="keyword">return</span> EntityUtils.toString(response.getEntity());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> String.valueOf(code);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="OkHttp"><a href="#OkHttp" class="headerlink" title="OkHttp"></a>OkHttp</h3><p>依赖</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- Kotlin开发 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.squareup.okhttp3<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>okhttp<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.2.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>GET</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;/get&quot;)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">testGet</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    <span class="comment">// 拼装请求</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">url</span> <span class="operator">=</span> <span class="string">&quot;http://localhost:8080/user/find/all&quot;</span>;</span><br><span class="line">    <span class="type">OkHttpClient</span> <span class="variable">client</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">OkHttpClient</span>();</span><br><span class="line">    <span class="type">Request</span> <span class="variable">request</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Request</span>.Builder().url(url).build();</span><br><span class="line">    <span class="type">Response</span> <span class="variable">response</span> <span class="operator">=</span> client.newCall(request).execute();</span><br><span class="line">    <span class="keyword">return</span> response.body().string();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>DELETE</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@DeleteMapping(&quot;/delete/&#123;id&#125;&quot;)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">testDelete</span><span class="params">(<span class="meta">@PathVariable</span> Long id)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    <span class="comment">// 拼装请求</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">u</span> <span class="operator">=</span> <span class="string">&quot;http://localhost:8080/user/delete/&#123;id&#125;&quot;</span>;</span><br><span class="line">    <span class="type">OkHttpClient</span> <span class="variable">client</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">OkHttpClient</span>();</span><br><span class="line">    <span class="type">Request</span> <span class="variable">request</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Request</span>.Builder()</span><br><span class="line">        .url(u.replace(<span class="string">&quot;&#123;id&#125;&quot;</span>, String.valueOf(id)))</span><br><span class="line">        .method(<span class="string">&quot;DELETE&quot;</span>, <span class="literal">null</span>)</span><br><span class="line">        .build();</span><br><span class="line">    <span class="type">Response</span> <span class="variable">response</span> <span class="operator">=</span> client.newCall(request).execute();</span><br><span class="line">    <span class="keyword">return</span> response.body().string();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>POST</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@PostMapping(&quot;/post&quot;)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">testPost</span><span class="params">(User user)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    <span class="comment">// 拼接提交数据</span></span><br><span class="line">    <span class="comment">/** 方法1：</span></span><br><span class="line"><span class="comment">        String u = new StringBuilder().append(&quot;id=&quot;).append(user.getId()).append(&quot;&amp;&quot;)</span></span><br><span class="line"><span class="comment">                .append(&quot;name=&quot;).append(user.getName()).append(&quot;&amp;&quot;)</span></span><br><span class="line"><span class="comment">                .append(&quot;age=&quot;).append(user.getAge()).toString();</span></span><br><span class="line"><span class="comment">        RequestBody requestBody = RequestBody.create(u, MediaType.parse(&quot;application/x-www-form-urlencoded&quot;));</span></span><br><span class="line"><span class="comment">        */</span></span><br><span class="line">    <span class="comment">//方法2：</span></span><br><span class="line">    <span class="type">FormBody</span> <span class="variable">formBody</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FormBody</span>.Builder()</span><br><span class="line">        .add(<span class="string">&quot;id&quot;</span>, String.valueOf(user.getId()))</span><br><span class="line">        .add(<span class="string">&quot;name&quot;</span>, user.getName())</span><br><span class="line">        .add(<span class="string">&quot;age&quot;</span>, String.valueOf(user.getAge()))</span><br><span class="line">        .build();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 拼装请求</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">url</span> <span class="operator">=</span> <span class="string">&quot;http://localhost:8080/user/add&quot;</span>;</span><br><span class="line">    <span class="type">OkHttpClient</span> <span class="variable">client</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">OkHttpClient</span>();</span><br><span class="line">    <span class="type">Request</span> <span class="variable">request</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Request</span>.Builder()</span><br><span class="line">        .url(url)</span><br><span class="line">        .method(<span class="string">&quot;POST&quot;</span>, formBody)</span><br><span class="line">        .build();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 发送请求</span></span><br><span class="line">    <span class="type">Response</span> <span class="variable">response</span> <span class="operator">=</span> client.newCall(request).execute();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 获取返回内容</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">code</span> <span class="operator">=</span> response.code();</span><br><span class="line">    <span class="keyword">if</span> (code == <span class="number">200</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> response.body().string();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> String.valueOf(code);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="Spring-RestTemplate"><a href="#Spring-RestTemplate" class="headerlink" title="Spring RestTemplate"></a>Spring RestTemplate</h2><h3 id="基本介绍"><a href="#基本介绍" class="headerlink" title="基本介绍"></a>基本介绍</h3><p>&amp;emsp;&amp;emsp;RestTemplate位于 org.springframework.web 包下，是Spring提供的HTTP请求包装类。默认采用JDK的HttpURLConnection来实现。除了 HttpURLConnection 之外还支持 Netty4、OkHttp 还用 HttpClient。采用那一种实现取决于实现是否存在类路径下。顺序是 HttpClient 、OkHttp 、HttpURLConnection，即如果没有添加 HttpClient 和 OkHttp 的依赖就会采用 HttpURLConnection 来实现。</p>
<h3 id="源码浅析"><a href="#源码浅析" class="headerlink" title="源码浅析"></a>源码浅析</h3><blockquote>
<p>RestTemplate 源码</p>
</blockquote>
<p><img src="/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E5%BC%80%E5%8F%91%E6%8A%80%E6%9C%AF%E7%AF%87-REST%E8%B0%83%E7%94%A8/001.png"></p>
<p>HttpAccessor</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">HttpAccessor</span> &#123;</span><br><span class="line">	<span class="comment">// 默认请求工厂，可以看到是URLConnection</span></span><br><span class="line">	<span class="keyword">private</span> <span class="type">ClientHttpRequestFactory</span> <span class="variable">requestFactory</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SimpleClientHttpRequestFactory</span>();</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setRequestFactory</span><span class="params">(ClientHttpRequestFactory requestFactory)</span> &#123;</span><br><span class="line">		<span class="built_in">this</span>.requestFactory = requestFactory;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> ClientHttpRequestFactory <span class="title function_">getRequestFactory</span><span class="params">()</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="built_in">this</span>.requestFactory;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// 使用HttpRequestFactory返回ClientHttpRequest</span></span><br><span class="line">	<span class="keyword">protected</span> ClientHttpRequest <span class="title function_">createRequest</span><span class="params">(URI url, HttpMethod method)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">		<span class="type">ClientHttpRequest</span> <span class="variable">request</span> <span class="operator">=</span> getRequestFactory().createRequest(url, method);</span><br><span class="line">		<span class="keyword">return</span> request;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>InterceptingHttpAccessor</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">InterceptingHttpAccessor</span> <span class="keyword">extends</span> <span class="title class_">HttpAccessor</span> &#123;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">final</span> List&lt;ClientHttpRequestInterceptor&gt; interceptors = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">	<span class="meta">@Nullable</span></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">volatile</span> ClientHttpRequestFactory interceptingRequestFactory;</span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setInterceptors</span><span class="params">(List&lt;ClientHttpRequestInterceptor&gt; interceptors)</span> &#123;</span><br><span class="line">		<span class="comment">// Take getInterceptors() List as-is when passed in here</span></span><br><span class="line">		<span class="keyword">if</span> (<span class="built_in">this</span>.interceptors != interceptors) &#123;</span><br><span class="line">			<span class="built_in">this</span>.interceptors.clear();</span><br><span class="line">			<span class="built_in">this</span>.interceptors.addAll(interceptors);</span><br><span class="line">			AnnotationAwareOrderComparator.sort(<span class="built_in">this</span>.interceptors);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">public</span> List&lt;ClientHttpRequestInterceptor&gt; <span class="title function_">getInterceptors</span><span class="params">()</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="built_in">this</span>.interceptors;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setRequestFactory</span><span class="params">(ClientHttpRequestFactory requestFactory)</span> &#123;</span><br><span class="line">		<span class="built_in">super</span>.setRequestFactory(requestFactory);</span><br><span class="line">		<span class="built_in">this</span>.interceptingRequestFactory = <span class="literal">null</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="keyword">public</span> ClientHttpRequestFactory <span class="title function_">getRequestFactory</span><span class="params">()</span> &#123;</span><br><span class="line">		List&lt;ClientHttpRequestInterceptor&gt; interceptors = getInterceptors();</span><br><span class="line">		<span class="keyword">if</span> (!CollectionUtils.isEmpty(interceptors)) &#123;</span><br><span class="line">			<span class="comment">// 获取拦截器版请求工厂</span></span><br><span class="line">			<span class="type">ClientHttpRequestFactory</span> <span class="variable">factory</span> <span class="operator">=</span> <span class="built_in">this</span>.interceptingRequestFactory;</span><br><span class="line">			<span class="keyword">if</span> (factory == <span class="literal">null</span>) &#123;</span><br><span class="line">				<span class="comment">// 使用父类的请求工厂（默认URLConnection）和拥有的拦截器创建一个 拦截器版请求工厂</span></span><br><span class="line">				factory = <span class="keyword">new</span> <span class="title class_">InterceptingClientHttpRequestFactory</span>(<span class="built_in">super</span>.getRequestFactory(), interceptors);</span><br><span class="line">				<span class="built_in">this</span>.interceptingRequestFactory = factory;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">return</span> factory;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="built_in">super</span>.getRequestFactory();</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>RestOperations</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">RestOperations</span> &#123;</span><br><span class="line"><span class="comment">// GET</span></span><br><span class="line"><span class="meta">@Nullable</span></span><br><span class="line">&lt;T&gt; T <span class="title function_">getForObject</span><span class="params">(String url, Class&lt;T&gt; responseType, Object... uriVariables)</span> <span class="keyword">throws</span> RestClientException;</span><br><span class="line"><span class="meta">@Nullable</span></span><br><span class="line">&lt;T&gt; T <span class="title function_">getForObject</span><span class="params">(String url, Class&lt;T&gt; responseType, Map&lt;String, ?&gt; uriVariables)</span> <span class="keyword">throws</span> RestClientException;</span><br><span class="line"><span class="meta">@Nullable</span></span><br><span class="line">&lt;T&gt; T <span class="title function_">getForObject</span><span class="params">(URI url, Class&lt;T&gt; responseType)</span> <span class="keyword">throws</span> RestClientException;</span><br><span class="line">&lt;T&gt; ResponseEntity&lt;T&gt; <span class="title function_">getForEntity</span><span class="params">(String url, Class&lt;T&gt; responseType, Object... uriVariables)</span></span><br><span class="line">		<span class="keyword">throws</span> RestClientException;</span><br><span class="line">&lt;T&gt; ResponseEntity&lt;T&gt; <span class="title function_">getForEntity</span><span class="params">(String url, Class&lt;T&gt; responseType, Map&lt;String, ?&gt; uriVariables)</span></span><br><span class="line">		<span class="keyword">throws</span> RestClientException;</span><br><span class="line">&lt;T&gt; ResponseEntity&lt;T&gt; <span class="title function_">getForEntity</span><span class="params">(URI url, Class&lt;T&gt; responseType)</span> <span class="keyword">throws</span> RestClientException;</span><br><span class="line"></span><br><span class="line"><span class="comment">// HEAD</span></span><br><span class="line">HttpHeaders <span class="title function_">headForHeaders</span><span class="params">(String url, Object... uriVariables)</span> <span class="keyword">throws</span> RestClientException;</span><br><span class="line">HttpHeaders <span class="title function_">headForHeaders</span><span class="params">(String url, Map&lt;String, ?&gt; uriVariables)</span> <span class="keyword">throws</span> RestClientException;</span><br><span class="line">HttpHeaders <span class="title function_">headForHeaders</span><span class="params">(URI url)</span> <span class="keyword">throws</span> RestClientException;</span><br><span class="line"></span><br><span class="line"><span class="comment">// POST</span></span><br><span class="line"><span class="meta">@Nullable</span></span><br><span class="line">URI <span class="title function_">postForLocation</span><span class="params">(String url, <span class="meta">@Nullable</span> Object request, Object... uriVariables)</span> <span class="keyword">throws</span> RestClientException;</span><br><span class="line"><span class="meta">@Nullable</span></span><br><span class="line">URI <span class="title function_">postForLocation</span><span class="params">(String url, <span class="meta">@Nullable</span> Object request, Map&lt;String, ?&gt; uriVariables)</span></span><br><span class="line">		<span class="keyword">throws</span> RestClientException;</span><br><span class="line"><span class="meta">@Nullable</span></span><br><span class="line">URI <span class="title function_">postForLocation</span><span class="params">(URI url, <span class="meta">@Nullable</span> Object request)</span> <span class="keyword">throws</span> RestClientException;</span><br><span class="line"><span class="meta">@Nullable</span></span><br><span class="line">&lt;T&gt; T <span class="title function_">postForObject</span><span class="params">(String url, <span class="meta">@Nullable</span> Object request, Class&lt;T&gt; responseType,</span></span><br><span class="line"><span class="params">		Object... uriVariables)</span> <span class="keyword">throws</span> RestClientException;</span><br><span class="line"><span class="meta">@Nullable</span></span><br><span class="line">&lt;T&gt; T <span class="title function_">postForObject</span><span class="params">(String url, <span class="meta">@Nullable</span> Object request, Class&lt;T&gt; responseType,</span></span><br><span class="line"><span class="params">		Map&lt;String, ?&gt; uriVariables)</span> <span class="keyword">throws</span> RestClientException;</span><br><span class="line"><span class="meta">@Nullable</span></span><br><span class="line">&lt;T&gt; T <span class="title function_">postForObject</span><span class="params">(URI url, <span class="meta">@Nullable</span> Object request, Class&lt;T&gt; responseType)</span> <span class="keyword">throws</span> RestClientException;</span><br><span class="line">&lt;T&gt; ResponseEntity&lt;T&gt; <span class="title function_">postForEntity</span><span class="params">(String url, <span class="meta">@Nullable</span> Object request, Class&lt;T&gt; responseType,</span></span><br><span class="line"><span class="params">		Object... uriVariables)</span> <span class="keyword">throws</span> RestClientException;</span><br><span class="line">&lt;T&gt; ResponseEntity&lt;T&gt; <span class="title function_">postForEntity</span><span class="params">(String url, <span class="meta">@Nullable</span> Object request, Class&lt;T&gt; responseType,</span></span><br><span class="line"><span class="params">		Map&lt;String, ?&gt; uriVariables)</span> <span class="keyword">throws</span> RestClientException;</span><br><span class="line">&lt;T&gt; ResponseEntity&lt;T&gt; <span class="title function_">postForEntity</span><span class="params">(URI url, <span class="meta">@Nullable</span> Object request, Class&lt;T&gt; responseType)</span></span><br><span class="line">		<span class="keyword">throws</span> RestClientException;</span><br><span class="line"></span><br><span class="line"><span class="comment">// PUT</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">put</span><span class="params">(String url, <span class="meta">@Nullable</span> Object request, Object... uriVariables)</span> <span class="keyword">throws</span> RestClientException;</span><br><span class="line"><span class="keyword">void</span> <span class="title function_">put</span><span class="params">(String url, <span class="meta">@Nullable</span> Object request, Map&lt;String, ?&gt; uriVariables)</span> <span class="keyword">throws</span> RestClientException;</span><br><span class="line"><span class="keyword">void</span> <span class="title function_">put</span><span class="params">(URI url, <span class="meta">@Nullable</span> Object request)</span> <span class="keyword">throws</span> RestClientException;</span><br><span class="line"></span><br><span class="line"><span class="comment">// PATCH</span></span><br><span class="line"><span class="meta">@Nullable</span></span><br><span class="line">&lt;T&gt; T <span class="title function_">patchForObject</span><span class="params">(String url, <span class="meta">@Nullable</span> Object request, Class&lt;T&gt; responseType, Object... uriVariables)</span></span><br><span class="line">		<span class="keyword">throws</span> RestClientException;</span><br><span class="line"><span class="meta">@Nullable</span></span><br><span class="line">&lt;T&gt; T <span class="title function_">patchForObject</span><span class="params">(String url, <span class="meta">@Nullable</span> Object request, Class&lt;T&gt; responseType,</span></span><br><span class="line"><span class="params">		Map&lt;String, ?&gt; uriVariables)</span> <span class="keyword">throws</span> RestClientException;</span><br><span class="line"><span class="meta">@Nullable</span></span><br><span class="line">&lt;T&gt; T <span class="title function_">patchForObject</span><span class="params">(URI url, <span class="meta">@Nullable</span> Object request, Class&lt;T&gt; responseType)</span></span><br><span class="line">		<span class="keyword">throws</span> RestClientException;</span><br><span class="line"></span><br><span class="line"><span class="comment">// DELETE</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">delete</span><span class="params">(String url, Object... uriVariables)</span> <span class="keyword">throws</span> RestClientException;</span><br><span class="line"><span class="keyword">void</span> <span class="title function_">delete</span><span class="params">(String url, Map&lt;String, ?&gt; uriVariables)</span> <span class="keyword">throws</span> RestClientException;</span><br><span class="line"><span class="keyword">void</span> <span class="title function_">delete</span><span class="params">(URI url)</span> <span class="keyword">throws</span> RestClientException;</span><br><span class="line"></span><br><span class="line"><span class="comment">// OPTIONS</span></span><br><span class="line">Set&lt;HttpMethod&gt; <span class="title function_">optionsForAllow</span><span class="params">(String url, Object... uriVariables)</span> <span class="keyword">throws</span> RestClientException;</span><br><span class="line">Set&lt;HttpMethod&gt; <span class="title function_">optionsForAllow</span><span class="params">(String url, Map&lt;String, ?&gt; uriVariables)</span> <span class="keyword">throws</span> RestClientException;</span><br><span class="line">Set&lt;HttpMethod&gt; <span class="title function_">optionsForAllow</span><span class="params">(URI url)</span> <span class="keyword">throws</span> RestClientException;</span><br><span class="line"></span><br><span class="line"><span class="comment">// exchange</span></span><br><span class="line">&lt;T&gt; ResponseEntity&lt;T&gt; <span class="title function_">exchange</span><span class="params">(String url, HttpMethod method, <span class="meta">@Nullable</span> HttpEntity&lt;?&gt; requestEntity,</span></span><br><span class="line"><span class="params">		Class&lt;T&gt; responseType, Object... uriVariables)</span> <span class="keyword">throws</span> RestClientException;</span><br><span class="line">&lt;T&gt; ResponseEntity&lt;T&gt; <span class="title function_">exchange</span><span class="params">(String url, HttpMethod method, <span class="meta">@Nullable</span> HttpEntity&lt;?&gt; requestEntity,</span></span><br><span class="line"><span class="params">		Class&lt;T&gt; responseType, Map&lt;String, ?&gt; uriVariables)</span> <span class="keyword">throws</span> RestClientException;</span><br><span class="line">&lt;T&gt; ResponseEntity&lt;T&gt; <span class="title function_">exchange</span><span class="params">(URI url, HttpMethod method, <span class="meta">@Nullable</span> HttpEntity&lt;?&gt; requestEntity,</span></span><br><span class="line"><span class="params">		Class&lt;T&gt; responseType)</span> <span class="keyword">throws</span> RestClientException;</span><br><span class="line">&lt;T&gt; ResponseEntity&lt;T&gt; <span class="title function_">exchange</span><span class="params">(String url,HttpMethod method, <span class="meta">@Nullable</span> HttpEntity&lt;?&gt; requestEntity,</span></span><br><span class="line"><span class="params">		ParameterizedTypeReference&lt;T&gt; responseType, Object... uriVariables)</span> <span class="keyword">throws</span> RestClientException;</span><br><span class="line">&lt;T&gt; ResponseEntity&lt;T&gt; <span class="title function_">exchange</span><span class="params">(String url, HttpMethod method, <span class="meta">@Nullable</span> HttpEntity&lt;?&gt; requestEntity,</span></span><br><span class="line"><span class="params">		ParameterizedTypeReference&lt;T&gt; responseType, Map&lt;String, ?&gt; uriVariables)</span> <span class="keyword">throws</span> RestClientException;</span><br><span class="line">&lt;T&gt; ResponseEntity&lt;T&gt; <span class="title function_">exchange</span><span class="params">(URI url, HttpMethod method, <span class="meta">@Nullable</span> HttpEntity&lt;?&gt; requestEntity,</span></span><br><span class="line"><span class="params">		ParameterizedTypeReference&lt;T&gt; responseType)</span> <span class="keyword">throws</span> RestClientException;</span><br><span class="line">&lt;T&gt; ResponseEntity&lt;T&gt; <span class="title function_">exchange</span><span class="params">(RequestEntity&lt;?&gt; requestEntity, Class&lt;T&gt; responseType)</span></span><br><span class="line">		<span class="keyword">throws</span> RestClientException;</span><br><span class="line">&lt;T&gt; ResponseEntity&lt;T&gt; <span class="title function_">exchange</span><span class="params">(RequestEntity&lt;?&gt; requestEntity, ParameterizedTypeReference&lt;T&gt; responseType)</span></span><br><span class="line">		<span class="keyword">throws</span> RestClientException;</span><br><span class="line"></span><br><span class="line"><span class="comment">// General execution</span></span><br><span class="line"><span class="meta">@Nullable</span></span><br><span class="line">&lt;T&gt; T <span class="title function_">execute</span><span class="params">(String url, HttpMethod method, <span class="meta">@Nullable</span> RequestCallback requestCallback,</span></span><br><span class="line"><span class="params">		<span class="meta">@Nullable</span> ResponseExtractor&lt;T&gt; responseExtractor, Object... uriVariables)</span></span><br><span class="line">		<span class="keyword">throws</span> RestClientException;</span><br><span class="line"><span class="meta">@Nullable</span></span><br><span class="line">&lt;T&gt; T <span class="title function_">execute</span><span class="params">(String url, HttpMethod method, <span class="meta">@Nullable</span> RequestCallback requestCallback,</span></span><br><span class="line"><span class="params">		<span class="meta">@Nullable</span> ResponseExtractor&lt;T&gt; responseExtractor, Map&lt;String, ?&gt; uriVariables)</span></span><br><span class="line">		<span class="keyword">throws</span> RestClientException;</span><br><span class="line"><span class="meta">@Nullable</span></span><br><span class="line">&lt;T&gt; T <span class="title function_">execute</span><span class="params">(URI url, HttpMethod method, <span class="meta">@Nullable</span> RequestCallback requestCallback,</span></span><br><span class="line"><span class="params">		<span class="meta">@Nullable</span> ResponseExtractor&lt;T&gt; responseExtractor)</span> <span class="keyword">throws</span> RestClientException;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>如何使用 RestTemplate ？</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> RestTemplateBuilder builder;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="keyword">public</span> RestTemplate <span class="title function_">restTemplate</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> builder.build();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>点进 RestTemplateBuilder</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 构建RestTemplate</span></span><br><span class="line"><span class="keyword">public</span> RestTemplate <span class="title function_">build</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> build(RestTemplate.class);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> &lt;T <span class="keyword">extends</span> <span class="title class_">RestTemplate</span>&gt; T <span class="title function_">build</span><span class="params">(Class&lt;T&gt; restTemplateClass)</span> &#123;</span><br><span class="line">	<span class="comment">// 反射创建RestTemplate实例</span></span><br><span class="line">    <span class="keyword">return</span> configure(BeanUtils.instantiateClass(restTemplateClass));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> &lt;T <span class="keyword">extends</span> <span class="title class_">RestTemplate</span>&gt; T <span class="title function_">configure</span><span class="params">(T restTemplate)</span> &#123;</span><br><span class="line">	<span class="comment">// 设置RestTemplate的请求工厂</span></span><br><span class="line">    configureRequestFactory(restTemplate);</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="keyword">return</span> restTemplate;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">configureRequestFactory</span><span class="params">(RestTemplate restTemplate)</span> &#123;</span><br><span class="line">	<span class="type">ClientHttpRequestFactory</span> <span class="variable">requestFactory</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">	<span class="comment">// 使用构造者中的请求工厂</span></span><br><span class="line">	<span class="keyword">if</span> (<span class="built_in">this</span>.requestFactorySupplier != <span class="literal">null</span>) &#123;</span><br><span class="line">		requestFactory = <span class="built_in">this</span>.requestFactorySupplier.get();</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">this</span>.detectRequestFactory) &#123;</span><br><span class="line">		<span class="comment">// 到类路径中加载</span></span><br><span class="line">		requestFactory = <span class="keyword">new</span> <span class="title class_">ClientHttpRequestFactorySupplier</span>().get();</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>点进 ClientHttpRequestFactorySupplier</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Map&lt;String, String&gt; REQUEST_FACTORY_CANDIDATES;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> &#123;</span><br><span class="line">	<span class="comment">// 使用LinkedHashMap设置加载优先级别</span></span><br><span class="line">	Map&lt;String, String&gt; candidates = <span class="keyword">new</span> <span class="title class_">LinkedHashMap</span>&lt;&gt;();</span><br><span class="line">	candidates.put(<span class="string">&quot;org.apache.http.client.HttpClient&quot;</span>,</span><br><span class="line">			<span class="string">&quot;org.springframework.http.client.HttpComponentsClientHttpRequestFactory&quot;</span>);</span><br><span class="line">	candidates.put(<span class="string">&quot;okhttp3.OkHttpClient&quot;</span>,</span><br><span class="line">			<span class="string">&quot;org.springframework.http.client.OkHttp3ClientHttpRequestFactory&quot;</span>);</span><br><span class="line">	REQUEST_FACTORY_CANDIDATES = Collections.unmodifiableMap(candidates);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> ClientHttpRequestFactory <span class="title function_">get</span><span class="params">()</span> &#123;</span><br><span class="line">	<span class="keyword">for</span> (Map.Entry&lt;String, String&gt; candidate : REQUEST_FACTORY_CANDIDATES</span><br><span class="line">			.entrySet()) &#123;</span><br><span class="line">		<span class="type">ClassLoader</span> <span class="variable">classLoader</span> <span class="operator">=</span> getClass().getClassLoader();</span><br><span class="line">		<span class="keyword">if</span> (ClassUtils.isPresent(candidate.getKey(), classLoader)) &#123;</span><br><span class="line">			Class&lt;?&gt; factoryClass = ClassUtils.resolveClassName(candidate.getValue(),</span><br><span class="line">					classLoader);</span><br><span class="line">			<span class="keyword">return</span> (ClientHttpRequestFactory) BeanUtils</span><br><span class="line">					.instantiateClass(factoryClass);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// 如果类路径中没有HttpClient和OkHttp则使用URLConnection</span></span><br><span class="line">	<span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">SimpleClientHttpRequestFactory</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="OpenFeign"><a href="#OpenFeign" class="headerlink" title="OpenFeign"></a>OpenFeign</h2><h3 id="基本介绍-1"><a href="#基本介绍-1" class="headerlink" title="基本介绍"></a>基本介绍</h3><p>Feign本来是Spring Cloud Netflix开源项目的一部分，后来从项目中独立了出来成为一个通用的Java类库并改名为OpenFeign。</p>
<p>OpenFeign是一个<code>声明式</code>、<code>模板化</code>的HTTP客户端抽象，支持Feign、JAX-RS、SpringMVC 等风格注解，而且内部集成 Ribbon 和 Hystrix。</p>
<p>OpenFeign 和 RestTemplate 一样，默认采用 URLConnection 进行HTTP通信，同时也支持 Apache HttpClient 和 OkHttp。</p>
<blockquote>
<p>OpenFeign 架构图</p>
</blockquote>
<p><img src="/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E5%BC%80%E5%8F%91%E6%8A%80%E6%9C%AF%E7%AF%87-REST%E8%B0%83%E7%94%A8/005.png"></p>
<p>注：使用 OpenFeign 时可以通过实现 RequestInterceptor 接口来自定义拦截器。譬如可用于实现统一请求头设置。</p>
<h3 id="快速入门"><a href="#快速入门" class="headerlink" title="快速入门"></a>快速入门</h3><h4 id="依赖"><a href="#依赖" class="headerlink" title="依赖"></a>依赖</h4><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-parent<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.1.5.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">relativePath</span>/&gt;</span> <span class="comment">&lt;!-- lookup parent from repository --&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">java.version</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">java.version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">spring-cloud.version</span>&gt;</span>Greenwich.SR2<span class="tag">&lt;/<span class="name">spring-cloud.version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">dependencyManagement</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-dependencies<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;spring-cloud.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">type</span>&gt;</span>pom<span class="tag">&lt;/<span class="name">type</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>import<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencyManagement</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-openfeign<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h4 id="服务提供者"><a href="#服务提供者" class="headerlink" title="服务提供者"></a>服务提供者</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequestMapping(&quot;/user&quot;)</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserController</span> &#123; </span><br><span class="line">    <span class="meta">@GetMapping(&quot;/find/all&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> List&lt;User&gt; <span class="title function_">findAll</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">//...</span></span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">  	<span class="meta">@DeleteMapping(&quot;/delete/&#123;id&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> User <span class="title function_">deleteUserById</span><span class="params">(<span class="meta">@PathVariable</span> Long id)</span> &#123;</span><br><span class="line">        <span class="comment">//...</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostMapping(&quot;/add&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> User <span class="title function_">addUser</span><span class="params">(<span class="meta">@RequestBody</span> User user)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">//...</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="服务消费者"><a href="#服务消费者" class="headerlink" title="服务消费者"></a>服务消费者</h4><p>FeignClient定义</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@FeignClient(&quot;MSA-EUREKA-PROVIDER-USER&quot;)</span><span class="comment">// 服务名称</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">UserFeignClient</span> &#123;</span><br><span class="line"></span><br><span class="line">  	<span class="comment">// 注意：在SpringCloud 2.1.x版本，提供了一个叫@SpringQueryMap的注解用于GET方法直接传递对象实例（其实就是转为Map后拼装到成URL参数，从这点不难看出为什么不能用在POST请求）</span></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/user/find/all&quot;)</span></span><br><span class="line">    List <span class="title function_">selectAllUser</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@DeleteMapping(&quot;/user/delete/&#123;id&#125;&quot;)</span></span><br><span class="line">    User <span class="title function_">deleteUserById</span><span class="params">(<span class="meta">@PathVariable</span> Long id)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 多参数提交方法1</span></span><br><span class="line">    <span class="comment">// Feign默认将POJO转为Json并使用Content-Type：application/json进行参数传输，这时服务提供方需要使用@RequestBody来接收</span></span><br><span class="line">    <span class="meta">@PostMapping(&quot;/user/add&quot;)</span></span><br><span class="line">    User <span class="title function_">addUser</span><span class="params">(User user)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 多参数提交方法2</span></span><br><span class="line">    <span class="comment">//@PostMapping(&quot;/user/add&quot;)</span></span><br><span class="line">    <span class="comment">//User addUser(@RequestParam Long id,</span></span><br><span class="line">    <span class="comment">//              @RequestParam String name,</span></span><br><span class="line">    <span class="comment">//              @RequestParam int age);</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 多参数提交方法3</span></span><br><span class="line">    <span class="comment">//@PostMapping(&quot;/user/add&quot;)</span></span><br><span class="line">    <span class="comment">//User addUser(@RequestParam Map&lt;String, Object&gt; user);</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>启用Feign</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@EnableFeignClients</span> <span class="comment">// 开启OpenFeign</span></span><br><span class="line"><span class="meta">@EnableEurekaClient</span></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MsaEurekaComsumerApplication</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line"> SpringApplication.run(MsaEurekaComsumerApplication.class, args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>消费服务</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequestMapping(&quot;/msg&quot;)</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MessageController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> UserFeignClient userFeignClient;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@DeleteMapping(&quot;/delete/&#123;id&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> ResponseEntity <span class="title function_">deleteUserById</span><span class="params">(<span class="meta">@PathVariable</span> Long id)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> ResponseEntity.ok(userFeignClient.deleteUserById(id));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/find/all&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> ResponseEntity <span class="title function_">findAll</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">List</span> <span class="variable">list</span> <span class="operator">=</span> userFeignClient.selectAllUser();</span><br><span class="line">        <span class="keyword">return</span> ResponseEntity.ok(list);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostMapping(&quot;/add&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> ResponseEntity <span class="title function_">addUser</span><span class="params">(User user)</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 多参数提交方法1</span></span><br><span class="line">        <span class="comment">//return ResponseEntity.ok(userFeignClient.addUser(user));</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 多参数提交方法2</span></span><br><span class="line">       <span class="keyword">return</span> ResponseEntity.ok(userFeignClient.addUser(user.getId(), user.getName(), user.getAge()));</span><br><span class="line"></span><br><span class="line">       <span class="comment">// 多参数提交方法3</span></span><br><span class="line"><span class="comment">//        Map&lt;String, Object&gt; map = new HashMap&lt;&gt;();</span></span><br><span class="line"><span class="comment">//        map.put(&quot;id&quot;, user.getId());</span></span><br><span class="line"><span class="comment">//        map.put(&quot;name&quot;, user.getName());</span></span><br><span class="line"><span class="comment">//        map.put(&quot;age&quot;, user.getAge());</span></span><br><span class="line"><span class="comment">//        return ResponseEntity.ok(userFeignClient.addUser3(map));</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="源码浅析-1"><a href="#源码浅析-1" class="headerlink" title="源码浅析"></a>源码浅析</h3><h4 id="请求是如何被封装的？"><a href="#请求是如何被封装的？" class="headerlink" title="请求是如何被封装的？"></a>请求是如何被封装的？</h4><p>案例代码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@FeignClient(&quot;MSA-EUREKA-PROVIDER-USER&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">UserFeignClient</span> &#123;</span><br><span class="line">    <span class="meta">@DeleteMapping(&quot;/user/delete/&#123;id&#125;&quot;)</span></span><br><span class="line">    User <span class="title function_">deleteUserById</span><span class="params">(<span class="meta">@PathVariable</span> Long id)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>触发请求，执行代理 ReflectiveFeign#invoke</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ReflectisveFeign</span> <span class="keyword">extends</span> <span class="title class_">Feign</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">invoke</span><span class="params">(Object proxy, Method method, Object[] args)</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line">        <span class="keyword">return</span> dispatch.get(method).invoke(args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>SynchronousMethodHandler#invoke(argv)</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> RequestTemplate.Factory buildTemplateFromArgs;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Object <span class="title function_">invoke</span><span class="params">(Object[] argv)</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line">    <span class="comment">// 生成请求模板</span></span><br><span class="line">    <span class="type">RequestTemplate</span> <span class="variable">template</span> <span class="operator">=</span> buildTemplateFromArgs.create(argv);</span><br><span class="line">    <span class="type">Retryer</span> <span class="variable">retryer</span> <span class="operator">=</span> <span class="built_in">this</span>.retryer.clone();</span><br><span class="line">    <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> executeAndDecode(template);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (RetryableException e) &#123;</span><br><span class="line">            retryer.continueOrPropagate(e);</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>SynchronousMethodHandler#executeAndDecode(template)</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">Object <span class="title function_">executeAndDecode</span><span class="params">(RequestTemplate template)</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line">	<span class="comment">// 1. 执行拦截器</span></span><br><span class="line">    <span class="type">Request</span> <span class="variable">request</span> <span class="operator">=</span> targetRequest(template);</span><br><span class="line">    <span class="comment">// 2. 发出请求</span></span><br><span class="line">    <span class="type">Response</span> <span class="variable">response</span> <span class="operator">=</span> client.execute(request, options);</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">    <span class="keyword">return</span> response;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>SynchronousMethodHandler#targetRequest(template)</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Request <span class="title function_">targetRequest</span><span class="params">(RequestTemplate template)</span> &#123;</span><br><span class="line">    <span class="keyword">for</span> (RequestInterceptor interceptor : requestInterceptors) &#123;</span><br><span class="line">        interceptor.apply(template);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> target.apply(template);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>默认请求Client：Default#execute</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Response <span class="title function_">execute</span><span class="params">(Request request, Options options)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">    <span class="type">HttpURLConnection</span> <span class="variable">connection</span> <span class="operator">=</span> convertAndSend(request, options);</span><br><span class="line">    <span class="keyword">return</span> convertResponse(connection, request);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Ribbon请求Client：LoadBalancerFeignClient#execute</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Response <span class="title function_">execute</span><span class="params">(Request request, Request.Options options)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="type">URI</span> <span class="variable">asUri</span> <span class="operator">=</span> URI.create(request.url());</span><br><span class="line">        <span class="type">String</span> <span class="variable">clientName</span> <span class="operator">=</span> asUri.getHost();</span><br><span class="line">        <span class="type">URI</span> <span class="variable">uriWithoutHost</span> <span class="operator">=</span> cleanUrl(request.url(), clientName);</span><br><span class="line">        <span class="comment">// 包装成负载均衡格式的请求</span></span><br><span class="line">        FeignLoadBalancer.<span class="type">RibbonRequest</span> <span class="variable">ribbonRequest</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FeignLoadBalancer</span>.RibbonRequest(<span class="built_in">this</span>.delegate, request, uriWithoutHost);</span><br><span class="line">        <span class="type">IClientConfig</span> <span class="variable">requestConfig</span> <span class="operator">=</span> getClientConfig(options, clientName);</span><br><span class="line">        <span class="comment">// 通过负载均衡方式执行请求</span></span><br><span class="line">        <span class="keyword">return</span> lbClient(clientName).executeWithLoadBalancer(ribbonRequest, requestConfig).toResponse();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">catch</span> (ClientException e) &#123;</span><br><span class="line">        <span class="comment">//...</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="如何进行负载均衡请求？"><a href="#如何进行负载均衡请求？" class="headerlink" title="如何进行负载均衡请求？"></a>如何进行负载均衡请求？</h4><p>进入FeignRibbonClientAutoConfiguration</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ...</span></span><br><span class="line"><span class="meta">@Import(&#123; HttpClientFeignLoadBalancedConfiguration.class,</span></span><br><span class="line"><span class="meta">		OkHttpFeignLoadBalancedConfiguration.class,</span></span><br><span class="line"><span class="meta">		DefaultFeignLoadBalancedConfiguration.class &#125;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FeignRibbonClientAutoConfiguration</span> &#123;</span><br></pre></td></tr></table></figure>

<ul>
<li>默认情况下只有 DefaultFeignLoadBalancedConfiguration 满足自动配置的条件</li>
</ul>
<p>进入DefaultFeignLoadBalancedConfiguration</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">DefaultFeignLoadBalancedConfiguration</span> &#123;</span><br><span class="line">    <span class="comment">// 将一个负载均衡Client添加到容器</span></span><br><span class="line">	<span class="meta">@Bean</span></span><br><span class="line">	<span class="meta">@ConditionalOnMissingBean</span></span><br><span class="line">	<span class="keyword">public</span> Client <span class="title function_">feignClient</span><span class="params">(CachingSpringLoadBalancerFactory cachingFactory,</span></span><br><span class="line"><span class="params">			SpringClientFactory clientFactory)</span> &#123;</span><br><span class="line">        <span class="comment">// Client.Default底层用的是HTTPURLConnection</span></span><br><span class="line">        <span class="comment">// 可以看出这里其实用的是策略模式，即为Client添加负载均衡能力</span></span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">LoadBalancerFeignClient</span>(<span class="keyword">new</span> <span class="title class_">Client</span>.Default(<span class="literal">null</span>, <span class="literal">null</span>), cachingFactory,</span><br><span class="line">				clientFactory);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>LoadBalancerFeignClient#execute</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Response <span class="title function_">execute</span><span class="params">(Request request, Request.Options options)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="type">URI</span> <span class="variable">asUri</span> <span class="operator">=</span> URI.create(request.url());</span><br><span class="line">        <span class="type">String</span> <span class="variable">clientName</span> <span class="operator">=</span> asUri.getHost();</span><br><span class="line">        <span class="type">URI</span> <span class="variable">uriWithoutHost</span> <span class="operator">=</span> cleanUrl(request.url(), clientName);</span><br><span class="line">        <span class="comment">// 包装成负载均衡格式的请求</span></span><br><span class="line">        FeignLoadBalancer.<span class="type">RibbonRequest</span> <span class="variable">ribbonRequest</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FeignLoadBalancer</span>.RibbonRequest(<span class="built_in">this</span>.delegate, request, uriWithoutHost);</span><br><span class="line">        <span class="type">IClientConfig</span> <span class="variable">requestConfig</span> <span class="operator">=</span> getClientConfig(options, clientName);</span><br><span class="line">        <span class="comment">// 通过负载均衡方式执行请求</span></span><br><span class="line">        <span class="keyword">return</span> lbClient(clientName).executeWithLoadBalancer(ribbonRequest, requestConfig).toResponse();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">catch</span> (ClientException e) &#123;</span><br><span class="line">        <span class="comment">//...</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>AbstractLoadBalancerAwareClient#executeWithLoadBalancer(request, requestConfig)</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> T <span class="title function_">executeWithLoadBalancer</span><span class="params">(<span class="keyword">final</span> S request, <span class="keyword">final</span> IClientConfig requestConfig)</span> </span><br><span class="line">    <span class="keyword">throws</span> ClientException &#123;</span><br><span class="line">    <span class="comment">// 构建命令（命令模式，将请求封装为命令让其做到可传递和修改）</span></span><br><span class="line">    LoadBalancerCommand&lt;T&gt; command </span><br><span class="line">        = buildLoadBalancerCommand(request, requestConfig);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// 提交请求命令</span></span><br><span class="line">        <span class="comment">// 内部会通过RxJava反应式编程发送和响应请求</span></span><br><span class="line">        <span class="keyword">return</span> command.submit(</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">ServerOperation</span>&lt;T&gt;() &#123;</span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="keyword">public</span> Observable&lt;T&gt; <span class="title function_">call</span><span class="params">(Server server)</span> &#123;</span><br><span class="line">                    <span class="type">URI</span> <span class="variable">finalUri</span> <span class="operator">=</span> reconstructURIWithServer(server, request.getUri());</span><br><span class="line">                    <span class="type">S</span> <span class="variable">requestForServer</span> <span class="operator">=</span> (S) request.replaceUri(finalUri);</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        <span class="comment">// RxJava反应式编程API</span></span><br><span class="line">                        <span class="comment">// 执行请求并返回一个可观察的Observable对象实例</span></span><br><span class="line">                        <span class="keyword">return</span> Observable.just(AbstractLoadBalancerAwareClient.<span class="built_in">this</span>.execute(requestForServer, requestConfig));</span><br><span class="line">                    &#125; </span><br><span class="line">                    <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                        <span class="keyword">return</span> Observable.error(e);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;)</span><br><span class="line">            .toBlocking()</span><br><span class="line">            .single();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        <span class="comment">//...</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> Observable&lt;T&gt; <span class="title function_">submit</span><span class="params">(<span class="keyword">final</span> ServerOperation&lt;T&gt; operation)</span> &#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="type">ExecutionInfoContext</span> <span class="variable">context</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ExecutionInfoContext</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (listenerInvoker != <span class="literal">null</span>) &#123;</span><br><span class="line">        listenerInvoker.onExecutionStart();</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">        </span><br><span class="line">    <span class="comment">// 返回一个包含（已经经过负载均衡）Server的可观察对象Observable</span></span><br><span class="line">    Observable&lt;T&gt; o = (server == <span class="literal">null</span> ? selectServer() : Observable.just(server))</span><br><span class="line">        .concatMap(<span class="keyword">new</span> <span class="title class_">Func1</span>&lt;Server, Observable&lt;T&gt;&gt;() &#123; <span class="comment">// 1. 根据Server返回一个Observable</span></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> Observable&lt;T&gt; <span class="title function_">call</span><span class="params">(Server server)</span> &#123;</span><br><span class="line">                context.setServer(server);</span><br><span class="line">                <span class="comment">// 返回当前Server的状态</span></span><br><span class="line">                <span class="keyword">final</span> <span class="type">ServerStats</span> <span class="variable">stats</span> <span class="operator">=</span> loadBalancerContext.getServerStats(server);</span><br><span class="line"></span><br><span class="line">                Observable&lt;T&gt; o = Observable</span><br><span class="line">                    .just(server)</span><br><span class="line">                    .concatMap(<span class="keyword">new</span> <span class="title class_">Func1</span>&lt;Server, Observable&lt;T&gt;&gt;() &#123; <span class="comment">// 2. 根据Server返回一个Observable</span></span><br><span class="line">                        <span class="meta">@Override</span></span><br><span class="line">                        <span class="keyword">public</span> Observable&lt;T&gt; <span class="title function_">call</span><span class="params">(<span class="keyword">final</span> Server server)</span> &#123;</span><br><span class="line">                            context.incAttemptCount();</span><br><span class="line">                            loadBalancerContext.noteOpenConnection(stats);</span><br><span class="line"></span><br><span class="line">                            <span class="keyword">if</span> (listenerInvoker != <span class="literal">null</span>) &#123;</span><br><span class="line">                                listenerInvoker.onStartWithServer(context.toExecutionInfo());</span><br><span class="line"></span><br><span class="line">                            <span class="keyword">final</span> <span class="type">Stopwatch</span> <span class="variable">tracer</span> <span class="operator">=</span> loadBalancerContext.getExecuteTracer().start();</span><br><span class="line">                            <span class="comment">// 执行请求</span></span><br><span class="line">                            <span class="keyword">return</span> operation.call(server).doOnEach(<span class="keyword">new</span> <span class="title class_">Observer</span>&lt;T&gt;() &#123;</span><br><span class="line">                                <span class="keyword">private</span> T entity;</span><br><span class="line">                                <span class="meta">@Override</span></span><br><span class="line">                                <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onCompleted</span><span class="params">()</span> &#123; <span class="comment">// 数据传输完后回调</span></span><br><span class="line">                                    <span class="comment">//...</span></span><br><span class="line">                                &#125;</span><br><span class="line"></span><br><span class="line">                                <span class="meta">@Override</span></span><br><span class="line">                                <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onError</span><span class="params">(Throwable e)</span> &#123; <span class="comment">// 发生错误时回调</span></span><br><span class="line">                                    <span class="comment">//...</span></span><br><span class="line">                                &#125;</span><br><span class="line"></span><br><span class="line">                                <span class="meta">@Override</span></span><br><span class="line">                                <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onNext</span><span class="params">(T entity)</span> &#123; <span class="comment">// 每次有数据来都会回调</span></span><br><span class="line">                                    <span class="built_in">this</span>.entity = entity;</span><br><span class="line">                                    <span class="keyword">if</span> (listenerInvoker != <span class="literal">null</span>) &#123;</span><br><span class="line">                                        listenerInvoker.onExecutionSuccess(entity, context.toExecutionInfo());</span><br><span class="line">                                    &#125;</span><br><span class="line">                                &#125;                            </span><br><span class="line">                            &#125;);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;);</span><br><span class="line">                <span class="comment">//...</span></span><br><span class="line">                <span class="keyword">return</span> o;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">    <span class="keyword">return</span> <span class="comment">// o.onErrorResumeNext...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>LoadBalancerCommand#selectServer</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> Observable&lt;Server&gt; <span class="title function_">selectServer</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> Observable.create(<span class="keyword">new</span> <span class="title class_">OnSubscribe</span>&lt;Server&gt;() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">call</span><span class="params">(Subscriber&lt;? <span class="built_in">super</span> Server&gt; next)</span> &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">// 返回经过负载均衡后的Server实例</span></span><br><span class="line">                <span class="type">Server</span> <span class="variable">server</span> <span class="operator">=</span> loadBalancerContext.getServerFromLoadBalancer(loadBalancerURI, loadBalancerKey);  </span><br><span class="line">                <span class="comment">// 回调订阅者</span></span><br><span class="line">                next.onNext(server);</span><br><span class="line">                <span class="comment">// 完成操作</span></span><br><span class="line">                next.onCompleted();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                next.onError(e);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>AbstractLoadBalancerAwareClient.this.execute相当于FeignLoadBalancer#execute</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> RibbonResponse <span class="title function_">execute</span><span class="params">(RibbonRequest request, IClientConfig configOverride)</span></span><br><span class="line">    <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">    Request.Options options;</span><br><span class="line">    <span class="keyword">if</span> (configOverride != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="type">RibbonProperties</span> <span class="variable">override</span> <span class="operator">=</span> RibbonProperties.from(configOverride);</span><br><span class="line">        options = <span class="keyword">new</span> <span class="title class_">Request</span>.Options(override.connectTimeout(<span class="built_in">this</span>.connectTimeout),</span><br><span class="line">                                      override.readTimeout(<span class="built_in">this</span>.readTimeout));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        options = <span class="keyword">new</span> <span class="title class_">Request</span>.Options(<span class="built_in">this</span>.connectTimeout, <span class="built_in">this</span>.readTimeout);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 发出请求</span></span><br><span class="line">    <span class="type">Response</span> <span class="variable">response</span> <span class="operator">=</span> request.client().execute(request.toRequest(), options);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">RibbonResponse</span>(request.getUri(), response);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="其他配置"><a href="#其他配置" class="headerlink" title="其他配置"></a>其他配置</h3><h4 id="全局配置和局部配置"><a href="#全局配置和局部配置" class="headerlink" title="全局配置和局部配置"></a>全局配置和局部配置</h4><p>全局和局部配置是父子配置关系，优先局部配置</p>
<blockquote>
<p>全局配置</p>
</blockquote>
<p>注解方式</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@EnableFeignClients(defaultConfiguration = xxx.class)</span></span><br></pre></td></tr></table></figure>

<p>配置文件方式</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">feign:</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="attr">default-config:</span> <span class="comment"># 默认配置</span></span><br><span class="line">      <span class="attr">connectionTimeout:</span> <span class="number">5000</span></span><br><span class="line">      <span class="attr">readTimeout:</span> <span class="number">5000</span></span><br><span class="line">      <span class="attr">loggerLevel:</span> <span class="string">FULL</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>局部配置</p>
</blockquote>
<p>注解方式</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">@FeignClient(value = &quot;服务的名字&quot;, configuration = xxx.class)</span></span><br></pre></td></tr></table></figure>

<p>配置文件方式</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">feign:</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="string">服务的名字:</span> </span><br><span class="line">      <span class="attr">connectionTimeout:</span> <span class="number">5000</span></span><br><span class="line">      <span class="attr">readTimeout:</span> <span class="number">5000</span></span><br><span class="line">      <span class="attr">loggerLevel:</span> <span class="string">FULL</span></span><br><span class="line">      <span class="attr">retryer:</span> <span class="string">xxx.xxx.XxxRetryer</span></span><br><span class="line">      <span class="attr">requestInterceptors:</span> </span><br><span class="line">      	<span class="bullet">-</span> <span class="string">xxx.xxx.Xxx</span></span><br><span class="line">      	<span class="bullet">-</span> <span class="string">xxx.xxx.Xxx2</span></span><br></pre></td></tr></table></figure>

<h4 id="开启请求解压缩"><a href="#开启请求解压缩" class="headerlink" title="开启请求解压缩"></a>开启请求解压缩</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">feign:</span></span><br><span class="line">  <span class="attr">compression:</span></span><br><span class="line">    <span class="attr">response:</span></span><br><span class="line">      <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">request:</span></span><br><span class="line">      <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">      <span class="comment"># 针对以下媒体类型</span></span><br><span class="line">      <span class="attr">mime-types:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">text/html</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">application/json</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">multipart/form-data</span></span><br><span class="line">      <span class="attr">min-request-size:</span> <span class="number">2048</span></span><br></pre></td></tr></table></figure>

<h4 id="设置日志等级"><a href="#设置日志等级" class="headerlink" title="设置日志等级"></a>设置日志等级</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">Object <span class="title function_">executeAndDecode</span><span class="params">(RequestTemplate template)</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line">    <span class="keyword">if</span> (logLevel != Logger.Level.NONE) &#123;</span><br><span class="line">        logger.logRequest(metadata.configKey(), logLevel, request);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        response = client.execute(request, options);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">        <span class="keyword">if</span> (logLevel != Logger.Level.NONE) &#123;</span><br><span class="line">            logger.logIOException(metadata.configKey(), logLevel, e, elapsedTime(start));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">long</span> <span class="variable">elapsedTime</span> <span class="operator">=</span> TimeUnit.NANOSECONDS.toMillis(System.nanoTime() - start);</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (logLevel != Logger.Level.NONE) &#123;</span><br><span class="line">            response =</span><br><span class="line">                logger.logAndRebufferResponse(metadata.configKey(), logLevel, response, elapsedTime);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">    &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">        <span class="keyword">if</span> (logLevel != Logger.Level.NONE) &#123;</span><br><span class="line">            logger.logIOException(metadata.configKey(), logLevel, e, elapsedTime);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="comment">//...</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>以上是 SynchronousMethodHandler 的一段代码，可以看到在 Feign 中采用了<code>功能开关</code>方式来控制日志的输出</li>
<li>虽然Feign只输出DEBUG级别的日志，但也可通过调节日志模式（Level）来获取特定格式日志内容：<ul>
<li>NONE：<strong>不记录</strong>任何日志（默认级别）</li>
<li>BASIC：记录<strong>请求方法</strong>、<strong>URL</strong>、<strong>响应状态码</strong>以及<strong>执行的时间</strong></li>
<li>HEADERS：BASIC + header 信息</li>
<li>FULL：记录<strong>请求</strong>和<strong>响应</strong>的所有信息</li>
</ul>
</li>
</ul>
<p>配置案例如下：</p>
<ol>
<li>替换默认的Level实例</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FeignLogConfig</span> &#123;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> Logger.Level <span class="title function_">loggerLevel</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> Logger.Level.HEADERS;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>将配置应用到全局或局部</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@FeignClient(value = &quot;MSA-EUREKA-PROVIDER-USER&quot;, configuration = RestConfig.class)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">UserFeignClient</span> &#123;</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>将FeignClient接口的日志级别设置为DEBUG</li>
</ol>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">logging:</span></span><br><span class="line">  <span class="attr">level:</span></span><br><span class="line">    <span class="attr">root:</span> <span class="string">info</span></span><br><span class="line">    <span class="attr">wiki.td.msaeurekacomsumer01.feign.UserFeignClient:</span> <span class="string">debug</span></span><br></pre></td></tr></table></figure>

<h4 id="文件上传"><a href="#文件上传" class="headerlink" title="文件上传"></a>文件上传</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@FeignClient(value = &quot;MSA-EUREKA-PROVIDER-USER&quot;, </span></span><br><span class="line"><span class="meta">        configuration =UserFeignClient.MultipartSupportConfig.class)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">UserFeignClient</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostMapping(value = &quot;/upload&quot;, consumes = MediaType.MULTIPART_FORM_DATA_VALUE)</span></span><br><span class="line">    String <span class="title function_">upload</span><span class="params">(<span class="meta">@RequestPart(&quot;file&quot;)</span> MultipartFile file)</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">class</span> <span class="title class_">MultipartSupportConfig</span> &#123;</span><br><span class="line">        <span class="meta">@Bean</span></span><br><span class="line">        <span class="keyword">public</span> Encoder <span class="title function_">encoder</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">SpringFormEncoder</span>();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="Ribbon配置"><a href="#Ribbon配置" class="headerlink" title="Ribbon配置"></a>Ribbon配置</h4><p>因为Feign默认集成了Ribbon，所以可以直接使用Ribbon的相关属性配置。</p>
<p>但Feign也提供了局部配置Ribbon的方法，如下：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">feign:</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="string">服务的名字:</span></span><br><span class="line">      <span class="attr">ribbo.connectionTimeout:</span> <span class="number">5000</span></span><br><span class="line">      <span class="attr">ribbo.readTimeout:</span> <span class="number">5000</span></span><br></pre></td></tr></table></figure>

<h4 id="启用Apache-HttpClient或OkHttp"><a href="#启用Apache-HttpClient或OkHttp" class="headerlink" title="启用Apache HttpClient或OkHttp"></a>启用Apache HttpClient或OkHttp</h4><p>添加依赖</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.squareup.okhttp3<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>okhttp<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.2.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>添加配置</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">feign:</span></span><br><span class="line">  <span class="attr">okhttp:</span></span><br><span class="line">    <span class="attr">enabled:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure>



<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><ul>
<li><a target="_blank" rel="noopener" href="https://square.github.io/okhttp/">OkHttp</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/OpenFeign/feign">OpenFeign</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/spring-cloud/spring-cloud-netflix/issues/1253">Suggest supporting POJO as request parameter #1253</a></li>
<li><a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/49823158/differences-between-netflix-feign-openfeign">Differences between netflix.feign &amp; openfeign</a></li>
<li>《SpringCloud与Docker 微服务架构实战》</li>
</ul>

  </div>
  
    
      <a id="older" class="blog-nav" href="/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E5%BC%80%E5%8F%91%E6%8A%80%E6%9C%AF%E7%AF%87-%E5%AE%A2%E6%88%B7%E7%AB%AF%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1/">OLDER&nbsp;&gt;</a>
      
        
          <a id="newer" class="blog-nav" href="/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E5%BC%80%E5%8F%91%E6%8A%80%E6%9C%AF%E7%AF%87-%E6%9C%8D%E5%8A%A1%E5%AE%B9%E9%94%99/">&lt;&nbsp;NEWER</a>
          
            
</div>
        <div class="footer">
  
    <div class="footer-more">
      
        <a href="/"><em style="color:red;">新站点正在开发中，网站暂停更新。</em></a>
        
    </div>
  
    <div class="footer-more">
      
        <a href="/">Copyright © DeeTam 2022</a>
        
    </div>
  
</div>

      </div>

      <div class="back-to-top hidden">
  <a href="javascript: void(0)">
    <i class="iconfont icon-chevronup"></i>
  </a>
</div>


<script src="/js/backtotop.js"></script>



      
  <div class="search-icon" id="search-icon">
    <a href="javascript: void(0)">
      <i class="iconfont icon-search"></i>
    </a>
  </div>

  <div class="search-overlay hidden">
    <div class="search-content" tabindex="0">
      <div class="search-box">
        <div class="search-title">
          <!-- <span class="search-icon-input">
            <a href="javascript: void(0)">
              <i class="iconfont icon-search"></i>
            </a>
          </span> -->
          
            <input type="text" class="search-input" id="search-input" placeholder="搜索...">
          
          <span class="search-close-icon" id="search-close-icon">
            <a href="javascript: void(0)">
              <i class="iconfont icon-close"></i>
            </a>
          </span>
        </div>
        <div class="search-result" id="search-result"></div>
      </div>
    </div>
  </div>

  <script type="text/javascript">
    var inputArea = document.querySelector("#search-input")
    var searchOverlayArea = document.querySelector(".search-overlay")

    // inputArea.onclick = function() {
    //   getSearchFile()
    //   this.onclick = null
    // }

    inputArea.onkeydown = function() {
      if(event.keyCode == 13)
        return false
    }

    function openOrHideSearchContent() {
      let isHidden = searchOverlayArea.classList.contains('hidden')
      if (isHidden) {
        searchOverlayArea.classList.remove('hidden')
        document.body.classList.add('hidden')
        inputArea.focus()
        getSearchFile()
      } else {
        searchOverlayArea.classList.add('hidden')
        document.body.classList.remove('hidden')
      }
    }

    function blurSearchContent(e) {
      if (e.target === searchOverlayArea) {
        openOrHideSearchContent()
      }
    }

    document.querySelector("#search-icon").addEventListener("click", openOrHideSearchContent, false)
    document.querySelector("#search-close-icon").addEventListener("click", openOrHideSearchContent, false)
    searchOverlayArea.addEventListener("click", blurSearchContent, false)

    var searchFunc = function (path, search_id, content_id) {
      'use strict';
      var $input = document.getElementById(search_id);
      var $resultContent = document.getElementById(content_id);
      $resultContent.innerHTML = "<ul><span class='local-search-empty'><span></ul>";
      // $resultContent.innerHTML = "<ul><span class='local-search-empty'>首次搜索，正在载入索引文件，请稍后……<span></ul>";
      $.ajax({
        // 0x01. load xml file
        url: path,
        dataType: "xml",
        success: function (xmlResponse) {
          // 0x02. parse xml file
          var datas = $("entry", xmlResponse).map(function () {
            return {
              title: $("title", this).text(),
              content: $("content", this).text(),
              url: $("url", this).text()
            };
          }).get();
          $resultContent.innerHTML = "";

          $input.addEventListener('input', function () {
            // 0x03. parse query to keywords list
            var str = '<ul class=\"search-result-list\">';
            var keywords = this.value.trim().toLowerCase().split(/[\s\-]+/);
            $resultContent.innerHTML = "";
            if (this.value.trim().length <= 0) {
              return;
            }
            // 0x04. perform local searching
            datas.forEach(function (data) {
              var isMatch = true;
              var content_index = [];
              if (!data.title || data.title.trim() === '') {
                data.title = "Untitled";
              }
              var orig_data_title = data.title.trim();
              var data_title = orig_data_title.toLowerCase();
              var orig_data_content = data.content.trim().replace(/<[^>]+>/g, "");
              var data_content = orig_data_content.toLowerCase();
              var data_url = data.url;
              var index_title = -1;
              var index_content = -1;
              var first_occur = -1;
              // only match artiles with not empty contents
              if (data_content !== '') {
                keywords.forEach(function (keyword, i) {
                  index_title = data_title.indexOf(keyword);
                  index_content = data_content.indexOf(keyword);

                  if (index_title < 0 && index_content < 0) {
                    isMatch = false;
                  } else {
                    if (index_content < 0) {
                      index_content = 0;
                    }
                    if (i == 0) {
                      first_occur = index_content;
                    }
                    // content_index.push({index_content:index_content, keyword_len:keyword_len});
                  }
                });
              } else {
                isMatch = false;
              }
              // 0x05. show search results
              if (isMatch) {
                str += "<li><a href='/" + data_url + "' class='search-result-title'><h2>" + orig_data_title + "</h2></a>";
                var content = orig_data_content;
                if (first_occur >= 0) {
                  // cut out 100 characters
                  var start = first_occur - 20;
                  var end = first_occur + 80;

                  if (start < 0) {
                    start = 0;
                  }

                  if (start == 0) {
                    end = 100;
                  }

                  if (end > content.length) {
                    end = content.length;
                  }

                  var match_content = content.substr(start, end);

                  // highlight all keywords
                  keywords.forEach(function (keyword) {
                    var regS = new RegExp(keyword, "gi");
                    match_content = match_content.replace(regS, "<span class=\"search-keyword\">" + keyword + "</span>");
                  });

                  str += "<h3 class=\"search-result-abstract\">" + match_content + "...</h3>"
                }
                str += "<hr></li>";
              }
            });
            str += "</ul>";
            if (str.indexOf('<li>') === -1) {
              return $resultContent.innerHTML = "<ul><span class='local-search-empty'>没有找到内容，请尝试更换检索词。<span></ul>";
            }
            $resultContent.innerHTML = str;
          });
        },
        error: function(xhr, status, error) {
          $resultContent.innerHTML = ""
          if (xhr.status === 404) {
            $resultContent.innerHTML = "<ul><span class='local-search-empty'>未找到search.xml文件，具体请参考：<a href='https://github.com/leedom92/hexo-theme-leedom#configuration' target='_black'>configuration</a><span></ul>";
          } else {
            $resultContent.innerHTML = "<ul><span class='local-search-empty'>请求失败，尝试重新刷新页面或稍后重试。<span></ul>";
          }
        }
      });
      $(document).on('click', '#search-close-icon', function() {
        $('#search-input').val('');
        $('#search-result').html('');
      });
    }

    var getSearchFile = function() {
        var path = "/search.xml";
        searchFunc(path, 'search-input', 'search-result');
    }
  </script>




    </div>
  </body>
</html>
